<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MarketOS Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; color: #0f172a; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @media print { body * { visibility: hidden; } #printable-label, #printable-label * { visibility: visible; } #printable-label { position: absolute; left: 0; top: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="printable-area" class="hidden"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // FIX: Aggiunto className ai parametri per evitare ReferenceError
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Barcode: <path d="M3 5v14M8 5v14M12 5v14M17 5v14M21 5v14" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>,
                ShoppingCart: <path d="M9 20a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm7 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-7-16L4 4 2 2M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Box: <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                TrendingUp: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><polyline points="17 6 23 6 23 12" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Trash: <><polyline points="3 6 5 6 21 6" fill="none" stroke="currentColor" strokeWidth="2"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" strokeWidth="2"/></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" strokeWidth="2"/><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2"/></>,
                Minus: <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2"/>,
                Check: <polyline points="20 6 9 17 4 12" fill="none" stroke="currentColor" strokeWidth="2"/>,
                Search: <><circle cx="11" cy="11" r="8" fill="none" stroke="currentColor" strokeWidth="2"/><line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" strokeWidth="2"/></>,
                Settings: <><circle cx="12" cy="12" r="3" stroke="currentColor" strokeWidth="2"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" stroke="currentColor" strokeWidth="2"/></>,
                Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Scale: <><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M7 21h10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 3v18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Printer: <><polyline points="6 9 6 2 18 2 18 9" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><rect x="6" y="14" width="12" height="8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Tag: <><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><line x1="7" y1="7" x2="7.01" y2="7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                X: <><line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></>,
                Server: <><rect x="2" y="2" width="20" height="8" rx="2" ry="2" stroke="currentColor" strokeWidth="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2" stroke="currentColor" strokeWidth="2"/><line x1="6" y1="6" x2="6.01" y2="6" stroke="currentColor" strokeWidth="2"/><line x1="6" y1="18" x2="6.01" y2="18" stroke="currentColor" strokeWidth="2"/></>,
                Cloud: <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                CloudOff: <><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>
            };
            return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className}>{icons[name]}</svg>;
        };

        const Modal = ({ title, onClose, children }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                    <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <h3 className="font-bold text-lg text-slate-800">{title}</h3>
                        <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-500"><Icon name="X" size={20}/></button>
                    </div>
                    <div className="p-6 overflow-y-auto flex-1">{children}</div>
                </div>
            </div>
        );

        // --- ADAPTER DATI ---
        const DataAdapter = {
            async getProducts(config) {
                const baseUrl = config.serverUrl || 'http://127.0.0.1:5500'; 
                if (config.storageMode === 'server') {
                    const res = await fetch(`${baseUrl}/api/products`);
                    return await res.json();
                }
                return JSON.parse(localStorage.getItem('products')) || [];
            },
            async saveProduct(config, product) {
                const baseUrl = config.serverUrl || 'http://127.0.0.1:5500';
                if (config.storageMode === 'server') {
                    await fetch(`${baseUrl}/api/products`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(product)
                    });
                }
            },
            async deleteProduct(config, code) {
                const baseUrl = config.serverUrl || 'http://127.0.0.1:5500';
                if (config.storageMode === 'server') {
                    await fetch(`${baseUrl}/api/products/${code}`, { method: 'DELETE' });
                }
            },
            async saveLog(config, log) {
                const baseUrl = config.serverUrl || 'http://127.0.0.1:5500';
                if (config.storageMode === 'server') {
                    await fetch(`${baseUrl}/api/logs`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(log)
                    });
                }
            }
        };

        // --- STAMPA ETICHETTA ---
        const printLabel = (product) => {
            const printArea = document.getElementById('printable-area');
            
            printArea.innerHTML = `
                <div id="printable-label" style="text-align: center; font-family: monospace; width: 300px; padding: 20px; border: 1px dashed black;">
                    <h2 style="margin: 0; font-size: 18px;">${product.name}</h2>
                    <p style="margin: 5px 0;">Cod: ${product.code}</p>
                    <svg id="barcode-render"></svg>
                    <h1 style="margin: 10px 0; font-size: 32px;">€ ${parseFloat(product.price).toFixed(2)}</h1>
                    <p style="font-size: 10px;">${product.isWeighable ? 'ARTICOLO A PESO (Prezzo al Kg)' : 'PREZZO CAD.'}</p>
                </div>
            `;
            
            try {
                JsBarcode("#barcode-render", product.code, {
                    format: "CODE128",
                    height: 50,
                    displayValue: false
                });
                window.print();
            } catch (e) { alert("Errore generazione barcode: " + e.message); }
        };

        const App = () => {
            const [view, setView] = useState('pos'); 
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState([]);
            const [logs, setLogs] = useState([]);
            // DEFAULT CONFIG: SERVER ON (Porta 5500)
            const [config, setConfig] = useState(() => JSON.parse(localStorage.getItem('config')) || { 
                shopName: "MarketOS", 
                tax: 22, 
                adminPass: "1234", 
                storageMode: 'local', // Default LOCAL per evitare errori se server spento
                serverUrl: 'http://127.0.0.1:5500' 
            });
            const [showLogin, setShowLogin] = useState(false);
            const [serverStatus, setServerStatus] = useState('checking');

            // Initial Load
            useEffect(() => {
                const loadData = async () => {
                    try {
                        if (config.storageMode === 'server') {
                            const prods = await DataAdapter.getProducts(config);
                            setProducts(prods);
                            setServerStatus('online');
                        } else {
                            setProducts(JSON.parse(localStorage.getItem('products')) || []);
                        }
                    } catch (e) {
                        console.error(e);
                        setServerStatus('offline');
                        // Fallback locale
                        setProducts(JSON.parse(localStorage.getItem('products')) || []);
                    }
                };
                loadData();
                localStorage.setItem('config', JSON.stringify(config));
            }, [config.storageMode, config.serverUrl]);

            // --- AZIONI ---
            const updateProduct = async (p) => {
                setProducts(products.map(pr => pr.code === p.code ? p : pr));
                await DataAdapter.saveProduct(config, p);
            };
            
            const createProduct = async (p) => {
                if (products.some(x => x.code === p.code)) return false;
                const newProd = { ...p, stock: parseFloat(p.stock), price: parseFloat(p.price) };
                setProducts([...products, newProd]);
                await DataAdapter.saveProduct(config, newProd);
                return true;
            };
            
            const deleteProduct = async (code) => {
                if(confirm("Eliminare?")) {
                    setProducts(products.filter(p => p.code !== code));
                    await DataAdapter.deleteProduct(config, code);
                }
            };

            const checkout = async () => {
                if(cart.length === 0) return;
                
                // Aggiorna Stock
                const newProds = products.map(p => {
                    const c = cart.find(x => x.code === p.code);
                    return c ? { ...p, stock: p.stock - c.qty } : p;
                });
                
                const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
                const log = { id: Date.now(), date: new Date().toISOString(), total, items: cart, type: 'sale' };
                
                // Save Sync
                setProducts(newProds);
                setLogs([log, ...logs]);
                
                // Save Persistence
                if (config.storageMode === 'local') {
                    localStorage.setItem('products', JSON.stringify(newProds));
                    localStorage.setItem('logs', JSON.stringify([log, ...logs]));
                } else {
                    newProds.forEach(p => {
                        if (cart.find(c => c.code === p.code)) DataAdapter.saveProduct(config, p);
                    });
                    await DataAdapter.saveLog(config, log);
                }

                setCart([]);
                alert(`Vendita registrata: €${total.toFixed(2)}`);
            };

            const addToCart = (code) => {
                const p = products.find(x => x.code === code);
                if (!p) return false;
                const exist = cart.find(x => x.code === code);
                if (exist) setCart(cart.map(x => x.code === code ? { ...x, qty: x.qty + 1 } : x));
                else setCart([...cart, { ...p, qty: 1 }]);
                return true;
            };

            return (
                <div className="flex h-screen bg-slate-100 font-sans text-slate-800">
                    <div className="w-20 bg-slate-900 flex flex-col items-center py-6 gap-2 shadow-xl z-20 shrink-0">
                        <div className="text-white font-black text-xl mb-6 tracking-tighter">MK</div>
                        <NavBtn icon="ShoppingCart" active={view === 'pos'} onClick={() => setView('pos')} label="Cassa" />
                        <NavBtn icon="Box" active={view === 'inventory'} onClick={() => setView('inventory')} label="Prodotti" />
                        <NavBtn icon="TrendingUp" active={view === 'dashboard'} onClick={() => setView('dashboard')} label="Report" />
                        <div className="mt-auto">
                            <NavBtn icon="Settings" active={view === 'settings'} onClick={() => setShowLogin(true)} label="Admin" color="text-slate-400" />
                        </div>
                    </div>

                    <div className="flex-1 overflow-hidden flex flex-col">
                        {view === 'pos' && <POSView products={products} cart={cart} setCart={setCart} onAddToCart={addToCart} onCheckout={checkout} />}
                        {view === 'inventory' && <InventoryView products={products} onUpdate={updateProduct} onCreate={createProduct} onDelete={deleteProduct} />}
                        {view === 'dashboard' && <div className="p-10 text-center text-slate-400">Log Vendite (Vedi versioni precedenti per dettagli)</div>}
                        {view === 'settings' && <SettingsView config={config} setConfig={setConfig} serverStatus={serverStatus} />}
                    </div>

                    {showLogin && <LoginModal password={config.adminPass} onSuccess={() => { setShowLogin(false); setView('settings'); }} onClose={() => setShowLogin(false)} />}
                </div>
            );
        };

        // --- VISTE ---
        const POSView = ({ products, cart, setCart, onCheckout }) => {
            const [input, setInput] = useState("");
            const [searchMode, setSearchMode] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            const [weightItem, setWeightItem] = useState(null); // Item che richiede peso
            const [weightInput, setWeightInput] = useState("");
            
            const inputRef = useRef(null);
            
            useEffect(() => { if (!weightItem && !searchMode) inputRef.current?.focus(); }, [cart, weightItem, searchMode]);

            // Gestione scansione barcode
            const handleScan = (e) => {
                if (e.key === 'Enter') {
                    if(!input.trim()) return;
                    processItemAdd(input);
                    setInput("");
                }
            };

            // Logica centrale aggiunta articolo
            const processItemAdd = (code) => {
                const product = products.find(p => p.code === code);
                if (!product) return alert("Prodotto non trovato!");

                // SE È A PESO (Frutta/Verdura) -> Apri Modal Peso
                if (product.isWeighable) {
                    setWeightItem(product);
                    setWeightInput("");
                    return;
                }

                // ALTRIMENTI -> Aggiungi 1 pezzo
                addItemToCart(product, 1);
            };

            const addItemToCart = (product, quantity) => {
                const exist = cart.find(x => x.code === product.code);
                if (exist) {
                    setCart(cart.map(x => x.code === product.code ? { ...x, qty: x.qty + quantity } : x));
                } else {
                    setCart([...cart, { ...product, qty: quantity }]);
                }
            };

            const handleWeightConfirm = (e) => {
                if (e.key === 'Enter' || e.type === 'click') {
                    const weight = parseFloat(weightInput.replace(',', '.'));
                    if (!weight || weight <= 0) return alert("Peso non valido");
                    
                    addItemToCart(weightItem, weight);
                    setWeightItem(null);
                    setSearchMode(false); // Chiudi anche la ricerca se aperta
                }
            };

            const total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            const filteredProducts = products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="flex h-full p-4 gap-4 relative">
                    {/* SINISTRA: Input & Lista */}
                    <div className="flex-1 flex flex-col gap-4">
                        <div className="flex gap-2">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex items-center gap-4 flex-1">
                                <Icon name="Barcode" className="text-slate-400"/>
                                <input ref={inputRef} type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={handleScan} className="flex-1 text-2xl font-mono outline-none" placeholder="Spara barcode..." />
                            </div>
                            <button onClick={() => { setSearchMode(!searchMode); setSearchTerm(""); }} className={`px-6 rounded-2xl font-bold border transition-all flex items-center gap-2 ${searchMode ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>
                                <Icon name="Search" /> {searchMode ? 'Chiudi' : 'Cerca'}
                            </button>
                        </div>

                        {/* Search Overlay */}
                        {searchMode && (
                            <div className="bg-white rounded-2xl shadow-lg border border-blue-100 flex flex-col h-64 animate-in fade-in absolute top-24 left-4 right-96 z-10">
                                <div className="p-3 border-b border-slate-100 flex gap-2">
                                    <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full outline-none font-bold text-lg" placeholder="Scrivi nome prodotto (es. Mele)..." autoFocus />
                                </div>
                                <div className="overflow-y-auto p-2">
                                    {filteredProducts.map(p => (
                                        <button key={p.code} onClick={() => processItemAdd(p.code)} className="w-full text-left p-3 hover:bg-blue-50 rounded-xl flex justify-between items-center group">
                                            <div>
                                                <div className="font-bold text-slate-700">{p.name}</div>
                                                <div className="text-xs text-slate-400">{p.code}</div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                {p.isWeighable && <span className="text-[10px] bg-orange-100 text-orange-600 px-2 py-1 rounded font-bold flex items-center gap-1"><Icon name="Scale" size={12}/> A PESO</span>}
                                                <span className="font-mono font-bold">€{parseFloat(p.price).toFixed(2)}</span>
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                            <div className="bg-slate-50 p-3 text-xs font-bold text-slate-500 uppercase flex justify-between"><span>Articolo</span><span>Totale</span></div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                {cart.map(item => (
                                    <div key={item.code} className="flex items-center justify-between p-3 bg-white border border-slate-100 rounded-xl">
                                        <div className="flex-1">
                                            <div className="font-bold">{item.name}</div>
                                            <div className="text-xs text-slate-400 flex items-center gap-2">
                                                {item.code}
                                                {item.isWeighable && <span className="bg-orange-100 text-orange-600 px-1 rounded flex items-center gap-1"><Icon name="Scale" size={10}/> Peso</span>}
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <div className="font-mono text-sm text-slate-500">{item.qty} {item.isWeighable ? 'kg' : 'pz'} x €{item.price}</div>
                                            <div className="w-20 text-right font-bold text-lg">€{(item.price * item.qty).toFixed(2)}</div>
                                            <button onClick={() => setCart(cart.filter(c => c.code !== item.code))} className="text-red-400 hover:text-red-600"><Icon name="Trash" size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* DESTRA: Totale */}
                    <div className="w-80 bg-slate-900 text-white rounded-2xl p-6 flex flex-col justify-between shadow-xl">
                        <div><div className="text-slate-400 font-bold uppercase text-sm mb-2">Totale da pagare</div><div className="text-5xl font-mono font-bold tracking-tighter">€{total.toFixed(2)}</div></div>
                        <button onClick={onCheckout} disabled={cart.length === 0} className="w-full py-4 bg-green-500 hover:bg-green-400 text-slate-900 font-bold rounded-xl flex items-center justify-center gap-2 disabled:opacity-50"><Icon name="Check" /> INCASSA</button>
                    </div>

                    {/* MODAL PESO */}
                    {weightItem && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                            <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center animate-in">
                                <div className="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-500"><Icon name="Scale" size={32}/></div>
                                <h3 className="text-xl font-bold mb-1">{weightItem.name}</h3>
                                <p className="text-slate-400 text-sm mb-6">Inserisci il peso in Kg (es. 0.500)</p>
                                <input type="number" step="0.001" value={weightInput} onChange={e => setWeightInput(e.target.value)} onKeyDown={handleWeightConfirm} className="w-full text-center text-4xl font-mono font-bold border-b-2 border-slate-300 focus:border-orange-500 outline-none pb-2 mb-6" placeholder="0.000" autoFocus />
                                <button onClick={handleWeightConfirm} className="w-full bg-orange-500 text-white py-3 rounded-xl font-bold">Conferma Peso</button>
                                <button onClick={() => setWeightItem(null)} className="mt-4 text-slate-400 text-sm">Annulla</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- VISTA INVENTARIO (Con Generatore Barcode) ---
        const InventoryView = ({ products, onUpdate, onCreate, onDelete }) => {
            const [search, setSearch] = useState("");
            const [editItem, setEditItem] = useState(null);
            const [isNew, setIsNew] = useState(false);
            const [offerItem, setOfferItem] = useState(null); 
            
            const filtered = products.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) || p.code.includes(search));

            const generateInternalCode = () => {
                const random = Math.floor(10000 + Math.random() * 90000);
                setEditItem(prev => ({ ...prev, code: `200${random}` }));
            };

            return (
                <div className="h-full flex flex-col p-4 gap-4">
                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex justify-between gap-4">
                        <div className="flex items-center gap-2 bg-slate-100 px-4 py-2 rounded-xl flex-1"><Icon name="Search" className="text-slate-400"/><input type="text" value={search} onChange={e => setSearch(e.target.value)} placeholder="Cerca..." className="bg-transparent outline-none flex-1" /></div>
                        <button onClick={() => { setEditItem({ code: "", name: "", price: "", stock: 0, isWeighable: false }); setIsNew(true); }} className="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold flex gap-2"><Icon name="Plus"/> Nuovo</button>
                    </div>
                    <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-y-auto">
                        {filtered.map(p => (
                            <div key={p.code} className="flex justify-between items-center p-4 border-b hover:bg-slate-50">
                                <div>
                                    <div className="font-bold flex items-center gap-2">
                                        {p.name}
                                        {p.isWeighable && <span className="text-[10px] bg-orange-100 text-orange-600 px-1 rounded flex items-center"><Icon name="Scale" size={10} className="mr-1"/> PESO</span>}
                                        {p.originalPrice && <span className="text-[10px] bg-red-100 text-red-600 px-1 rounded">OFFERTA</span>}
                                    </div>
                                    <div className="text-xs text-slate-400">{p.code}</div>
                                </div>
                                <div className="text-right flex items-center gap-4">
                                    <div className="font-mono">
                                        €{parseFloat(p.price).toFixed(2)}
                                        {p.originalPrice && <div className="text-xs text-slate-400 line-through">€{parseFloat(p.originalPrice).toFixed(2)}</div>}
                                    </div>
                                    <div className={`px-2 py-1 rounded font-bold bg-slate-100 text-slate-600`}>{p.stock}</div>
                                    <button onClick={() => printLabel(p)} className="p-2 hover:bg-slate-200 text-slate-600 rounded" title="Stampa Etichetta"><Icon name="Barcode" size={16}/></button>
                                    <button onClick={() => { setEditItem(p); setIsNew(false); }} className="p-2 hover:bg-blue-100 text-blue-600 rounded"><Icon name="Edit" size={16}/></button>
                                    <button onClick={() => setOfferItem(p)} className="p-2 hover:bg-orange-100 text-orange-500 rounded"><Icon name="Tag" size={16}/></button>
                                    <button onClick={() => onDelete(p.code)} className="p-2 hover:bg-red-100 text-red-500 rounded"><Icon name="Trash" size={16}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {editItem && <Modal title={isNew ? "Nuovo Prodotto" : "Modifica"} onClose={() => setEditItem(null)}>
                        <form onSubmit={e => { e.preventDefault(); isNew ? onCreate(editItem) : onUpdate(editItem); setEditItem(null); }} className="space-y-4">
                            <div className="flex gap-2 items-end">
                                <div className="flex-1">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Barcode</label>
                                    <input value={editItem.code} onChange={e => setEditItem({...editItem, code: e.target.value})} placeholder="Scansiona o Genera" className="w-full border p-2 rounded" required />
                                </div>
                                {isNew && <button type="button" onClick={generateInternalCode} className="bg-slate-200 p-2 rounded text-xs font-bold h-10 hover:bg-slate-300">GENERA</button>}
                            </div>
                            
                            <input value={editItem.name} onChange={e => setEditItem({...editItem, name: e.target.value})} placeholder="Nome Prodotto" className="w-full border p-2 rounded" required/>
                            
                            <div className="flex items-center gap-3 p-3 bg-orange-50 rounded-lg border border-orange-100">
                                <input type="checkbox" id="weighable" checked={editItem.isWeighable || false} onChange={e => setEditItem({...editItem, isWeighable: e.target.checked})} className="w-5 h-5 accent-orange-500"/>
                                <label htmlFor="weighable" className="text-sm font-bold text-orange-800 flex items-center"><Icon name="Scale" size={16} className="mr-2"/> Prodotto a Peso (Bilancia)</label>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <input type="number" step="0.01" value={editItem.price} onChange={e => setEditItem({...editItem, price: e.target.value})} placeholder="Prezzo Vendita" className="w-full border p-2 rounded" required/>
                                <input type="number" value={editItem.stock} onChange={e => setEditItem({...editItem, stock: e.target.value})} placeholder="Stock Iniziale" className="w-full border p-2 rounded" required/>
                            </div>
                            <button className="w-full bg-blue-600 text-white py-3 rounded font-bold">Salva</button>
                        </form>
                    </Modal>}

                    {offerItem && <Modal title="Applica Offerta" onClose={() => setOfferItem(null)}>
                        <div className="space-y-4">
                            <div className="bg-slate-50 p-4 rounded-xl">
                                <h4 className="font-bold">{offerItem.name}</h4>
                                <p className="text-sm">Prezzo attuale: <span className="font-mono font-bold">€{parseFloat(offerItem.price).toFixed(2)}</span></p>
                            </div>
                            <div className="grid grid-cols-3 gap-2">
                                <button onClick={() => setOfferItem({...offerItem, newPrice: (offerItem.price * 0.9).toFixed(2)})} className="p-2 border rounded-lg hover:bg-slate-50">-10%</button>
                                <button onClick={() => setOfferItem({...offerItem, newPrice: (offerItem.price * 0.8).toFixed(2)})} className="p-2 border rounded-lg hover:bg-slate-50">-20%</button>
                                <button onClick={() => setOfferItem({...offerItem, newPrice: (offerItem.price * 0.5).toFixed(2)})} className="p-2 border rounded-lg hover:bg-slate-50">-50%</button>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase">Nuovo Prezzo</label>
                                <input type="number" step="0.01" value={offerItem.newPrice || ""} onChange={e => setOfferItem({...offerItem, newPrice: e.target.value})} className="w-full border-2 border-orange-400 p-3 rounded-lg text-2xl font-bold text-orange-600 text-center" placeholder="€ 0.00" />
                            </div>
                            <div className="flex gap-2 pt-4">
                                <button onClick={() => {
                                    const original = offerItem.originalPrice || offerItem.price;
                                    onUpdate({ ...offerItem, price: original, originalPrice: null });
                                    setOfferItem(null);
                                }} className="flex-1 bg-slate-200 text-slate-700 py-3 rounded-xl font-bold">Rimuovi Offerta</button>
                                <button onClick={() => {
                                    if(!offerItem.newPrice) return;
                                    const original = offerItem.originalPrice || offerItem.price;
                                    onUpdate({ ...offerItem, price: offerItem.newPrice, originalPrice: original });
                                    setOfferItem(null);
                                }} className="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold">Applica</button>
                            </div>
                        </div>
                    </Modal>}
                </div>
            );
        };

        const SettingsView = ({ config, setConfig, serverStatus }) => (
            <div className="max-w-xl mx-auto p-8">
                <h2 className="text-2xl font-bold mb-6">Impostazioni</h2>
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-6">
                    <div>
                        <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Nome Negozio</label>
                        <input type="text" value={config.shopName} onChange={e => setConfig({...config, shopName: e.target.value})} className="w-full border p-2 rounded-lg" />
                    </div>
                    
                    <div className="border-t pt-4">
                        <label className="block text-xs font-bold text-slate-400 uppercase mb-3">Database Storage</label>
                        <div className="grid grid-cols-2 gap-2 mb-4">
                            <button 
                                onClick={() => setConfig({...config, storageMode: 'local'})} 
                                className={`p-4 rounded-xl border-2 flex flex-col items-center gap-2 ${config.storageMode === 'local' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-slate-200 hover:bg-slate-50'}`}
                            >
                                <Icon name="Settings" size={24}/>
                                <span className="font-bold text-sm">Locale (Browser)</span>
                            </button>
                            <button 
                                onClick={() => setConfig({...config, storageMode: 'server'})} 
                                className={`p-4 rounded-xl border-2 flex flex-col items-center gap-2 ${config.storageMode === 'server' ? 'border-purple-500 bg-purple-50 text-purple-700' : 'border-slate-200 hover:bg-slate-50'}`}
                            >
                                <Icon name="Server" size={24}/>
                                <span className="font-bold text-sm">Server (SQLite)</span>
                            </button>
                        </div>

                        {config.storageMode === 'server' && (
                            <div className="bg-slate-50 p-4 rounded-xl animate-in">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Indirizzo Server Locale</label>
                                <input type="text" value={config.serverUrl} onChange={e => setConfig({...config, serverUrl: e.target.value})} className="w-full border p-2 rounded-lg mb-2 font-mono text-sm" placeholder="http://127.0.0.1:5500" />
                                <div className="flex items-center gap-2 text-xs">
                                    Status: 
                                    <span className={`font-bold ${serverStatus === 'online' ? 'text-green-600' : 'text-red-500'}`}>
                                        {serverStatus === 'online' ? 'CONNESSO' : 'OFFLINE'}
                                    </span>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );

        const NavBtn = ({ icon, active, onClick, label, color = "text-slate-400" }) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1 p-2 rounded-xl w-full transition-all ${active ? 'bg-slate-800 text-blue-400' : 'hover:bg-slate-800/50 ' + color}`}>
                <Icon name={icon} className={active ? "text-blue-400" : ""} size={24} />
                <span className="text-[10px] font-bold">{label}</span>
            </button>
        );

        const LoginModal = ({ password, onSuccess, onClose }) => {
            const [input, setInput] = useState("");
            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                    <form onSubmit={e => { e.preventDefault(); if(input===password) onSuccess(); else setInput(""); }} className="bg-white p-8 rounded-2xl text-center w-full max-w-sm">
                        <h3 className="text-xl font-bold mb-4">Admin Login</h3>
                        <input type="password" value={input} onChange={e => setInput(e.target.value)} className="w-full border p-2 rounded mb-4 text-center" placeholder="Password" autoFocus />
                        <div className="flex gap-2"><button type="button" onClick={onClose} className="flex-1 py-2 text-slate-400">Annulla</button><button className="flex-1 py-2 bg-slate-900 text-white rounded">Entra</button></div>
                    </form>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>