<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MarketOS Pro v14.2 (Fixed)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Libs -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.3/umd/Recharts.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- FIREBASE BRIDGE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"; 
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, addDoc, query, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.FB = {
            app: null,
            db: null,
            init: async (configJson) => {
                try {
                    const config = typeof configJson === 'string' ? JSON.parse(configJson) : configJson;
                    if (!config.apiKey) return false;

                    const app = initializeApp(config);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    
                    await signInAnonymously(auth);

                    window.FB.app = app;
                    window.FB.db = db;
                    console.log("Firebase Inizializzato");
                    return true;
                } catch (e) {
                    console.error("Errore Init Firebase", e);
                    return false;
                }
            },
            getDocs, collection, doc, setDoc, deleteDoc, addDoc, query, orderBy, limit, writeBatch
        };
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; color: #0f172a; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .toast-enter { transform: translateX(100%); opacity: 0; }
        .toast-enter-active { transform: translateX(0); opacity: 1; transition: all 300ms; }
        
        /* Chat Animations */
        .chat-overlay-enter { opacity: 0; transform: scale(0.95); }
        .chat-overlay-active { opacity: 1; transform: scale(1); transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        .chat-bubble { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* PRINT STYLES - FIXED */
        @media print { 
            body * { visibility: hidden; } 
            #root, .toast-container { display: none !important; } 
            
            /* FORCE DISPLAY BLOCK FOR PRINT AREA */
            #printable-area { 
                visibility: visible !important; 
                display: block !important; 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                height: auto;
                background: white;
            }
            #printable-area * { visibility: visible !important; }

            /* Stile Report A4 */
            .print-grid { display: grid !important; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
            .print-item { border: 1px dashed #ccc; padding: 10px; text-align: center; page-break-inside: avoid; display: flex; flex-direction: column; align-items: center; justify-content: center; }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            .print-table th, .print-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            .print-table th { background-color: #f2f2f2; }

            /* Stile Scontrino Termico (58mm/80mm simulation) */
            .receipt-style {
                width: 78mm; 
                font-family: 'Courier New', monospace;
                font-size: 12px;
                line-height: 1.2;
                margin: 0;
                padding: 5px;
                color: black;
            }
            .receipt-header { text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 5px; }
            .receipt-title { font-size: 16px; font-weight: bold; text-transform: uppercase; }
            .receipt-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
            .receipt-divider { border-top: 1px dashed #000; margin: 5px 0; }
            .receipt-bold { font-weight: bold; }
            .receipt-footer { text-align: center; margin-top: 10px; font-size: 10px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="printable-area" style="display:none;"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const CONFIG_VERSION = 14;

        // --- MARKET BRAIN (AI ENGINE LOCALE) ---
        class MarketBrain {
            constructor(products, logs) {
                this.products = products;
                this.logs = logs;
            }

            parseQuery(query) {
                const q = query.toLowerCase();
                const result = { type: 'unknown', data: null, message: "Non ho capito, prova con 'vendite oggi', 'andamento vendite' o 'stock mele'." };
                const today = new Date().toISOString().split('T')[0];

                const targetProduct = this.products.find(p => q.includes(p.name.toLowerCase()));
                let timeFilter = 'all';
                if (q.includes('oggi')) timeFilter = 'today';
                if (q.includes('settimana')) timeFilter = 'week';
                if (q.includes('mese')) timeFilter = 'month';

                if (q.includes('stock') || q.includes('giacenza') || q.includes('quante') || q.includes('quanti')) {
                    if (targetProduct) {
                        const unit = targetProduct.isWeighable ? 'kg' : 'pz';
                        result.type = 'text';
                        result.message = `Attualmente hai ${targetProduct.stock} ${unit} di ${targetProduct.name} in magazzino.`;
                        const exp = this.getNearestExpiry(targetProduct);
                        if (exp) result.message += ` (Prox scadenza: ${exp})`;
                    } else {
                        const lowStock = this.products.filter(p => p.stock < 5);
                        result.type = 'list';
                        result.message = `Hai ${lowStock.length} prodotti sotto scorta minima.`;
                        result.data = lowStock.map(p => ({ label: p.name, value: `${p.stock} ${p.isWeighable ? 'kg' : 'pz'}` }));
                    }
                    return result;
                }

                if (q.includes('vendut') || q.includes('vendite') || q.includes('incasso') || q.includes('andamento') || q.includes('grafico')) {
                    let filteredLogs = this.logs;
                    if (timeFilter === 'today') filteredLogs = filteredLogs.filter(l => l.date.startsWith(today));
                    
                    if (targetProduct) {
                        let count = 0;
                        let revenue = 0;
                        const unit = targetProduct.isWeighable ? 'kg' : 'pz';
                        filteredLogs.forEach(l => {
                            l.items.forEach(i => {
                                if (i.code === targetProduct.code) {
                                    count += i.qty;
                                    revenue += (i.price * i.qty);
                                }
                            });
                        });
                        result.type = 'chart';
                        result.message = `${timeFilter === 'today' ? 'Oggi' : 'In questo periodo'} hai venduto ${count.toFixed(2)} ${unit} di ${targetProduct.name} per un totale di €${revenue.toFixed(2)}.`;
                        const productLogs = filteredLogs.filter(l => l.items.some(i => i.code === targetProduct.code));
                        result.data = this.groupLogsByDate(productLogs);
                    } else {
                        const total = filteredLogs.reduce((acc, l) => acc + l.total, 0);
                        if (q.includes('andamento') || q.includes('grafico') || q.includes('trend')) {
                            result.type = 'chart';
                            result.message = "Ecco l'andamento delle vendite (Ultimi 7 gg).";
                            const now = new Date();
                            const past = new Date();
                            past.setDate(now.getDate() - 7);
                            const recentLogs = this.logs.filter(l => new Date(l.date) >= past);
                            result.data = this.groupLogsByDate(recentLogs);
                        } else {
                            result.type = 'text';
                            result.message = `Il totale lordo ${timeFilter === 'today' ? 'di oggi' : ''} è €${total.toFixed(2)}.`;
                        }
                    }
                    return result;
                }

                if (q.includes('scadenz') || q.includes('scadut')) {
                   const expiring = this.products.filter(p => p.expiryDate).sort((a,b) => new Date(a.expiryDate) - new Date(b.expiryDate)).slice(0, 5);
                   result.type = 'list';
                   result.message = "Ecco i prodotti con scadenza più vicina:";
                   result.data = expiring.map(p => ({ label: p.name, value: p.expiryDate, alert: true }));
                   return result;
                }
                return result;
            }

            groupLogsByDate(logs) {
                const grouped = {};
                logs.forEach(l => {
                    const dateKey = new Date(l.date).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
                    if(!grouped[dateKey]) grouped[dateKey] = 0;
                    grouped[dateKey] += l.total;
                });
                return Object.keys(grouped).map(key => ({ name: key, value: grouped[key] }));
            }

            getNearestExpiry(product) {
                 if(!product.batches || product.batches.length === 0) return product.expiryDate;
                 const active = product.batches.filter(b => b.stock > 0 && b.expiryDate).sort((a,b) => a.expiryDate.localeCompare(b.expiryDate));
                 return active.length > 0 ? active[0].expiryDate : null;
            }
        }

        // --- COMPONENTS UI BASE ---
        const ToastContainer = ({ toasts }) => (
            <div className="fixed top-4 right-4 z-50 flex flex-col gap-2 toast-container">
                {toasts.map(t => (
                    <div key={t.id} className={`p-4 rounded-xl shadow-lg text-white font-bold min-w-[300px] animate-in slide-in-from-right ${t.type === 'error' ? 'bg-red-500' : 'bg-green-500'}`}>
                        {t.msg}
                    </div>
                ))}
            </div>
        );

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Barcode: <path d="M3 5v14M8 5v14M12 5v14M17 5v14M21 5v14" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>,
                ShoppingCart: <path d="M9 20a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm7 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-7-16L4 4 2 2M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Box: <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                TrendingUp: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><polyline points="17 6 23 6 23 12" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Trash: <><polyline points="3 6 5 6 21 6" fill="none" stroke="currentColor" strokeWidth="2"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" strokeWidth="2"/></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" strokeWidth="2"/><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2"/></>,
                Minus: <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2"/>,
                Check: <polyline points="20 6 9 17 4 12" fill="none" stroke="currentColor" strokeWidth="2"/>,
                Search: <><circle cx="11" cy="11" r="8" fill="none" stroke="currentColor" strokeWidth="2"/><line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" strokeWidth="2"/></>,
                Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Scale: <><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M7 21h10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 3v18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Printer: <><polyline points="6 9 6 2 18 2 18 9" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><rect x="6" y="14" width="12" height="8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Tag: <><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><line x1="7" y1="7" x2="7.01" y2="7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                X: <><line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></>,
                Server: <><rect x="2" y="2" width="20" height="8" rx="2" ry="2" stroke="currentColor" strokeWidth="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2" stroke="currentColor" strokeWidth="2"/><line x1="6" y1="6" x2="6.01" y2="6" stroke="currentColor" strokeWidth="2"/><line x1="6" y1="18" x2="6.01" y2="18" stroke="currentColor" strokeWidth="2"/></>,
                Cloud: <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Refresh: <><polyline points="23 4 23 10 17 10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><polyline points="1 20 1 14 7 14" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                PieChart: <><path d="M21.21 15.89A10 10 0 1 1 8 2.83" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M22 12A10 10 0 0 0 12 2v10z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                DollarSign: <><line x1="12" y1="1" x2="12" y2="23" stroke="currentColor" strokeWidth="2"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" strokeWidth="2"/></>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" strokeWidth="2"/><line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" strokeWidth="2"/><line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" strokeWidth="2"/><line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" strokeWidth="2"/></>,
                List: <><line x1="8" y1="6" x2="21" y2="6" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="8" y1="12" x2="21" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="8" y1="18" x2="21" y2="18" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="3" y1="6" x2="3.01" y2="6" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="3" y1="12" x2="3.01" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="3" y1="18" x2="3.01" y2="18" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></>,
                Alert: <><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><line x1="12" y1="9" x2="12" y2="13" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="12" y1="17" x2="12.01" y2="17" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></>,
                Clock: <><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/><polyline points="12 6 12 12 16 14" stroke="currentColor" strokeWidth="2"/></>,
                Bot: <><rect x="3" y="11" width="18" height="10" rx="2" stroke="currentColor" strokeWidth="2" fill="none" /><circle cx="12" cy="5" r="2" stroke="currentColor" strokeWidth="2" fill="none" /><path d="M12 7v4" stroke="currentColor" strokeWidth="2" fill="none" /><line x1="8" y1="16" x2="8" y2="16" stroke="currentColor" strokeWidth="2" /><line x1="16" y1="16" x2="16" y2="16" stroke="currentColor" strokeWidth="2" /></>,
                Send: <><line x1="22" y1="2" x2="11" y2="13" stroke="currentColor" strokeWidth="2" /><polygon points="22 2 15 22 11 13 2 9 22 2" stroke="currentColor" strokeWidth="2" /></>,
                MessageSquare: <><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" strokeWidth="2" /></>,
                Clipboard: <><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" stroke="currentColor" strokeWidth="2" fill="none" /><rect x="8" y="2" width="8" height="4" rx="1" ry="1" stroke="currentColor" strokeWidth="2" fill="none" /></>,
                User: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" strokeWidth="2" /><circle cx="12" cy="7" r="4" stroke="currentColor" strokeWidth="2" /></>
            };
            return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={`${className} shrink-0`}>{icons[name]}</svg>;
        };

        // --- MODAL E UTILS ---
        const Modal = ({ title, onClose, children }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                    <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <h3 className="font-bold text-lg text-slate-800">{title}</h3>
                        <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-500"><Icon name="X" size={20}/></button>
                    </div>
                    <div className="p-6 overflow-y-auto flex-1">{children}</div>
                </div>
            </div>
        );

        const NavBtn = ({ icon, active, onClick, label, color = "text-slate-500" }) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1.5 p-3 rounded-xl w-full shrink-0 transition-all ${active ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30' : 'hover:bg-slate-800/50 ' + color}`}>
                <Icon name={icon} className={active ? "text-white" : ""} size={24} />
                <span className="text-[10px] font-bold tracking-wide">{label}</span>
            </button>
        );

        const LoginModal = ({ password, onSuccess, onClose }) => {
            const [input, setInput] = useState("");
            return (
                <div className="fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                    <form onSubmit={e => { e.preventDefault(); if(input===password) onSuccess(); else setInput(""); }} className="bg-white p-8 rounded-3xl text-center w-full max-w-sm shadow-2xl transform transition-all">
                        <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6 text-slate-600 shrink-0"><Icon name="Settings" size={32} /></div>
                        <h3 className="text-xl font-bold mb-2 text-slate-800">Admin Login</h3>
                        <p className="text-xs text-slate-400 mb-6">Inserisci PIN di sicurezza</p>
                        <input type="password" value={input} onChange={e => setInput(e.target.value)} className="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl mb-6 text-center text-2xl tracking-widest focus:border-blue-500 outline-none transition-colors" placeholder="••••" autoFocus />
                        <button className="w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 transition-colors">Accedi</button>
                        <button type="button" onClick={onClose} className="mt-4 text-xs text-slate-400 hover:text-slate-600 font-bold uppercase tracking-wider">Annulla</button>
                    </form>
                </div>
            );
        };

        const getBaseUrl = (config) => {
            if (!config.serverUrl || config.serverUrl.trim() === "") return 'http://127.0.0.1:5500';
            return config.serverUrl.replace(/\/$/, "");
        };

        // --- DATA ADAPTER ---
        const DataAdapter = {
            async getProducts(config) {
                if (config.storageMode === 'firebase') {
                    if(!window.FB || !window.FB.db) return [];
                    const q = window.FB.query(window.FB.collection(window.FB.db, "products"));
                    const snapshot = await window.FB.getDocs(q);
                    return snapshot.docs.map(doc => doc.data());
                }
                if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    for(let i=0; i<3; i++) {
                        try {
                            const res = await fetch(`${url}/api/products`);
                            if(!res.ok) throw new Error("Server Error");
                            return await res.json();
                        } catch(e) {
                            if (i === 2) throw e;
                            await new Promise(r => setTimeout(r, 500));
                        }
                    }
                }
                return JSON.parse(localStorage.getItem('products')) || [];
            },
            async saveProduct(config, product) {
                if (config.storageMode === 'firebase') {
                    if(!window.FB || !window.FB.db) throw new Error("Firebase non inizializzato");
                    await window.FB.setDoc(window.FB.doc(window.FB.db, "products", product.code), product);
                } else if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    await fetch(`${url}/api/products`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(product) });
                }
            },
            async deleteProduct(config, code) {
                if (config.storageMode === 'firebase') {
                    await window.FB.deleteDoc(window.FB.doc(window.FB.db, "products", code));
                } else if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    await fetch(`${url}/api/products/${code}`, { method: 'DELETE' });
                }
            },
            async saveLog(config, log) {
                if (config.storageMode === 'firebase') {
                    await window.FB.addDoc(window.FB.collection(window.FB.db, "logs"), log);
                } else if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    await fetch(`${url}/api/logs`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(log) });
                }
            },
            async deleteLog(config, logId) {
                if (config.storageMode === 'firebase') {
                    // Requires getting DocID first, skipped for brevity in this simplified bridge
                }
                // LocalStorage Fallback for simulation
                const logs = JSON.parse(localStorage.getItem('logs')) || [];
                const newLogs = logs.filter(l => l.id !== logId);
                localStorage.setItem('logs', JSON.stringify(newLogs));
            },
            async getLogs(config) { 
                if (config.storageMode === 'firebase') {
                    if(!window.FB || !window.FB.db) return [];
                    const q = window.FB.query(window.FB.collection(window.FB.db, "logs"), window.FB.orderBy("date", "desc"), window.FB.limit(200));
                    const snapshot = await window.FB.getDocs(q);
                    return snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
                }
                if (config.storageMode === 'server') { 
                    const url = getBaseUrl(config); 
                    try {
                        const res = await fetch(`${url}/api/logs`);
                        if(!res.ok) throw new Error("Failed");
                        return await res.json(); 
                    } catch (e) { return []; }
                } 
                return JSON.parse(localStorage.getItem('logs')) || []; 
            },
            async getCategories(config) {
                if (config.storageMode === 'firebase') {
                    const q = window.FB.query(window.FB.collection(window.FB.db, "categories"));
                    const snapshot = await window.FB.getDocs(q);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    const res = await fetch(`${url}/api/categories`);
                    return await res.json();
                }
                return [];
            },
            async addCategory(config, name) {
                if (config.storageMode === 'firebase') {
                    await window.FB.addDoc(window.FB.collection(window.FB.db, "categories"), { name });
                } else if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    await fetch(`${url}/api/categories`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name }) });
                }
            },
            async deleteCategory(config, id) {
                if (config.storageMode === 'firebase') {
                    await window.FB.deleteDoc(window.FB.doc(window.FB.db, "categories", id));
                } else if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    await fetch(`${url}/api/categories/${id}`, { method: 'DELETE' });
                }
            },
            async migrateLocalToCloud(config) {
                if (!window.FB || !window.FB.db) throw new Error("Firebase non connesso");
                const localProds = JSON.parse(localStorage.getItem('products')) || [];
                const localLogs = JSON.parse(localStorage.getItem('logs')) || [];
                let count = 0;
                for (let p of localProds) {
                    await window.FB.setDoc(window.FB.doc(window.FB.db, "products", p.code), p);
                    count++;
                }
                for (let l of localLogs) {
                    await window.FB.addDoc(window.FB.collection(window.FB.db, "logs"), l);
                }
                return count;
            },

            // --- NUOVE API BILANCIA ---
            async getScaleWeight(config) {
                const url = getBaseUrl(config);
                try {
                    const res = await fetch(`${url}/api/scale/read`);
                    if (!res.ok) return null;
                    return await res.json();
                } catch (e) {
                    return null;
                }
            },
            async setScaleConfig(config, port, baudrate) {
                const url = getBaseUrl(config);
                try {
                    await fetch(`${url}/api/scale/config`, { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ port, baudrate }) 
                    });
                } catch (e) {
                    throw new Error("Impossibile salvare configurazione bilancia (Server offline?)");
                }
            },
            async getScaleConfig(config) {
                const url = getBaseUrl(config);
                try {
                    const res = await fetch(`${url}/api/scale/config`);
                    if (!res.ok) return {};
                    return await res.json();
                } catch { return {}; }
            }
        };

        const printLabel = (product) => {
            const printArea = document.getElementById('printable-area');
            printArea.style.display = 'block';
            printArea.innerHTML = `<div id="printable-label" style="text-align: center; font-family: monospace; width: 300px; padding: 20px; border: 1px dashed black;"><h2 style="margin: 0; font-size: 18px;">${product.name}</h2><p style="margin: 5px 0;">Cod: ${product.code}</p><svg id="barcode-render"></svg><h1 style="margin: 10px 0; font-size: 32px;">€ ${parseFloat(product.price).toFixed(2)}</h1><p style="font-size: 10px;">${product.isWeighable ? 'ARTICOLO A PESO (Prezzo al Kg)' : 'PREZZO CAD.'}</p></div>`;
            try { JsBarcode("#barcode-render", product.code, { format: "CODE128", height: 50, displayValue: false }); window.print(); } catch (e) { alert("Errore barcode: " + e.message); }
            setTimeout(() => { printArea.style.display = 'none'; }, 1000);
        };

        const printReport = (products, categoryFilter) => {
            const printArea = document.getElementById('printable-area');
            printArea.style.display = 'block';
            let itemsToPrint = products;
            if (categoryFilter && categoryFilter !== 'Tutte') {
                itemsToPrint = products.filter(p => p.category === categoryFilter);
            }

            if(itemsToPrint.length === 0) return alert("Nessun prodotto trovato per questa categoria.");

            let htmlContent = `<div class="print-grid">`;
            itemsToPrint.forEach((p, index) => {
                htmlContent += `
                    <div class="print-item">
                        <div style="font-weight: bold; font-size: 14px;">${p.name}</div>
                        <svg id="bc-${index}" style="width: 100%; max-width: 150px;"></svg>
                        <div style="font-size: 12px;">${p.code}</div>
                        <div style="font-weight: bold;">€ ${parseFloat(p.price).toFixed(2)}</div>
                    </div>
                `;
            });
            htmlContent += `</div>`;
            printArea.innerHTML = htmlContent;

            setTimeout(() => {
                itemsToPrint.forEach((p, index) => {
                    try { JsBarcode(`#bc-${index}`, p.code, { format: "CODE128", height: 40, displayValue: false, margin: 0 }); } catch(e) {}
                });
                window.print();
                setTimeout(() => { printArea.style.display = 'none'; }, 1000);
            }, 500);
        };

        const printExpiryReport = (products) => {
            const printArea = document.getElementById('printable-area');
            printArea.style.display = 'block';
            const today = new Date();
            
            let allBatches = [];
            products.forEach(p => {
                const batches = p.batches || [{expiryDate: p.expiryDate, stock: p.stock}];
                batches.forEach(b => {
                    if(b.expiryDate && b.stock > 0) {
                        allBatches.push({
                            code: p.code,
                            name: p.name,
                            expiryDate: b.expiryDate,
                            stock: b.stock || b.qty, 
                        });
                    }
                });
            });

            const expiring = allBatches
                .map(b => {
                    const d = new Date(b.expiryDate);
                    const diffTime = d - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return { ...b, diffDays };
                })
                .sort((a, b) => a.diffDays - b.diffDays);

            if(expiring.length === 0) return alert("Nessun lotto con data di scadenza trovato.");

            let htmlContent = `
                <div style="padding: 20px; font-family: sans-serif;">
                    <h1 style="text-align: center; margin-bottom: 20px;">Report Scadenze (Dettaglio Lotti)</h1>
                    <p style="text-align: center;">Generato il: ${today.toLocaleDateString()}</p>
                    <table class="print-table">
                        <thead>
                            <tr>
                                <th>Codice</th>
                                <th>Prodotto</th>
                                <th>Scadenza</th>
                                <th>Giorni</th>
                                <th>Stock Lotto</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            expiring.forEach(p => {
                const color = p.diffDays < 0 ? '#fee2e2' : p.diffDays <= 7 ? '#ffedd5' : 'transparent';
                const status = p.diffDays < 0 ? 'SCADUTO' : p.diffDays + ' gg';
                htmlContent += `
                    <tr style="background-color: ${color}">
                        <td>${p.code}</td>
                        <td>${p.name}</td>
                        <td>${p.expiryDate}</td>
                        <td>${status}</td>
                        <td>${p.stock}</td>
                    </tr>
                `;
            });

            htmlContent += `</tbody></table></div>`;
            printArea.innerHTML = htmlContent;
            setTimeout(() => { 
                window.print();
                setTimeout(() => { printArea.style.display = 'none'; }, 1000);
            }, 500);
        };

        // --- HELPER DI STAMPA SCONTRINO (UPDATED WITH COMPANY DATA) ---
        const printReceipt = (transaction, config) => {
            const printArea = document.getElementById('printable-area');
            printArea.style.display = 'block';
            const date = new Date(transaction.date).toLocaleString('it-IT');
            
            let itemsHtml = '';
            transaction.items.forEach(item => {
                itemsHtml += `
                    <div class="receipt-row">
                        <span>${item.qty}x ${item.name.substring(0, 15)}</span>
                        <span>€${(item.price * item.qty).toFixed(2)}</span>
                    </div>
                    <div class="receipt-row" style="font-size: 10px; color: #555;">
                        <span>(IVA ${item.taxRate || 22}%)</span>
                    </div>
                `;
            });

            printArea.innerHTML = `
                <div class="receipt-style">
                    <div class="receipt-header">
                        <div class="receipt-title">${config.shopName || "MarketOS"}</div>
                        <div>${config.address || "Indirizzo non impostato"}</div>
                        <div>P.IVA ${config.piva || "---"}</div>
                        <div>Tel: ${config.phone || "---"}</div>
                        <br/>
                        <div>Data: ${date}</div>
                        <div>Transazione: #${transaction.id.toString().slice(-6)}</div>
                    </div>
                    <div class="receipt-body">
                        ${itemsHtml}
                    </div>
                    <div class="receipt-divider"></div>
                    <div class="receipt-row receipt-bold" style="font-size: 14px;">
                        <span>TOTALE</span>
                        <span>€${transaction.total.toFixed(2)}</span>
                    </div>
                    <div class="receipt-row">
                        <span>Imponibile</span>
                        <span>€${(transaction.netTotal || (transaction.total/1.22)).toFixed(2)}</span>
                    </div>
                    <div class="receipt-row">
                        <span>IVA</span>
                        <span>€${(transaction.taxTotal || (transaction.total - (transaction.total/1.22))).toFixed(2)}</span>
                    </div>
                    <div class="receipt-divider"></div>
                    <div class="receipt-footer">
                        ${config.receiptFooter || "Grazie e Arrivederci!"}<br/>
                        Copia conforme all'originale
                    </div>
                </div>
            `;
            setTimeout(() => {
                window.print();
                setTimeout(() => { printArea.style.display = 'none'; }, 1000);
            }, 200);
        };

        // --- HELPER SCADENZE ---
        const getExpiryStatus = (expiryDate) => {
            if (!expiryDate) return null;
            const today = new Date();
            const exp = new Date(expiryDate);
            const diffTime = exp - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return { color: 'text-red-600', bg: 'bg-red-100', label: 'SCADUTO', icon: 'Alert', diffDays };
            if (diffDays <= 7) return { color: 'text-orange-600', bg: 'bg-orange-100', label: 'In Scadenza', icon: 'Clock', diffDays };
            return { color: 'text-slate-600', bg: 'bg-slate-100', label: 'OK', icon: 'Check', diffDays };
        };

        const getNearestExpiry = (product) => {
            if(!product.batches || product.batches.length === 0) return product.expiryDate || null;
            // Trova la data più vicina tra i lotti con stock > 0
            const activeBatches = product.batches.filter(b => b.stock > 0 && b.expiryDate);
            if(activeBatches.length === 0) return null;
            
            // Sort by date string (ISO format works directly)
            activeBatches.sort((a,b) => a.expiryDate.localeCompare(b.expiryDate));
            return activeBatches[0].expiryDate;
        };

        // --- VISTE ---
        const POSView = ({ products, cart, setCart, onCheckout, config, onPrintReceipt }) => {
            const [input, setInput] = useState(""); 
            const [searchMode, setSearchMode] = useState(false); 
            const [searchTerm, setSearchTerm] = useState(""); 
            const [weightItem, setWeightItem] = useState(null); 
            const [weightInput, setWeightInput] = useState(""); 
            const [liveWeight, setLiveWeight] = useState(null); 
            const inputRef = useRef(null);
            const scaleInterval = useRef(null);

            useEffect(() => { if (!weightItem && !searchMode) inputRef.current?.focus(); }, [cart, weightItem, searchMode]);
            
            useEffect(() => {
                if (weightItem) {
                    setLiveWeight(null);
                    scaleInterval.current = setInterval(async () => {
                        const data = await DataAdapter.getScaleWeight(config);
                        if (data && !data.error && data.weight > 0) {
                            setLiveWeight(data.weight);
                        }
                    }, 500); 
                } else {
                    if (scaleInterval.current) clearInterval(scaleInterval.current);
                }
                return () => { if (scaleInterval.current) clearInterval(scaleInterval.current); };
            }, [weightItem, config]);

            const handleScan = (e) => { if (e.key === 'Enter') { if(!input.trim()) return; processItemAdd(input.trim()); setInput(""); } };
            
            const processItemAdd = (code) => { 
                const clean = code.toString().trim();
                const p = products.find(x => x.code === clean) || products.find(x => x.name.toLowerCase() === clean.toLowerCase()); 
                if (!p) return alert("Non trovato: " + clean); 
                
                // Controllo scadenza sul lotto più vecchio (FEFO)
                const nearestExp = getNearestExpiry(p);
                const status = getExpiryStatus(nearestExp);
                if(status && status.label === 'SCADUTO') {
                    if(!confirm(`ATTENZIONE: Il prodotto ${p.name} ha un lotto SCADUTO (${nearestExp}). Continuare la vendita?`)) return;
                }

                if (p.isWeighable) { setWeightItem(p); setWeightInput(""); return; } 
                addToCart(p, 1); 
            };
            
            const addToCart = (p, q) => { 
                const ex = cart.find(x => x.code === p.code); 
                if(ex) setCart(cart.map(x => x.code === p.code ? {...x, qty: x.qty + q} : x)); 
                else setCart([...cart, {...p, qty: q}]); 
            };

            const removeFromCart = (code) => {
                setCart(cart.filter(x => x.code !== code));
            };
            
            const handleWeightConfirm = (w) => { 
                const finalW = parseFloat(w); 
                if (!finalW || finalW <= 0) return alert("Peso non valido"); 
                addToCart(weightItem, finalW); 
                setWeightItem(null); 
                setSearchMode(false); 
            };
            
            const total = cart.reduce((a, b) => a + (b.price * b.qty), 0); 
            
            // Calcolo IVA dinamico per il carrello
            const totalTax = cart.reduce((acc, item) => {
                const itemTotal = item.price * item.qty;
                const taxRate = item.taxRate || 22; // Default 22% se non specificato
                const net = itemTotal / (1 + taxRate/100);
                return acc + (itemTotal - net);
            }, 0);

            const filtered = products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
            
            return (
                <div className="flex h-full p-4 gap-4 relative">
                    <div className="flex-1 flex flex-col gap-4">
                        <div className="flex gap-2">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex items-center gap-4 flex-1">
                                <Icon name="Barcode" className="text-slate-400"/>
                                <input ref={inputRef} type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={handleScan} className="flex-1 text-2xl font-mono outline-none placeholder:text-slate-300" placeholder="Spara codice..." />
                            </div>
                            <button onClick={() => { setSearchMode(!searchMode); setSearchTerm(""); }} className={`px-6 rounded-2xl font-bold border transition-all flex items-center gap-2 ${searchMode ? 'bg-blue-100 text-blue-600 border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>
                                <Icon name="Search" /> {searchMode ? 'Chiudi' : 'Cerca'}
                            </button>
                        </div>

                        {searchMode && (
                            <div className="bg-white rounded-2xl shadow-lg border border-blue-100 flex flex-col h-64 animate-in fade-in absolute top-24 left-6 right-[24rem] z-10">
                                <div className="p-3 border-b border-slate-100 flex gap-2"><input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full outline-none font-bold text-lg" placeholder="Scrivi nome..." autoFocus /></div>
                                <div className="overflow-y-auto p-2">{filtered.map(p => (<button key={p.code} onClick={() => { processItemAdd(p.code); setSearchMode(false); }} className="w-full text-left p-3 hover:bg-blue-50 rounded-xl flex justify-between group"><div><div className="font-bold text-slate-700">{p.name}</div><div className="text-xs text-slate-400">{p.code}</div></div><div className="font-mono font-bold">€{parseFloat(p.price).toFixed(2)}</div></button>))}</div>
                            </div>
                        )}

                        <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                            <div className="bg-slate-50/80 backdrop-blur p-4 text-xs font-bold text-slate-500 uppercase flex justify-between sticky top-0"><span>Prodotti ({cart.length})</span><span>Importo</span></div>
                            <div className="flex-1 overflow-y-auto p-3 space-y-3">
                                {cart.map(item => (
                                    <div key={item.code} className="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-xl hover:border-blue-200 transition-colors group">
                                        <div className="flex-1">
                                            <div className="font-bold text-slate-800">{item.name}</div>
                                            <div className="text-xs text-slate-400 flex items-center gap-2">
                                                {item.code} 
                                                {item.isWeighable && <span className="bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded text-[10px] font-bold">PESO</span>}
                                                <span className="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded text-[10px] font-bold">IVA {item.taxRate || 22}%</span>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-6">
                                            <div className="flex items-center bg-slate-50 rounded-lg border border-slate-200 p-1">
                                                <button onClick={() => setCart(cart.map(c => c.code === item.code ? {...c, qty: Math.max(0, c.qty - 1)} : c).filter(c=>c.qty>0))} className="p-2 hover:bg-white hover:shadow-sm rounded-md text-slate-500"><Icon name="Minus" size={14}/></button>
                                                <span className="w-10 text-center font-mono font-bold">{item.qty}</span>
                                                <button onClick={() => setCart(cart.map(c => c.code === item.code ? {...c, qty: c.qty + 1} : c))} className="p-2 hover:bg-white hover:shadow-sm rounded-md text-blue-600"><Icon name="Plus" size={14}/></button>
                                            </div>
                                            <div className="w-24 text-right font-mono font-bold text-xl">€{(item.price * item.qty).toFixed(2)}</div>
                                            <button onClick={() => removeFromCart(item.code)} className="p-2 text-red-400 hover:bg-red-50 hover:text-red-600 rounded-lg transition-colors" title="Rimuovi riga"><Icon name="Trash" size={18} /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="w-80 bg-[#0f172a] text-white rounded-2xl p-8 flex flex-col justify-between shadow-2xl">
                        <div>
                            <div className="text-slate-400 font-bold uppercase text-xs tracking-widest mb-2">Totale Scontrino</div>
                            <div className="text-6xl font-mono font-bold tracking-tighter">€{total.toFixed(2)}</div>
                            <div className="mt-8 pt-8 border-t border-slate-700 space-y-3 text-sm text-slate-400">
                                <div className="flex justify-between"><span>Articoli</span><span className="text-white font-bold">{cart.reduce((a,b)=>a+b.qty,0)}</span></div>
                                <div className="flex justify-between"><span>Imponibile</span><span className="text-white font-bold">€{(total - totalTax).toFixed(2)}</span></div>
                                <div className="flex justify-between"><span>IVA Totale</span><span className="text-white font-bold">€{totalTax.toFixed(2)}</span></div>
                            </div>
                        </div>
                        <div className="space-y-2">
                            <button onClick={onPrintReceipt} disabled={!onPrintReceipt} className="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-xl flex items-center justify-center gap-3 transition-all text-sm">
                                <Icon name="Printer" size={16}/> Stampa Ultimo
                            </button>
                            <button onClick={onCheckout} disabled={cart.length === 0} className="w-full py-5 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:shadow-lg hover:shadow-blue-900/50 text-lg">
                                <Icon name="Check" /> INCASSA
                            </button>
                        </div>
                    </div>

                    {weightItem && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                            <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center animate-in fade-in zoom-in duration-200 relative">
                                <button onClick={() => setWeightItem(null)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="X" size={24}/></button>
                                
                                <div className="w-20 h-20 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-500 shadow-inner">
                                    <Icon name="Scale" size={40}/>
                                </div>
                                <h3 className="text-2xl font-bold mb-1 text-slate-800">{weightItem.name}</h3>
                                <p className="text-slate-400 text-sm mb-6">Inserisci il peso netto</p>
                                
                                {/* LIVE WEIGHT DISPLAY */}
                                {liveWeight !== null ? (
                                    <div className="mb-6 animate-pulse-ring bg-green-50 border-2 border-green-500 text-green-700 p-4 rounded-2xl">
                                        <div className="text-xs font-bold uppercase tracking-wide mb-1">Bilancia Connessa</div>
                                        <div className="text-5xl font-mono font-bold">{liveWeight.toFixed(3)} <span className="text-lg">kg</span></div>
                                        <button onClick={() => handleWeightConfirm(liveWeight)} className="mt-3 w-full py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-500">USA QUESTO PESO</button>
                                    </div>
                                ) : (
                                    <div className="mb-6 relative">
                                        <input type="number" step="0.001" value={weightInput} onChange={e => setWeightInput(e.target.value)} onKeyDown={e => {if(e.key==='Enter') handleWeightConfirm(e.target.value)}} className="w-full text-center text-6xl font-mono font-bold border-b-4 border-slate-100 focus:border-orange-500 outline-none pb-2 bg-transparent text-slate-800" placeholder="0.000" autoFocus />
                                        <span className="absolute right-0 bottom-4 text-slate-400 font-bold">kg</span>
                                    </div>
                                )}
                                
                                <div className="grid grid-cols-1 gap-4">
                                    <button onClick={() => handleWeightConfirm(weightInput)} className="py-4 bg-orange-500 text-white font-bold rounded-xl hover:bg-orange-400 shadow-lg shadow-orange-200 transition-all w-full">CONFERMA MANUALE</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- NEW WAREHOUSE VIEW ---
        const WarehouseView = ({ products, onUpdate }) => {
            const [barcode, setBarcode] = useState("");
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [mode, setMode] = useState(null); // 'load' or 'waste'
            const [quantity, setQuantity] = useState("");
            const [reason, setReason] = useState("Avaria"); // for waste

            const handleScan = (e) => {
                if(e.key === 'Enter') {
                    const p = products.find(x => x.code === barcode || x.name.toLowerCase() === barcode.toLowerCase());
                    if(p) setSelectedProduct(p);
                    else alert("Prodotto non trovato");
                    setBarcode("");
                }
            };

            const handleConfirm = () => {
                if(!quantity || parseFloat(quantity) <= 0) return alert("Quantità non valida");
                const qty = parseFloat(quantity);
                
                let updatedP = { ...selectedProduct };
                let batches = [...(updatedP.batches || [])];

                // Create legacy batch if none
                if(batches.length === 0) batches.push({ id: 'legacy', stock: updatedP.stock, expiryDate: updatedP.expiryDate, cost: updatedP.cost || 0 });

                if(mode === 'load') {
                    // Quick Load: Add to generic batch or create new simple batch
                    batches.push({
                        id: Date.now(),
                        stock: qty,
                        expiryDate: "", // Quick load usually implies current date or generic
                        cost: updatedP.cost || 0,
                        supplier: "Carico Rapido"
                    });
                } else if (mode === 'waste') {
                    // Waste: Reduce from oldest batches (FEFO) logic same as sales but without revenue
                    let qtyToDeduct = qty;
                    batches.sort((a,b) => {
                         if(!a.expiryDate) return 1;
                         if(!b.expiryDate) return -1;
                         return a.expiryDate.localeCompare(b.expiryDate);
                    });
                    
                    batches = batches.map(b => {
                        if(qtyToDeduct <= 0) return b;
                        if(b.stock >= qtyToDeduct) {
                            b.stock -= qtyToDeduct;
                            qtyToDeduct = 0;
                            return b;
                        } else {
                            qtyToDeduct -= b.stock;
                            b.stock = 0;
                            return b;
                        }
                    }).filter(b => b.stock > 0);
                }

                updatedP.batches = batches;
                updatedP.stock = batches.reduce((a,b) => a + b.stock, 0);
                
                onUpdate(updatedP);
                setSelectedProduct(null);
                setQuantity("");
                setMode(null);
                alert("Operazione completata");
            };

            return (
                <div className="h-full flex flex-col p-6 gap-6">
                    <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-3"><Icon name="Clipboard" size={28}/> Operazioni Magazzino</h2>
                    
                    {!selectedProduct ? (
                        <div className="flex-1 flex flex-col items-center justify-center text-center space-y-6">
                            <div className="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center text-blue-500 mb-4">
                                <Icon name="Barcode" size={48}/>
                            </div>
                            <h3 className="text-xl font-bold text-slate-700">Scansiona Prodotto</h3>
                            <input value={barcode} onChange={e => setBarcode(e.target.value)} onKeyDown={handleScan} className="border-b-2 border-slate-300 text-3xl text-center py-2 focus:border-blue-500 outline-none font-mono" placeholder="Barcode..." autoFocus />
                            <div className="grid grid-cols-2 gap-4 mt-8 w-full max-w-md">
                                <div className="bg-green-50 p-6 rounded-2xl border border-green-100 text-green-700">
                                    <div className="font-bold mb-2">CARICO RAPIDO</div>
                                    <p className="text-xs">Aggiungi stock velocemente senza dettagli lotti.</p>
                                </div>
                                <div className="bg-red-50 p-6 rounded-2xl border border-red-100 text-red-700">
                                    <div className="font-bold mb-2">RETTIFICA / SCARTO</div>
                                    <p className="text-xs">Rimuovi prodotti per avaria, rottura o uso interno.</p>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="max-w-xl mx-auto w-full bg-white p-8 rounded-3xl shadow-xl border border-slate-100">
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <h3 className="text-2xl font-bold text-slate-800">{selectedProduct.name}</h3>
                                    <p className="text-slate-400 font-mono">{selectedProduct.code}</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-sm text-slate-500">Stock Attuale</p>
                                    <p className="text-2xl font-bold text-blue-600">{selectedProduct.stock} {selectedProduct.isWeighable ? 'kg' : 'pz'}</p>
                                </div>
                            </div>

                            {!mode ? (
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => setMode('load')} className="py-6 bg-green-50 hover:bg-green-100 border border-green-200 rounded-xl text-green-700 font-bold flex flex-col items-center gap-2 transition-all">
                                        <Icon name="Plus" size={32}/> CARICO STOCK
                                    </button>
                                    <button onClick={() => setMode('waste')} className="py-6 bg-red-50 hover:bg-red-100 border border-red-200 rounded-xl text-red-700 font-bold flex flex-col items-center gap-2 transition-all">
                                        <Icon name="Trash" size={32}/> SCARICO / SFRIDO
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-6 animate-in fade-in">
                                    <div className={`p-4 rounded-xl text-center font-bold ${mode === 'load' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                        {mode === 'load' ? 'NUOVO ARRIVO MERCE' : 'REGISTRAZIONE SCARTO'}
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold text-slate-500 mb-2">Quantità ({selectedProduct.isWeighable ? 'Kg' : 'Pezzi'})</label>
                                        <input type="number" value={quantity} onChange={e => setQuantity(e.target.value)} className="w-full text-center text-4xl font-bold border-b-2 border-slate-200 focus:border-blue-500 outline-none py-2" autoFocus />
                                    </div>

                                    {mode === 'waste' && (
                                        <div>
                                            <label className="block text-sm font-bold text-slate-500 mb-2">Motivazione</label>
                                            <select value={reason} onChange={e => setReason(e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none">
                                                <option>Avaria / Marcio</option>
                                                <option>Rottura</option>
                                                <option>Scaduto</option>
                                                <option>Consumo Interno</option>
                                                <option>Furto</option>
                                                <option>Inventario Errato</option>
                                            </select>
                                        </div>
                                    )}

                                    <div className="flex gap-4 pt-4">
                                        <button onClick={() => { setMode(null); setQuantity(""); }} className="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold rounded-xl">Annulla</button>
                                        <button onClick={handleConfirm} className="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl">Conferma</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const InventoryView = ({ products, onUpdate, onCreate, onDelete, refresh, categories, addCat, delCat }) => {
            const [search, setSearch] = useState(""); 
            const [editItem, setEditItem] = useState(null); 
            const [isNew, setIsNew] = useState(false); 
            const [offerItem, setOfferItem] = useState(null);
            const [printMode, setPrintMode] = useState(false); 
            const [categoryFilter, setCategoryFilter] = useState("Tutte");

            // Stato locale per gestire l'aggiunta di un nuovo lotto nel modal
            // Aggiunti campi fornitore e costo d'acquisto specifico
            const [newBatch, setNewBatch] = useState({ qty: "", expiry: "", cost: "", supplier: "" });

            const filtered = products.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) || p.code.includes(search));
            const generateCode = () => setEditItem(prev => ({ ...prev, code: `200${Math.floor(10000 + Math.random() * 90000)}` }));
            
            // Inizializza editItem con batches se non esistono (migrazione live)
            const prepareEdit = (p) => {
                const item = { ...p };
                if (!item.batches) {
                    item.batches = [];
                    // Se c'è stock legacy, crea un lotto fittizio con costo legacy
                    if (item.stock > 0) {
                        item.batches.push({
                            id: Date.now(),
                            stock: item.stock,
                            expiryDate: item.expiryDate || "",
                            cost: item.cost || 0, // Costo storico
                            supplier: "Magazzino Pregresso"
                        });
                    }
                }
                setEditItem(item);
                setIsNew(false);
                setNewBatch({ qty: "", expiry: "", cost: "", supplier: "" });
            };

            const addBatchToEditItem = () => {
                if(!newBatch.qty || parseFloat(newBatch.qty) <= 0) return alert("Inserisci una quantità valida");
                const batch = {
                    id: Date.now() + Math.random(), // ID unico
                    stock: parseFloat(newBatch.qty),
                    expiryDate: newBatch.expiry,
                    cost: parseFloat(newBatch.cost) || 0, // Costo specifico lotto
                    supplier: newBatch.supplier || "Generico"
                };
                setEditItem(prev => ({
                    ...prev,
                    batches: [...(prev.batches || []), batch]
                }));
                setNewBatch({ qty: "", expiry: "", cost: "", supplier: "" });
            };

            const removeBatch = (id) => {
                setEditItem(prev => ({
                    ...prev,
                    batches: prev.batches.filter(b => b.id !== id)
                }));
            };

            const handleSave = (e) => {
                e.preventDefault();
                
                // Calcola il totale stock dai lotti
                const currentBatches = editItem.batches || [];
                const totalStock = currentBatches.reduce((acc, b) => acc + (parseFloat(b.stock) || 0), 0);
                
                // Trova la scadenza più vicina per il campo legacy (visualizzazione)
                const activeBatches = currentBatches.filter(b => b.stock > 0 && b.expiryDate);
                activeBatches.sort((a,b) => a.expiryDate.localeCompare(b.expiryDate));
                const nearestExpiry = activeBatches.length > 0 ? activeBatches[0].expiryDate : "";

                // Calcolo costo medio ponderato (solo per riferimento visivo, non contabile)
                let totalVal = 0;
                let totalQty = 0;
                currentBatches.forEach(b => {
                    totalVal += (b.stock * b.cost);
                    totalQty += b.stock;
                });
                const weightedCost = totalQty > 0 ? (totalVal / totalQty) : (editItem.cost || 0);

                const productToSave = {
                    ...editItem,
                    stock: totalStock,
                    expiryDate: nearestExpiry, 
                    cost: weightedCost, // Aggiorna costo medio indicativo
                    batches: currentBatches,
                    taxRate: parseFloat(editItem.taxRate) || 22 // Salva aliquota IVA
                };

                if (isNew) onCreate(productToSave);
                else onUpdate(productToSave);
                
                setEditItem(null);
            };

            return (
                <div className="h-full flex flex-col p-6 gap-6">
                    <div className="flex justify-between gap-4">
                        <div className="flex items-center gap-3 bg-white px-5 py-3 rounded-xl shadow-sm border border-slate-200 flex-1 transition-all focus-within:border-blue-500 focus-within:ring-4 focus-within:ring-blue-500/10">
                            <Icon name="Search" className="text-slate-400"/><input value={search} onChange={e => setSearch(e.target.value)} placeholder="Cerca prodotto..." className="bg-transparent outline-none flex-1 font-medium" />
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setPrintMode(!printMode)} className={`px-4 py-2 rounded-xl font-bold flex gap-2 items-center transition-colors ${printMode ? 'bg-purple-600 text-white' : 'bg-white border border-purple-200 text-purple-600 hover:bg-purple-50'}`}>
                                <Icon name="Printer"/> {printMode ? 'Chiudi Stampe' : 'Centro Stampe'}
                            </button>
                            <button onClick={refresh} className="bg-slate-200 hover:bg-slate-300 text-slate-600 px-4 py-2 rounded-xl font-bold flex gap-2 items-center"><Icon name="Refresh"/> Aggiorna</button>
                            <button onClick={() => { 
                                setEditItem({ code: "", name: "", price: "", cost: "", stock: 0, isWeighable: false, category: "", expiryDate: "", batches: [], taxRate: 22 }); 
                                setIsNew(true); 
                                setNewBatch({ qty: "", expiry: "", cost: "", supplier: "" });
                            }} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-blue-900/20 transition-transform active:scale-95"><Icon name="Plus"/> Nuovo</button>
                        </div>
                    </div>

                    {printMode && (
                        <div className="bg-purple-50 p-6 rounded-2xl border border-purple-200 animate-in fade-in slide-in-from-top-4">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-lg text-purple-800 flex items-center gap-2"><Icon name="Printer"/> Centro Stampe</h3>
                                <button onClick={() => printReport(products, categoryFilter)} className="bg-purple-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg hover:bg-purple-500">STAMPA ETICHETTE BARCODE</button>
                            </div>
                            <div className="flex gap-2 overflow-x-auto pb-2">
                                <button onClick={() => setCategoryFilter("Tutte")} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap ${categoryFilter === "Tutte" ? 'bg-purple-600 text-white' : 'bg-white text-purple-600 border border-purple-200'}`}>Tutte</button>
                                {categories.map(cat => (
                                    <button key={cat.id} onClick={() => setCategoryFilter(cat.name)} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap ${categoryFilter === cat.name ? 'bg-purple-600 text-white' : 'bg-white text-purple-600 border border-purple-200'}`}>
                                        {cat.name}
                                    </button>
                                ))}
                            </div>
                            <p className="text-xs text-purple-400 mt-2">Seleziona una categoria per stampare i barcode relativi.</p>
                        </div>
                    )}

                    {!printMode && (
                        <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="grid grid-cols-12 bg-slate-50 p-4 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200">
                                <div className="col-span-3">Prodotto</div>
                                <div className="col-span-2">Categoria</div>
                                <div className="col-span-2">Prox Scadenza</div>
                                <div className="col-span-2">Giacenza Tot</div>
                                <div className="col-span-1 text-right">Prezzo</div>
                                <div className="col-span-2 text-center">Azioni</div>
                            </div>
                            <div className="overflow-y-auto h-full pb-10">
                                {filtered.map(p => {
                                    const nearestExp = getNearestExpiry(p);
                                    const expiry = getExpiryStatus(nearestExp);
                                    return (
                                        <div key={p.code} className="grid grid-cols-12 p-4 border-b border-slate-100 items-center hover:bg-blue-50/50 transition-colors group">
                                            <div className="col-span-3">
                                                <div className="font-bold text-slate-800 flex items-center gap-2">
                                                    {p.name}
                                                    {expiry && expiry.icon === 'Alert' && <Icon name={expiry.icon} size={16} className={`${expiry.color}`} />}
                                                </div>
                                                <div className="text-xs text-slate-400 flex gap-2 mt-1 items-center">
                                                    <span className="font-mono bg-slate-100 px-1.5 py-0.5 rounded">{p.code}</span>
                                                    {p.isWeighable && <span className="bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded font-bold">PESO</span>}
                                                    {p.originalPrice && <span className="text-[10px] bg-red-100 text-red-600 px-1 rounded">OFFERTA</span>}
                                                </div>
                                            </div>
                                            <div className="col-span-2">
                                                <span className="text-xs font-bold bg-slate-100 text-slate-600 px-2 py-1 rounded-full">{p.category || "Generale"}</span>
                                            </div>
                                            <div className="col-span-2">
                                                {nearestExp ? (
                                                    <span className={`text-xs font-bold px-2 py-1 rounded-full ${expiry.bg} ${expiry.color}`}>{nearestExp}</span>
                                                ) : (
                                                    <span className="text-xs text-slate-400">-</span>
                                                )}
                                            </div>
                                            <div className="col-span-2">
                                                <span className={`text-sm font-mono font-bold ${p.stock < 5 ? 'text-red-500' : 'text-slate-700'}`}>{p.stock} {p.isWeighable ? 'kg' : 'pz'}</span>
                                            </div>
                                            <div className="col-span-1 text-right font-mono font-bold text-slate-700">€{parseFloat(p.price).toFixed(2)}</div>
                                            <div className="col-span-2 flex justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onClick={() => printLabel(p)} className="p-2 hover:bg-white hover:shadow text-slate-500 rounded-lg"><Icon name="Barcode" size={16}/></button>
                                                <button onClick={() => prepareEdit(p)} className="p-2 hover:bg-white hover:shadow text-blue-600 rounded-lg"><Icon name="Edit" size={16}/></button>
                                                <button onClick={() => onDelete(p.code)} className="p-2 hover:bg-white hover:shadow text-red-500 rounded-lg"><Icon name="Trash" size={16}/></button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                    
                    {editItem && <Modal title={isNew ? "Nuovo Prodotto" : "Modifica / Gestione Lotti"} onClose={() => setEditItem(null)}>
                        <form onSubmit={handleSave} className="space-y-5">
                            <div className="flex gap-3 items-end">
                                <div className="flex-1 space-y-1"><label className="text-xs font-bold text-slate-500 uppercase">Barcode</label><input value={editItem.code} onChange={e => setEditItem({...editItem, code: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl font-mono focus:border-blue-500 outline-none" required disabled={!isNew} placeholder="Scan..." /></div>
                                {isNew && <button type="button" onClick={generateCode} className="bg-slate-100 hover:bg-slate-200 text-slate-600 p-3.5 rounded-xl font-bold text-xs transition-colors">GENERA</button>}
                            </div>
                            <div className="space-y-1"><label className="text-xs font-bold text-slate-500 uppercase">Nome</label><input value={editItem.name} onChange={e => setEditItem({...editItem, name: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl focus:border-blue-500 outline-none" required /></div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-1">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Categoria</label>
                                    <input list="cat-list" value={editItem.category || ""} onChange={e => setEditItem({...editItem, category: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl focus:border-blue-500 outline-none" placeholder="Generale"/>
                                    <datalist id="cat-list">
                                        {categories.map(c => <option key={c.id} value={c.name}/>)}
                                    </datalist>
                                </div>
                                <div className="space-y-1">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Aliquota IVA (%)</label>
                                    <select value={editItem.taxRate || 22} onChange={e => setEditItem({...editItem, taxRate: parseInt(e.target.value)})} className="w-full border border-slate-300 p-3 rounded-xl focus:border-blue-500 outline-none bg-white">
                                        <option value="4">4% (Prima necessità)</option>
                                        <option value="5">5% (Alimentari spec.)</option>
                                        <option value="10">10% (Turismo/Rist.)</option>
                                        <option value="22">22% (Ordinaria)</option>
                                    </select>
                                </div>
                            </div>

                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-3">
                                <h4 className="font-bold text-sm text-slate-700 flex items-center gap-2"><Icon name="Box" size={16}/> Gestione Lotti & Fornitori</h4>
                                
                                <div className="flex gap-2 items-end mb-2">
                                    <div className="space-y-1 w-20">
                                        <label className="text-[9px] font-bold text-slate-500 uppercase">Qtà</label>
                                        <input type="number" value={newBatch.qty} onChange={e => setNewBatch({...newBatch, qty: e.target.value})} className="w-full border p-2 rounded-lg text-sm" placeholder="0" />
                                    </div>
                                    <div className="space-y-1 flex-1">
                                        <label className="text-[9px] font-bold text-slate-500 uppercase">Fornitore</label>
                                        <input type="text" value={newBatch.supplier} onChange={e => setNewBatch({...newBatch, supplier: e.target.value})} className="w-full border p-2 rounded-lg text-sm" placeholder="Nome..." />
                                    </div>
                                    <div className="space-y-1 w-24">
                                        <label className="text-[9px] font-bold text-slate-500 uppercase">Costo Unit</label>
                                        <input type="number" step="0.01" value={newBatch.cost} onChange={e => setNewBatch({...newBatch, cost: e.target.value})} className="w-full border p-2 rounded-lg text-sm" placeholder="€" />
                                    </div>
                                </div>
                                <div className="flex gap-2 items-end border-b border-slate-200 pb-4">
                                    <div className="space-y-1 flex-1">
                                        <label className="text-[9px] font-bold text-slate-500 uppercase">Scadenza</label>
                                        <input type="date" value={newBatch.expiry} onChange={e => setNewBatch({...newBatch, expiry: e.target.value})} className="w-full border p-2 rounded-lg text-sm" />
                                    </div>
                                    <button type="button" onClick={addBatchToEditItem} className="bg-green-600 text-white p-2.5 rounded-lg hover:bg-green-700">
                                        <Icon name="Plus" size={18}/> Aggiungi Lotto
                                    </button>
                                </div>

                                <div className="space-y-2 max-h-40 overflow-y-auto pr-1">
                                    {(editItem.batches && editItem.batches.length > 0) ? editItem.batches.map(b => (
                                        <div key={b.id} className="flex justify-between items-center bg-white border border-slate-200 p-2 rounded-lg text-xs">
                                            <div className="flex flex-col">
                                                <span className="font-bold text-slate-700">{b.supplier || "N/D"}</span>
                                                <span className="text-slate-400">Scad: {b.expiryDate || "-"}</span>
                                            </div>
                                            <div className="flex gap-4 items-center">
                                                <span className="font-mono bg-slate-100 px-2 py-1 rounded">Costo: €{parseFloat(b.cost).toFixed(2)}</span>
                                                <span className="font-mono font-bold">{b.stock} pz</span>
                                                <button type="button" onClick={() => removeBatch(b.id)} className="text-red-400 hover:text-red-600"><Icon name="Trash" size={14}/></button>
                                            </div>
                                        </div>
                                    )) : (
                                        <p className="text-xs text-slate-400 text-center italic">Nessun lotto inserito</p>
                                    )}
                                </div>
                                
                                <div className="text-right text-xs text-slate-500 font-bold border-t border-slate-200 pt-2">
                                    Totale Stock: {editItem.batches ? editItem.batches.reduce((a,b)=>a+(parseFloat(b.stock)||0), 0) : 0}
                                </div>
                            </div>

                            <label className="flex items-center gap-3 p-4 border border-orange-200 bg-orange-50 rounded-xl cursor-pointer hover:bg-orange-100 transition-colors">
                                <input type="checkbox" checked={editItem.isWeighable} onChange={e => setEditItem({...editItem, isWeighable: e.target.checked})} className="w-5 h-5 accent-orange-500"/>
                                <div className="text-sm font-bold text-orange-800 flex items-center"><Icon name="Scale" size={18} className="mr-2"/> Vendita a Peso (Bilancia)</div>
                            </label>
                            
                            <div className="space-y-1">
                                <label className="text-[10px] font-bold text-slate-500 uppercase">Prezzo Vendita (Ivato)</label>
                                <input type="number" step="0.01" value={editItem.price} onChange={e => setEditItem({...editItem, price: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl font-bold text-blue-600 text-lg" required />
                            </div>
                            
                            <button className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-900/20 hover:bg-blue-500 transition-all">
                                Salva Prodotto
                            </button>
                        </form>
                    </Modal>}
                    
                    {offerItem && <Modal title="Applica Offerta" onClose={() => setOfferItem(null)}><div className="space-y-4"><div className="bg-slate-50 p-4 rounded-xl"><h4 className="font-bold">{offerItem.name}</h4><p className="text-sm">Prezzo attuale: <span className="font-mono font-bold">€{parseFloat(offerItem.price).toFixed(2)}</span></p></div><div className="grid grid-cols-3 gap-2"><button onClick={() => setOfferItem({...offerItem, newPrice: (offerItem.price * 0.9).toFixed(2)})} className="p-2 border rounded-lg hover:bg-slate-50">-10%</button><button onClick={() => setOfferItem({...offerItem, newPrice: (offerItem.price * 0.8).toFixed(2)})} className="p-2 border rounded-lg hover:bg-slate-50">-20%</button><button onClick={() => setOfferItem({...offerItem, newPrice: (offerItem.price * 0.5).toFixed(2)})} className="p-2 border rounded-lg hover:bg-slate-50">-50%</button></div><div><label className="text-xs font-bold text-slate-500 uppercase">Nuovo Prezzo</label><input type="number" step="0.01" value={offerItem.newPrice || ""} onChange={e => setOfferItem({...offerItem, newPrice: e.target.value})} className="w-full border-2 border-orange-400 p-3 rounded-lg text-2xl font-bold text-orange-600 text-center" placeholder="€ 0.00" /></div><div className="flex gap-2 pt-4"><button onClick={() => { const original = offerItem.originalPrice || offerItem.price; onUpdate({ ...offerItem, price: original, originalPrice: null }); setOfferItem(null); }} className="flex-1 bg-slate-200 text-slate-700 py-3 rounded-xl font-bold">Rimuovi Offerta</button><button onClick={() => { if(!offerItem.newPrice) return; const original = offerItem.originalPrice || offerItem.price; onUpdate({ ...offerItem, price: offerItem.newPrice, originalPrice: original }); setOfferItem(null); }} className="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold">Applica</button></div></div></Modal>}
                </div>
            );
        };

        const HistoryView = ({ config, onDelete, products, onRestoreStock }) => {
            const [logs, setLogs] = useState([]);
            useEffect(() => { DataAdapter.getLogs(config).then(setLogs); }, [config]);

            const handleDelete = async (log) => {
                if(confirm("Sei sicuro di voler annullare questa transazione? Lo stock verrà ripristinato.")) {
                    try {
                        // 1. Restore Stock Logic
                        await onRestoreStock(log);
                        
                        // 2. Delete Log
                        await onDelete(log.id);
                        setLogs(prev => prev.filter(l => l.id !== log.id));
                    } catch(e) {
                        alert("Errore durante l'annullamento: " + e.message);
                    }
                }
            };

            return (
                <div className="h-full flex flex-col p-6 overflow-hidden">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3"><Icon name="List" size={28}/> Storico Vendite</h2>
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col">
                        <div className="overflow-y-auto flex-1">
                            <table className="w-full text-left">
                                <thead className="bg-slate-50 text-slate-500 text-xs uppercase font-bold sticky top-0">
                                    <tr>
                                        <th className="px-6 py-4">Data</th>
                                        <th className="px-6 py-4">ID Transazione</th>
                                        <th className="px-6 py-4">Articoli</th>
                                        <th className="px-6 py-4">Totale</th>
                                        <th className="px-6 py-4 text-right">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {logs.map(log => (
                                        <tr key={log.id} className="hover:bg-slate-50">
                                            <td className="px-4 py-3 text-sm text-slate-600">{new Date(log.date).toLocaleString()}</td>
                                            <td className="px-4 py-3 text-sm font-mono">{log.id.toString().slice(-8)}</td>
                                            <td className="px-4 py-3 text-sm">{log.items.length} articoli</td>
                                            <td className="px-4 py-3 font-bold text-slate-800">€{log.total.toFixed(2)}</td>
                                            <td className="px-4 py-3 text-right flex justify-end gap-2">
                                                <button onClick={() => printReceipt(log, config)} className="p-2 hover:bg-blue-50 text-blue-600 rounded-lg"><Icon name="Printer" size={16}/></button>
                                                <button onClick={() => handleDelete(log)} className="p-2 hover:bg-red-50 text-red-600 rounded-lg"><Icon name="Trash" size={16}/></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPANY DATA MODAL ---
        const CompanyModal = ({ config, onSave, onClose }) => {
            const [data, setData] = useState({
                address: config.address || "",
                piva: config.piva || "",
                phone: config.phone || "",
                email: config.email || "",
                receiptFooter: config.receiptFooter || "Grazie e Arrivederci!"
            });

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden p-6 space-y-4">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="font-bold text-lg text-slate-800">Dati Aziendali (Scontrino)</h3>
                            <button onClick={onClose}><Icon name="X" size={20}/></button>
                        </div>
                        <div><label className="text-xs font-bold text-slate-500">Indirizzo Completo</label><input value={data.address} onChange={e => setData({...data, address: e.target.value})} className="w-full border p-2 rounded-lg" placeholder="Via Roma 1, Milano"/></div>
                        <div><label className="text-xs font-bold text-slate-500">P.IVA / Cod. Fiscale</label><input value={data.piva} onChange={e => setData({...data, piva: e.target.value})} className="w-full border p-2 rounded-lg" placeholder="IT12345678901"/></div>
                        <div><label className="text-xs font-bold text-slate-500">Telefono</label><input value={data.phone} onChange={e => setData({...data, phone: e.target.value})} className="w-full border p-2 rounded-lg" placeholder="02 1234567"/></div>
                        <div><label className="text-xs font-bold text-slate-500">Messaggio Scontrino</label><input value={data.receiptFooter} onChange={e => setData({...data, receiptFooter: e.target.value})} className="w-full border p-2 rounded-lg" placeholder="Grazie e Arrivederci!"/></div>
                        <button onClick={() => onSave(data)} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Salva Dati</button>
                    </div>
                </div>
            );
        };

        const SettingsView = ({ config, setConfig, serverStatus, categories, addCat, delCat, onMigrate }) => {
            const [scalePort, setScalePort] = useState("");
            const [scaleBaud, setScaleBaud] = useState(9600);
            const [showCompanyModal, setShowCompanyModal] = useState(false);

            useEffect(() => {
                if(config.storageMode !== 'local') {
                    DataAdapter.getScaleConfig(config).then(c => {
                        if(c.port) setScalePort(c.port);
                        if(c.baudrate) setScaleBaud(c.baudrate);
                    });
                }
            }, []);

            const saveScale = async () => {
                try {
                    await DataAdapter.setScaleConfig(config, scalePort, scaleBaud);
                    alert("Configurazione Bilancia Salvata");
                } catch(e) {
                    alert(e.message);
                }
            };
            
            const handleSaveCompany = (data) => {
                setConfig({ ...config, ...data });
                setShowCompanyModal(false);
            };

            return (
                <div className="max-w-2xl mx-auto p-8 flex flex-col lg:flex-row gap-6 h-full overflow-y-auto">
                    <div className="flex-1 space-y-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <h2 className="text-xl font-bold text-slate-800 mb-4">Generale</h2>
                            <div className="mb-4"><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Nome Negozio</label><input type="text" value={config.shopName} onChange={e => setConfig({...config, shopName: e.target.value})} className="w-full border p-3 rounded-xl outline-none focus:border-blue-500 font-bold text-slate-700" /></div>
                            <button onClick={() => setShowCompanyModal(true)} className="w-full py-3 bg-blue-50 text-blue-600 font-bold rounded-xl border border-blue-100 hover:bg-blue-100 transition-colors">Modifica Anagrafica Azienda</button>
                        </div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="Settings" className="text-slate-400"/> Configurazione Database</h2><div className="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-200 mb-6"><span className="text-sm text-slate-500 font-medium">Stato Connessione</span><span className={`font-bold px-3 py-1 rounded-full text-xs ${serverStatus === 'online' ? 'bg-green-100 text-green-700' : serverStatus === 'local' ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}`}>{serverStatus === 'online' ? 'CONNESSO' : serverStatus === 'local' ? 'LOCALE' : 'OFFLINE'}</span></div><label className="block text-xs font-bold text-slate-400 uppercase mb-2">Modalità di Archiviazione</label><div className="grid grid-cols-3 gap-2 mb-6">{['local', 'server', 'firebase'].map(mode => (<button key={mode} onClick={() => setConfig({...config, storageMode: mode})} className={`p-3 rounded-xl border text-xs font-bold transition-all flex flex-col items-center gap-2 ${config.storageMode === mode ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}><Icon name={mode === 'local' ? 'Box' : mode === 'server' ? 'Server' : 'Cloud'} size={20}/>{mode.toUpperCase()}</button>))}</div>{config.storageMode === 'server' && (<div className="animate-in fade-in slide-in-from-top-2"><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Indirizzo Server Locale (Python)</label><input type="text" value={config.serverUrl} onChange={e => setConfig({...config, serverUrl: e.target.value})} className="w-full border p-3 rounded-xl font-mono text-sm outline-none focus:border-blue-500" placeholder="http://127.0.0.1:5500" /></div>)}{config.storageMode === 'firebase' && (<div className="animate-in fade-in slide-in-from-top-2 space-y-4"><div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Configurazione Firebase (JSON)</label><textarea className="w-full border p-3 rounded-xl text-xs font-mono h-48 outline-none focus:border-orange-500 resize-y" placeholder='{ "apiKey": "...", "authDomain": "..." }' value={typeof config.firebaseConfig === 'object' ? JSON.stringify(config.firebaseConfig, null, 2) : config.firebaseConfig || ''} onChange={e => { try { const parsed = JSON.parse(e.target.value); setConfig({...config, firebaseConfig: parsed}); if(window.FB && window.FB.init(parsed)) alert("Firebase Connesso!"); } catch(err) { setConfig({...config, firebaseConfig: e.target.value}); } }} /><p className="text-[10px] text-slate-400 mt-2 leading-relaxed">Vai sulla Console Firebase &gt; Impostazioni Progetto &gt; Generali &gt; Le tue app &gt; Configurazione. Copia l'oggetto JSON e incollalo qui.</p></div><button onClick={onMigrate} className="w-full py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 transition-all"><Icon name="Cloud" /> 📤 CARICA DATI LOCALI SU CLOUD</button></div>)}</div>
                        
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="Scale" className="text-slate-400"/> Periferiche (Bilancia)</h2>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Porta Seriale</label><input placeholder="es. COM3 o /dev/ttyUSB0" value={scalePort} onChange={e => setScalePort(e.target.value)} className="w-full border p-3 rounded-xl outline-none focus:border-blue-500 font-mono text-sm"/></div>
                                <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Baud Rate</label><input type="number" value={scaleBaud} onChange={e => setScaleBaud(parseInt(e.target.value))} className="w-full border p-3 rounded-xl outline-none focus:border-blue-500 font-mono text-sm"/></div>
                            </div>
                            <button onClick={saveScale} className="w-full py-3 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-700 transition-colors">Salva Configurazione Bilancia</button>
                        </div>
                    </div>
                    <div className="w-full lg:w-80 shrink-0"><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 h-full flex flex-col"><h3 className="font-bold text-lg mb-4 text-slate-700">Categorie</h3><div className="flex gap-2 mb-4"><input id="newCat" placeholder="Nuova..." className="w-full border p-2 rounded-lg text-sm outline-none focus:border-blue-500"/><button onClick={() => { const el=document.getElementById('newCat'); if(el.value) { addCat(el.value); el.value=''; }}} className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700"><Icon name="Plus" size={16}/></button></div><div className="flex-1 overflow-y-auto space-y-2 max-h-96 lg:max-h-none pr-1">{categories.map(c => (<div key={c.id} className="flex justify-between items-center p-3 bg-slate-50 rounded-lg text-sm group hover:bg-slate-100 transition-colors"><span className="font-medium text-slate-700">{c.name}</span><button onClick={() => delCat(c.id)} className="text-slate-400 hover:text-red-500 transition-colors"><Icon name="Trash" size={14}/></button></div>))}</div></div></div>
                    {showCompanyModal && <CompanyModal config={config} onSave={handleSaveCompany} onClose={() => setShowCompanyModal(false)} />}
                </div>
            );
        };

        const DashboardView = ({ config, refreshTrigger, products }) => {
            const [stats, setStats] = useState({ dailyTotal: 0, dailyProfit: 0, totalTx: 0, weeklyData: [], totalNet: 0, totalTax: 0 }); 
            const [loading, setLoading] = useState(true);
            const [logs, setLogs] = useState([]);
            
            // MISSING STATE VARIABLES FOR EXPIRY MODAL (FIXED)
            const [expiryModal, setExpiryModal] = useState(false);
            const [expiryFilter, setExpiryFilter] = useState('all');

            // AI Chat State
            const [chatOpen, setChatOpen] = useState(false);
            const [chatInput, setChatInput] = useState("");
            const [chatMessages, setChatMessages] = useState([
                { id: 1, from: 'ai', type: 'text', content: "Ciao! Sono il tuo assistente. Chiedimi 'quante mele ho venduto oggi', 'andamento vendite' o 'stock coca cola'." }
            ]);
            const messagesEndRef = useRef(null);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatMessages]);

            useEffect(() => { 
                const loadStats = async () => { 
                    setLoading(true); 
                    try { 
                        const fetchedLogs = await DataAdapter.getLogs(config);
                        setLogs(fetchedLogs); 
                        const today = new Date().toISOString().split('T')[0]; 
                        const todayLogs = fetchedLogs.filter(l => l.date.startsWith(today)); 
                        
                        const dailyTotal = todayLogs.reduce((acc, l) => acc + l.total, 0); 
                        const dailyNet = todayLogs.reduce((acc, l) => acc + (l.netTotal || (l.total/1.22)), 0); 
                        const dailyTax = dailyTotal - dailyNet;
                        const totalTx = todayLogs.length; 
                        let dailyProfit = 0; 
                        
                        todayLogs.forEach(log => { 
                            if (log.totalCost) {
                                const netRevenue = log.netTotal || (log.total / 1.22);
                                dailyProfit += (netRevenue - log.totalCost);
                            } else {
                                log.items.forEach(item => { 
                                    const cost = item.cost || 0; 
                                    dailyProfit += ((item.price/1.22) - cost) * item.qty; 
                                }); 
                            }
                        }); 

                        const last7Days = [...Array(7)].map((_, i) => { const d = new Date(); d.setDate(d.getDate() - i); return d.toISOString().split('T')[0]; }).reverse(); 
                        const weeklyData = last7Days.map(date => { 
                            const dayLogs = fetchedLogs.filter(l => l.date.startsWith(date)); 
                            const dayTotal = dayLogs.reduce((acc, l) => acc + l.total, 0); 
                            let dayProfit = 0; 
                            dayLogs.forEach(log => {
                                if (log.totalCost) {
                                    dayProfit += ((log.netTotal) - log.totalCost);
                                } else {
                                    log.items.forEach(item => { 
                                        dayProfit += ((item.price/1.22) - (item.cost || 0)) * item.qty; 
                                    });
                                }
                            });
                            const dateLabel = date.split('-')[2] + '/' + date.split('-')[1]; 
                            return { name: dateLabel, vendite: dayTotal, profitto: dayProfit }; 
                        }); 
                        setStats({ dailyTotal, dailyProfit, totalTx, weeklyData, totalNet: dailyNet, totalTax: dailyTax }); 
                    } catch (e) { console.error(e); } 
                    setLoading(false); 
                }; 
                loadStats(); 
            }, [refreshTrigger, config]);

            const handleSendMessage = (e) => {
                e.preventDefault();
                if(!chatInput.trim()) return;
                const userMsg = { id: Date.now(), from: 'user', type: 'text', content: chatInput };
                setChatMessages(prev => [...prev, userMsg]);
                const brain = new MarketBrain(products, logs);
                const response = brain.parseQuery(chatInput);
                setTimeout(() => {
                    const aiMsg = { id: Date.now() + 1, from: 'ai', type: response.type, content: response.message, data: response.data };
                    setChatMessages(prev => [...prev, aiMsg]);
                }, 500);
                setChatInput("");
            };
            
            const renderCharts = () => { if (!window.Recharts) return <div className="flex items-center justify-center h-full text-slate-400">Caricamento Grafici...</div>; const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = window.Recharts; return (<ResponsiveContainer width="100%" height="100%"><AreaChart data={stats.weeklyData}><defs><linearGradient id="colorVendite" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#3b82f6" stopOpacity={0.8}/><stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/></linearGradient><linearGradient id="colorProfitto" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#10b981" stopOpacity={0.8}/><stop offset="95%" stopColor="#10b981" stopOpacity={0}/></linearGradient></defs><XAxis dataKey="name" stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} /><YAxis stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} tickFormatter={(val) => `€${val}`}/><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" /><Tooltip contentStyle={{borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)'}} /><Area type="monotone" dataKey="vendite" stroke="#3b82f6" strokeWidth={3} fillOpacity={1} fill="url(#colorVendite)" name="Incasso" /><Area type="monotone" dataKey="profitto" stroke="#10b981" strokeWidth={3} fillOpacity={1} fill="url(#colorProfitto)" name="Utile" /></AreaChart></ResponsiveContainer>); };
            
            const renderMiniChart = (data) => {
                 const { BarChart, Bar, XAxis, Tooltip, ResponsiveContainer } = window.Recharts;
                 return (
                     <div className="h-64 w-full mt-4 bg-white rounded-xl p-4 shadow-sm border border-slate-100">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={data}>
                                <XAxis dataKey="name" />
                                <Tooltip cursor={{fill: 'transparent'}} />
                                <Bar dataKey="value" fill="#3b82f6" radius={[4,4,0,0]} />
                            </BarChart>
                        </ResponsiveContainer>
                     </div>
                 );
            };

            const getExpiringBatches = () => {
                const today = new Date();
                let allBatches = [];
                products.forEach(p => {
                    const batches = p.batches || [{expiryDate: p.expiryDate, stock: p.stock}];
                    batches.forEach(b => {
                        if(b.expiryDate && b.stock > 0) {
                            allBatches.push({ code: p.code, name: p.name, expiryDate: b.expiryDate, stock: b.stock || b.qty });
                        }
                    });
                });
                return allBatches.filter(b => {
                    const d = new Date(b.expiryDate);
                    const diffTime = d - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if(expiryFilter === 'expired') return diffDays < 0;
                    if(expiryFilter === 'thisMonth') return d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear() && diffDays >= 0;
                    if(expiryFilter === 'next3Months') { const future = new Date(); future.setMonth(today.getMonth() + 3); return d > today && d <= future; }
                    return true;
                }).sort((a,b) => new Date(a.expiryDate) - new Date(b.expiryDate));
            };

            return (
                <div className="h-full relative overflow-hidden">
                    <div className="h-full flex flex-col gap-6 p-8 overflow-y-auto">
                        <div className="flex justify-between items-center"><h2 className="text-3xl font-bold text-slate-800">Dashboard Finanziaria</h2><div className="text-sm text-slate-500 font-mono">{new Date().toLocaleDateString()}</div></div>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="DollarSign" size={60} className="text-green-500"/></div><span className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Incasso Lordo</span><span className="text-3xl font-bold text-slate-800">€{stats.dailyTotal.toFixed(2)}</span></div>
                            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="Tag" size={60} className="text-blue-500"/></div><span className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Imponibile Netto</span><span className="text-3xl font-bold text-blue-700">€{stats.totalNet.toFixed(2)}</span><span className="text-[10px] text-slate-400">Escluso IVA</span></div>
                            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex-col flex relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="Scale" size={60} className="text-purple-500"/></div><span className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">IVA da Versare</span><span className="text-3xl font-bold text-purple-700">€{stats.totalTax.toFixed(2)}</span></div>
                            <div className="bg-gradient-to-br from-emerald-500 to-emerald-700 p-6 rounded-3xl shadow-lg shadow-emerald-900/20 flex flex-col text-white relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-20"><Icon name="PieChart" size={60} className="text-white"/></div><span className="text-xs font-bold text-emerald-100 uppercase tracking-wider mb-1">Margine Operativo</span><span className="text-3xl font-bold">€{stats.dailyProfit.toFixed(2)}</span><div className="mt-2 text-[10px] font-bold text-emerald-200 bg-white/10 w-fit px-2 py-1 rounded-lg">Su Imponibile: {stats.totalNet > 0 ? ((stats.dailyProfit/stats.totalNet)*100).toFixed(1) : 0}%</div></div>
                        </div>
                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex-1 min-h-[300px] flex flex-col"><h3 className="font-bold text-lg text-slate-700 mb-6 flex items-center gap-2"><Icon name="TrendingUp"/> Andamento Settimanale</h3><div className="flex-1 w-full h-full">{renderCharts()}</div></div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button onClick={() => setExpiryModal(true)} className="p-4 bg-orange-50 border border-orange-200 rounded-xl hover:border-orange-500 hover:shadow-md transition-all text-left group">
                                <div className="bg-white w-10 h-10 rounded-lg flex items-center justify-center mb-3 group-hover:bg-orange-100 text-orange-500 transition-colors"><Icon name="Clock" size={20}/></div>
                                <div className="font-bold text-orange-800 text-sm">Analisi Scadenze (Lotti)</div>
                                <div className="text-[10px] text-orange-600/60 mt-1">Clicca per report</div>
                            </button>
                            {['Registro IVA', 'Vendite Orarie', 'Export Excel'].map((report, i) => (<button key={i} className="p-4 bg-white border border-slate-200 rounded-xl hover:border-blue-500 hover:shadow-md transition-all text-left group"><div className="bg-slate-100 w-10 h-10 rounded-lg flex items-center justify-center mb-3 group-hover:bg-blue-100 text-slate-500 group-hover:text-blue-600 transition-colors"><Icon name="List" size={20}/></div><div className="font-bold text-slate-700 text-sm">{report}</div><div className="text-[10px] text-slate-400 mt-1">Clicca per generare</div></button>))}
                        </div>
                    </div>

                    {!chatOpen && <button onClick={() => setChatOpen(true)} className="absolute bottom-8 right-8 bg-blue-600 text-white w-16 h-16 rounded-full shadow-2xl shadow-blue-500/50 hover:bg-blue-700 transition-all hover:scale-110 z-50 flex items-center justify-center group animate-in zoom-in"><Icon name="Bot" size={32} /></button>}

                    {chatOpen && (
                        <div className="absolute inset-0 z-40 bg-slate-50/95 backdrop-blur-md flex flex-col animate-in slide-in-from-bottom-10 duration-300">
                            <div className="p-6 border-b border-slate-200 flex justify-between items-center bg-white/50 sticky top-0">
                                <div className="flex items-center gap-4"><div className="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30"><Icon name="Bot" size={28}/></div><div><h3 className="font-bold text-xl text-slate-800">Market Intelligence AI</h3><p className="text-sm text-slate-500">Analisi dati in tempo reale</p></div></div>
                                <button onClick={() => setChatOpen(false)} className="p-3 hover:bg-slate-200 rounded-full text-slate-500 transition-colors"><Icon name="X" size={24}/></button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-8 space-y-6 max-w-4xl mx-auto w-full">
                                {chatMessages.map(msg => (<div key={msg.id} className={`flex ${msg.from === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[80%] chat-bubble ${msg.from === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white border border-slate-200 text-slate-700 rounded-bl-none'} p-6 rounded-3xl shadow-md text-base`}><p className="leading-relaxed">{msg.content}</p>{msg.type === 'chart' && msg.data && renderMiniChart(msg.data)}{msg.type === 'list' && msg.data && (<ul className="mt-4 space-y-2">{msg.data.map((item, idx) => (<li key={idx} className="flex justify-between items-center text-sm bg-slate-50 p-3 rounded-xl border border-slate-100"><span className="font-medium">{item.label}</span><span className={`font-mono font-bold ${item.alert ? 'text-red-500' : 'text-slate-600'}`}>{item.value}</span></li>))}</ul>)}</div></div>))}
                                <div ref={messagesEndRef}></div>
                            </div>
                            <div className="p-6 bg-white border-t border-slate-200"><form onSubmit={handleSendMessage} className="max-w-4xl mx-auto flex gap-4 relative"><input value={chatInput} onChange={e => setChatInput(e.target.value)} className="flex-1 bg-slate-100 border-none rounded-2xl px-6 py-4 text-lg outline-none focus:ring-2 focus:ring-blue-500/50 shadow-inner" placeholder="Chiedi 'vendite oggi' o 'stock mele'..." autoFocus /><button className="p-4 bg-blue-600 text-white rounded-2xl hover:bg-blue-700 transition-colors shadow-lg hover:shadow-blue-500/30"><Icon name="Send" size={24} /></button></form></div>
                        </div>
                    )}

                    {expiryModal && (
                        <Modal title="Report Scadenze" onClose={() => setExpiryModal(false)}>
                            <div className="space-y-4">
                                <div className="flex gap-2 overflow-x-auto pb-2">
                                    {[{id: 'all', label: 'Tutti'}, {id: 'expired', label: 'Scaduti'}, {id: 'thisMonth', label: 'Questo Mese'}, {id: 'next3Months', label: 'Prossimi 3 Mesi'}].map(f => (<button key={f.id} onClick={() => setExpiryFilter(f.id)} className={`px-4 py-2 rounded-lg text-xs font-bold transition-colors whitespace-nowrap ${expiryFilter === f.id ? 'bg-orange-500 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>{f.label}</button>))}
                                </div>
                                <div className="max-h-96 overflow-y-auto border border-slate-200 rounded-xl">
                                    <table className="w-full text-sm text-left"><thead className="bg-slate-50 text-slate-500 font-bold sticky top-0"><tr><th className="p-3">Prodotto</th><th className="p-3">Scadenza</th><th className="p-3 text-right">Stock</th></tr></thead><tbody className="divide-y divide-slate-100">{getExpiringBatches().map((p, idx) => { const status = getExpiryStatus(p.expiryDate); return (<tr key={p.code + idx} className={status.diffDays < 0 ? 'bg-red-50' : ''}><td className="p-3"><div className="font-bold text-slate-700">{p.name}</div><div className="text-xs text-slate-400">{p.code}</div></td><td className="p-3"><span className={`text-xs px-2 py-1 rounded-full font-bold ${status.bg} ${status.color}`}>{p.expiryDate} ({status.label})</span></td><td className="p-3 text-right font-mono font-bold text-slate-700">{p.stock}</td></tr>); })}</tbody></table>
                                </div>
                                <button onClick={() => printExpiryReport(products)} className="w-full py-3 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-700"><Icon name="Printer" className="mr-2 inline"/> STAMPA REPORT COMPLETO</button>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        // --- APP MAIN WRAPPER ---
        const App = () => {
            const [view, setView] = useState('pos');
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState([]);
            const [logs, setLogs] = useState([]);
            const [categories, setCategories] = useState([]); 
            const [toasts, setToasts] = useState([]);
            const [refreshDashboard, setRefreshDashboard] = useState(0);
            
            const [config, setConfig] = useState(() => {
                const savedStr = localStorage.getItem('config');
                const defaultConf = { 
                    shopName: "MarketOS", 
                    address: "", 
                    piva: "", 
                    phone: "", 
                    receiptFooter: "Grazie e Arrivederci!",
                    tax: 22, 
                    adminPass: "1234", 
                    storageMode: 'server', 
                    serverUrl: 'http://127.0.0.1:5500', 
                    version: CONFIG_VERSION, 
                    firebaseConfig: {} 
                };
                if (savedStr) {
                    try {
                        const parsed = JSON.parse(savedStr);
                        if (!parsed.version || parsed.version < CONFIG_VERSION) return defaultConf;
                        if (!parsed.serverUrl) parsed.serverUrl = 'http://127.0.0.1:5500';
                        return parsed;
                    } catch(e) { return defaultConf; }
                }
                return defaultConf;
            });
            const [showLogin, setShowLogin] = useState(false);
            const [serverStatus, setServerStatus] = useState('checking');
            const [loading, setLoading] = useState(true);

            const addToast = (msg, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            };

            const fetchData = async () => {
                setLoading(true);
                try {
                    if (config.storageMode === 'server') {
                        const prods = await DataAdapter.getProducts(config);
                        const cats = await DataAdapter.getCategories(config); 
                        setProducts(prods);
                        setCategories(cats);
                        setServerStatus('online');
                    } else if (config.storageMode === 'firebase') {
                        const prods = await DataAdapter.getProducts(config);
                        const cats = await DataAdapter.getCategories(config);
                        setProducts(prods);
                        setCategories(cats);
                        setServerStatus('online'); 
                    } else {
                        setProducts(JSON.parse(localStorage.getItem('products')) || []);
                        setServerStatus('local');
                    }
                } catch (e) {
                    setServerStatus('offline');
                    if(config.storageMode === 'server' || config.storageMode === 'firebase') addToast("Errore Connessione", 'error');
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
                localStorage.setItem('config', JSON.stringify(config));
            }, [config.storageMode, config.serverUrl, config.firebaseConfig]); 

            // --- CATEGORY ACTIONS ---
            const addCategory = async (name) => {
                if(!name) return;
                try {
                    await DataAdapter.addCategory(config, name);
                    addToast("Categoria aggiunta");
                    fetchData(); 
                } catch(e) { addToast("Errore aggiunta", 'error'); }
            };

            const deleteCategory = async (id) => {
                 if(confirm("Eliminare categoria?")) {
                    try {
                        await DataAdapter.deleteCategory(config, id);
                        addToast("Categoria eliminata");
                        fetchData();
                    } catch(e) { addToast("Errore eliminazione", 'error'); }
                 }
            };

            // --- MIGRAZIONE ---
            const handleMigration = async () => {
                if(!confirm("Vuoi copiare tutti i prodotti locali su Firebase? (Potrebbe richiedere tempo)")) return;
                try {
                    const count = await DataAdapter.migrateLocalToCloud(config);
                    addToast(`Migrazione completata: ${count} prodotti!`);
                    fetchData(); // Ricarica da Firebase
                } catch(e) {
                    addToast("Errore Migrazione: " + e.message, 'error');
                }
            };

            const updateProduct = async (p) => { 
                try {
                    setProducts(prev => prev.map(pr => pr.code === p.code ? p : pr)); 
                    await DataAdapter.saveProduct(config, p); 
                    addToast("Aggiornato");
                } catch(e) { addToast("Errore", 'error'); }
            };

            const createProduct = async (p) => { 
                if (products.some(x => x.code === p.code)) return false; 
                const newProd = { 
                    ...p, 
                    stock: parseFloat(p.stock), 
                    price: parseFloat(p.price),
                    cost: parseFloat(p.cost),
                    category: p.category || "Generale"
                }; 
                try {
                    setProducts(prev => [...prev, newProd]); 
                    await DataAdapter.saveProduct(config, newProd); 
                    addToast("Creato");
                    return true; 
                } catch(e) { 
                    setProducts(prev => prev.filter(x => x.code !== newProd.code));
                    addToast("Errore creazione: " + e.message, 'error'); return false; 
                }
            };

            const deleteProduct = async (code) => { 
                if(confirm("Eliminare?")) { 
                    try {
                        setProducts(prev => prev.filter(p => p.code !== code)); 
                        await DataAdapter.deleteProduct(config, code); 
                        addToast("Eliminato");
                    } catch(e) { addToast("Errore", 'error'); }
                } 
            };

            const deleteLog = async (id) => {
                try {
                    await DataAdapter.deleteLog(config, id);
                    addToast("Transazione eliminata");
                    setRefreshDashboard(prev => prev + 1); // Refresh dashboard stats
                } catch(e) {
                    addToast("Errore eliminazione log", 'error');
                }
            };

            // NEW: Restore Stock Logic
            const restoreStock = async (log) => {
                for (let item of log.items) {
                    const product = products.find(p => p.code === item.code);
                    if (product) {
                        let newP = { ...product };
                        // To keep it simple, restore to a "restored" batch or the legacy/generic one
                        // Ideally we would track which batch it came from, but for simplicity we add to the first available batch
                        if (!newP.batches) newP.batches = [];
                        
                        // Find generic batch or create one
                        let targetBatch = newP.batches.find(b => b.id === 'legacy') || newP.batches[0];
                        if (!targetBatch) {
                            targetBatch = { id: 'restored', stock: 0, expiryDate: newP.expiryDate || "", cost: newP.cost || 0 };
                            newP.batches.push(targetBatch);
                        }
                        
                        targetBatch.stock += item.qty;
                        newP.stock += item.qty;
                        
                        await DataAdapter.saveProduct(config, newP);
                    }
                }
                // Refresh local products state
                fetchData();
            };

            const checkout = async () => { 
                if(cart.length === 0) return; 
                
                let transactionTotalCost = 0; 
                let transactionNetTotal = 0; 
                let transactionTaxTotal = 0; 

                const newProds = products.map(p => { 
                    const cartItem = cart.find(x => x.code === p.code); 
                    if (!cartItem) return p; 
                    
                    let qtyToDeduct = cartItem.qty;
                    let updatedBatches = [...(p.batches || [])];
                    const itemTaxRate = p.taxRate || 22; 

                    if(updatedBatches.length === 0) {
                         updatedBatches.push({id: 'legacy', stock: p.stock, expiryDate: p.expiryDate, cost: p.cost || 0});
                    }

                    updatedBatches.sort((a,b) => {
                         if(!a.expiryDate) return 1;
                         if(!b.expiryDate) return -1;
                         return a.expiryDate.localeCompare(b.expiryDate);
                    });

                    updatedBatches = updatedBatches.map(b => {
                        if(qtyToDeduct <= 0) return b;
                        
                        let taken = 0;
                        if(b.stock >= qtyToDeduct) {
                            taken = qtyToDeduct;
                            b.stock -= qtyToDeduct;
                            qtyToDeduct = 0;
                        } else {
                            taken = b.stock;
                            qtyToDeduct -= b.stock;
                            b.stock = 0;
                        }
                        
                        transactionTotalCost += (taken * (b.cost || 0));
                        return b;
                    }).filter(b => b.stock > 0);
                    
                    if (qtyToDeduct > 0) {
                        transactionTotalCost += (qtyToDeduct * (p.cost || 0));
                    }

                    const totalNewStock = updatedBatches.reduce((a,b)=>a+b.stock, 0) - qtyToDeduct;

                    const lineTotal = cartItem.qty * p.price;
                    const lineNet = lineTotal / (1 + itemTaxRate/100);
                    transactionNetTotal += lineNet;
                    transactionTaxTotal += (lineTotal - lineNet);

                    const activeBatches = updatedBatches.filter(b => b.expiryDate);
                    activeBatches.sort((a,b) => a.expiryDate.localeCompare(b.expiryDate));
                    const newExpiry = activeBatches.length > 0 ? activeBatches[0].expiryDate : "";

                    return { 
                        ...p, 
                        stock: totalNewStock,
                        batches: updatedBatches,
                        expiryDate: newExpiry 
                    }; 
                }); 

                const total = cart.reduce((s, i) => s + (i.price * i.qty), 0); 
                
                const log = { 
                    id: Date.now(), 
                    date: new Date().toISOString(), 
                    total: total, 
                    netTotal: transactionNetTotal, 
                    taxTotal: transactionTaxTotal, 
                    totalCost: transactionTotalCost, 
                    items: cart, 
                    type: 'sale' 
                }; 
                
                try {
                    setProducts(newProds); 
                    setLogs([log, ...logs]); 
                    
                    if(config.storageMode === 'server' || config.storageMode === 'firebase') { 
                        for(let p of newProds) { if (cart.find(c => c.code === p.code)) await DataAdapter.saveProduct(config, p); }
                        await DataAdapter.saveLog(config, log); 
                    } else {
                        localStorage.setItem('products', JSON.stringify(newProds));
                        localStorage.setItem('logs', JSON.stringify([log, ...JSON.parse(localStorage.getItem('logs')||'[]')]));
                    }
                    setCart([]); 
                    addToast(`Vendita OK: €${total.toFixed(2)}`);
                    setRefreshDashboard(prev => prev + 1);
                } catch(e) { addToast("Errore vendita", 'error'); }
            };

            const addToCart = (code) => { const p = products.find(x => x.code === code); if (!p) return false; const exist = cart.find(x => x.code === code); if (exist) setCart(cart.map(x => x.code === code ? { ...x, qty: x.qty + 1 } : x)); else setCart([...cart, { ...p, qty: 1, taxRate: p.taxRate }]); return true; };

            return (
                <>
                    <ToastContainer toasts={toasts} />
                    <div className="flex h-screen bg-[#f0f2f5] font-sans text-slate-800">
                        <div className="w-24 bg-[#0f172a] flex flex-col items-center py-8 gap-4 shadow-2xl z-20 shrink-0"><div className="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black text-xl mb-6 shadow-lg shadow-blue-900/50">MK</div><NavBtn icon="ShoppingCart" active={view === 'pos'} onClick={() => setView('pos')} label="Cassa" /><NavBtn icon="Box" active={view === 'inventory'} onClick={() => setView('inventory')} label="Prodotti" /><NavBtn icon="Clipboard" active={view === 'warehouse'} onClick={() => setView('warehouse')} label="Magazzino" /><NavBtn icon="List" active={view === 'history'} onClick={() => setView('history')} label="Storico" /><NavBtn icon="TrendingUp" active={view === 'dashboard'} onClick={() => setView('dashboard')} label="Report" /><div className="mt-auto"><NavBtn icon="Settings" active={view === 'settings'} onClick={() => setShowLogin(true)} label="Admin" color="text-slate-500" /></div></div>
                        <div className="flex-1 overflow-hidden flex flex-col relative">
                            <div className="bg-white h-16 border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-10"><h1 className="font-bold text-xl text-slate-800">{view === 'pos' ? 'Nuova Vendita' : view === 'inventory' ? 'Gestione Magazzino' : view === 'history' ? 'Storico Transazioni' : view === 'warehouse' ? 'Operazioni Magazzino' : 'Pannello Controllo'}</h1><div className="flex items-center gap-2 text-xs font-medium"><div className={`w-2 h-2 rounded-full ${serverStatus === 'online' ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 'bg-red-500'}`}></div><button onClick={fetchData} className="text-slate-400 hover:text-blue-500 underline decoration-dotted">{serverStatus === 'online' ? 'ONLINE' : 'OFFLINE (Riprova)'}</button></div></div>
                            {loading ? <div className="flex-1 flex items-center justify-center text-slate-400">Caricamento...</div> : 
                            <div className="flex-1 overflow-hidden p-6">
                                {view === 'pos' && <POSView products={products} cart={cart} setCart={setCart} onAddToCart={addToCart} onCheckout={checkout} config={config} onPrintReceipt={() => logs[0] && printReceipt(logs[0], config)} />}
                                {view === 'inventory' && <InventoryView products={products} onUpdate={updateProduct} onCreate={createProduct} onDelete={deleteProduct} refresh={fetchData} categories={categories} addCat={addCategory} delCat={deleteCategory} />}
                                {view === 'warehouse' && <WarehouseView products={products} onUpdate={updateProduct} />}
                                {view === 'history' && <HistoryView config={config} onDelete={deleteLog} products={products} onRestoreStock={restoreStock} />}
                                {view === 'settings' && <SettingsView config={config} setConfig={setConfig} serverStatus={serverStatus} categories={categories} addCat={addCategory} delCat={deleteCategory} onMigrate={handleMigration} />}
                                {view === 'dashboard' && <DashboardView config={config} refreshTrigger={refreshDashboard} products={products} />}
                            </div>}
                        </div>
                        {showLogin && <LoginModal password={config.adminPass} onSuccess={() => { setShowLogin(false); setView('settings'); }} onClose={() => setShowLogin(false)} />}
                    </div>
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>