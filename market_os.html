<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MarketOS Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; color: #0f172a; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .toast-enter { transform: translateX(100%); opacity: 0; }
        .toast-enter-active { transform: translateX(0); opacity: 1; transition: all 300ms; }
        .toast-exit { transform: translateX(0); opacity: 1; }
        .toast-exit-active { transform: translateX(100%); opacity: 0; transition: all 300ms; }
        @media print { body * { visibility: hidden; } #printable-label, #printable-label * { visibility: visible; } #printable-label { position: absolute; left: 0; top: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="printable-area" class="hidden"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CONFIG_VERSION = 3; 

        const ToastContainer = ({ toasts }) => (
            <div className="fixed top-4 right-4 z-50 flex flex-col gap-2">
                {toasts.map(t => (
                    <div key={t.id} className={`p-4 rounded-xl shadow-lg text-white font-bold min-w-[300px] animate-in slide-in-from-right ${t.type === 'error' ? 'bg-red-500' : 'bg-green-500'}`}>
                        {t.msg}
                    </div>
                ))}
            </div>
        );

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Barcode: <path d="M3 5v14M8 5v14M12 5v14M17 5v14M21 5v14" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>,
                ShoppingCart: <path d="M9 20a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm7 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-7-16L4 4 2 2M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Box: <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                TrendingUp: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><polyline points="17 6 23 6 23 12" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Trash: <><polyline points="3 6 5 6 21 6" fill="none" stroke="currentColor" strokeWidth="2"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" strokeWidth="2"/></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" strokeWidth="2"/><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2"/></>,
                Minus: <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2"/>,
                Check: <polyline points="20 6 9 17 4 12" fill="none" stroke="currentColor" strokeWidth="2"/>,
                Search: <><circle cx="11" cy="11" r="8" fill="none" stroke="currentColor" strokeWidth="2"/><line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" strokeWidth="2"/></>,
                Settings: <><circle cx="12" cy="12" r="3" stroke="currentColor" strokeWidth="2"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" stroke="currentColor" strokeWidth="2"/></>,
                Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Scale: <><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M7 21h10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 3v18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Printer: <><polyline points="6 9 6 2 18 2 18 9" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><rect x="6" y="14" width="12" height="8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Tag: <><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><line x1="7" y1="7" x2="7.01" y2="7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                X: <><line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></>,
                Server: <><rect x="2" y="2" width="20" height="8" rx="2" ry="2" stroke="currentColor" strokeWidth="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2" stroke="currentColor" strokeWidth="2"/><line x1="6" y1="6" x2="6.01" y2="6" stroke="currentColor" strokeWidth="2"/><line x1="6" y1="18" x2="6.01" y2="18" stroke="currentColor" strokeWidth="2"/></>,
                Cloud: <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Refresh: <><polyline points="23 4 23 10 17 10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><polyline points="1 20 1 14 7 14" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>
            };
            return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className}>{icons[name]}</svg>;
        };

        const Modal = ({ title, onClose, children }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                    <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <h3 className="font-bold text-lg text-slate-800">{title}</h3>
                        <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-500"><Icon name="X" size={20}/></button>
                    </div>
                    <div className="p-6 overflow-y-auto flex-1">{children}</div>
                </div>
            </div>
        );

        // --- HELPER URL ---
        const getBaseUrl = (config) => {
            if (!config.serverUrl || config.serverUrl.trim() === "") return 'http://127.0.0.1:5500';
            return config.serverUrl.replace(/\/$/, "");
        };

        // --- DATA ADAPTER ---
        const DataAdapter = {
            async getProducts(config) {
                if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    for(let i=0; i<3; i++) {
                        try {
                            const res = await fetch(`${url}/api/products`);
                            if(!res.ok) throw new Error("Server Error: " + res.status);
                            return await res.json();
                        } catch(e) {
                            console.warn(`Tentativo ${i+1} fallito: ${e.message}`);
                            if (i === 2) throw e;
                            await new Promise(r => setTimeout(r, 500));
                        }
                    }
                }
                return JSON.parse(localStorage.getItem('products')) || [];
            },
            async saveProduct(config, product) {
                if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    const res = await fetch(`${url}/api/products`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(product) });
                    if(!res.ok) throw new Error("Errore Server: " + res.statusText);
                }
            },
            async deleteProduct(config, code) {
                if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    await fetch(`${url}/api/products/${code}`, { method: 'DELETE' });
                }
            },
            async saveLog(config, log) {
                if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    await fetch(`${url}/api/logs`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(log) });
                }
            }
        };

        const printLabel = (product) => {
            const printArea = document.getElementById('printable-area');
            printArea.innerHTML = `<div id="printable-label" style="text-align: center; font-family: monospace; width: 300px; padding: 20px; border: 1px dashed black;"><h2 style="margin: 0; font-size: 18px;">${product.name}</h2><p style="margin: 5px 0;">Cod: ${product.code}</p><svg id="barcode-render"></svg><h1 style="margin: 10px 0; font-size: 32px;">€ ${parseFloat(product.price).toFixed(2)}</h1><p style="font-size: 10px;">${product.isWeighable ? 'ARTICOLO A PESO (Prezzo al Kg)' : 'PREZZO CAD.'}</p></div>`;
            try { JsBarcode("#barcode-render", product.code, { format: "CODE128", height: 50, displayValue: false }); window.print(); } catch (e) { alert("Errore barcode: " + e.message); }
        };

        // --- APP MAIN ---
        const App = () => {
            const [view, setView] = useState('pos');
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState([]);
            const [logs, setLogs] = useState([]);
            const [toasts, setToasts] = useState([]);

            const [config, setConfig] = useState(() => {
                const saved = localStorage.getItem('config');
                const defaultConf = { shopName: "MarketOS", tax: 22, adminPass: "1234", storageMode: 'server', serverUrl: 'http://127.0.0.1:5500', version: CONFIG_VERSION };
                
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (!parsed.version || parsed.version < CONFIG_VERSION) return defaultConf;
                        if (!parsed.serverUrl) parsed.serverUrl = 'http://127.0.0.1:5500';
                        return parsed;
                    } catch(e) { return defaultConf; }
                }
                return defaultConf;
            });

            const [showLogin, setShowLogin] = useState(false);
            const [serverStatus, setServerStatus] = useState('checking');
            const [loading, setLoading] = useState(true);

            const addToast = (msg, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            };

            const fetchData = async () => {
                setLoading(true);
                try {
                    if (config.storageMode === 'server') {
                        const prods = await DataAdapter.getProducts(config);
                        setProducts(prods);
                        setServerStatus('online');
                    } else {
                        setProducts(JSON.parse(localStorage.getItem('products')) || []);
                        setServerStatus('local');
                    }
                } catch (e) {
                    console.warn("Fetch Error:", e);
                    setServerStatus('offline');
                    if(config.storageMode === 'server') addToast("Errore Connessione: " + e.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
                localStorage.setItem('config', JSON.stringify(config));
            }, [config.storageMode, config.serverUrl]);

            const updateProduct = async (p) => { 
                try {
                    setProducts(prev => prev.map(pr => pr.code === p.code ? p : pr)); 
                    await DataAdapter.saveProduct(config, p); 
                    addToast("Prodotto aggiornato");
                } catch(e) { addToast("Errore salvataggio", 'error'); }
            };

            const createProduct = async (p) => { 
                if (products.some(x => x.code === p.code)) return false; 
                // FIX: Aggiunto cost al prodotto nuovo
                const newProd = { 
                    ...p, 
                    stock: parseFloat(p.stock), 
                    price: parseFloat(p.price),
                    cost: parseFloat(p.cost) 
                }; 
                
                // Aggiornamento ottimistico con rollback se fallisce
                setProducts(prev => [...prev, newProd]); 
                
                try {
                    await DataAdapter.saveProduct(config, newProd); 
                    addToast("Prodotto creato");
                    return true; 
                } catch(e) { 
                    // Rollback in caso di errore
                    setProducts(prev => prev.filter(x => x.code !== newProd.code));
                    addToast("Errore creazione: " + e.message, 'error'); 
                    return false; 
                }
            };

            const deleteProduct = async (code) => { 
                if(confirm("Eliminare?")) { 
                    try {
                        setProducts(prev => prev.filter(p => p.code !== code)); 
                        await DataAdapter.deleteProduct(config, code); 
                        addToast("Eliminato");
                    } catch(e) { addToast("Errore eliminazione", 'error'); }
                } 
            };

            const checkout = async () => { 
                if(cart.length === 0) return; 
                const newProds = products.map(p => { const c = cart.find(x => x.code === p.code); return c ? { ...p, stock: p.stock - c.qty } : p; }); 
                const total = cart.reduce((s, i) => s + (i.price * i.qty), 0); 
                const log = { id: Date.now(), date: new Date().toISOString(), total, items: cart, type: 'sale' }; 
                
                try {
                    setProducts(newProds); 
                    setLogs([log, ...logs]); 
                    
                    if(config.storageMode === 'server') { 
                        for(let p of newProds) { if (cart.find(c => c.code === p.code)) await DataAdapter.saveProduct(config, p); }
                        await DataAdapter.saveLog(config, log); 
                    } else {
                        localStorage.setItem('products', JSON.stringify(newProds));
                        localStorage.setItem('logs', JSON.stringify([log, ...logs]));
                    }
                    setCart([]); 
                    addToast(`Vendita OK: €${total.toFixed(2)}`);
                } catch(e) { addToast("Errore registrazione vendita", 'error'); }
            };

            const addToCart = (code) => { const p = products.find(x => x.code === code); if (!p) return false; const exist = cart.find(x => x.code === code); if (exist) setCart(cart.map(x => x.code === code ? { ...x, qty: x.qty + 1 } : x)); else setCart([...cart, { ...p, qty: 1 }]); return true; };

            // ... POSView (stesso di prima) ...
            const POSView = ({ products, cart, setCart, onCheckout }) => {
                const [input, setInput] = useState(""); const [searchMode, setSearchMode] = useState(false); const [searchTerm, setSearchTerm] = useState(""); const [weightItem, setWeightItem] = useState(null); const [weightInput, setWeightInput] = useState(""); const inputRef = useRef(null);
                useEffect(() => { if (!weightItem && !searchMode) inputRef.current?.focus(); }, [cart, weightItem, searchMode]);
                const handleScan = (e) => { if (e.key === 'Enter') { if(!input.trim()) return; processItemAdd(input); setInput(""); } };
                const processItemAdd = (code) => { const p = products.find(x => x.code === code); if (!p) return alert("Non trovato!"); if (p.isWeighable) { setWeightItem(p); setWeightInput(""); return; } addToCart(p, 1); };
                const addItemToCart = (p, q) => { const ex = cart.find(x => x.code === p.code); if(ex) setCart(cart.map(x => x.code === p.code ? {...x, qty: x.qty + q} : x)); else setCart([...cart, {...p, qty: q}]); };
                const handleWeightConfirm = (e) => { if (e.key === 'Enter' || e.type === 'click') { const w = parseFloat(weightInput.replace(',', '.')); if (!w || w <= 0) return alert("Peso non valido"); addItemToCart(weightItem, w); setWeightItem(null); setSearchMode(false); } };
                const total = cart.reduce((a, b) => a + (b.price * b.qty), 0); const filtered = products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
                return (<div className="flex h-full p-4 gap-4 relative"><div className="flex-1 flex flex-col gap-4"><div className="flex gap-2"><div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex items-center gap-4 flex-1"><Icon name="Barcode" className="text-slate-400"/><input ref={inputRef} type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={handleScan} className="flex-1 text-2xl font-mono outline-none" placeholder="Spara barcode..." /></div><button onClick={() => { setSearchMode(!searchMode); setSearchTerm(""); }} className={`px-6 rounded-2xl font-bold border transition-all flex items-center gap-2 ${searchMode ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}><Icon name="Search" /> {searchMode ? 'Chiudi' : 'Cerca'}</button></div>{searchMode && (<div className="bg-white rounded-2xl shadow-lg border border-blue-100 flex flex-col h-64 animate-in fade-in absolute top-24 left-4 right-96 z-10"><div className="p-3 border-b border-slate-100 flex gap-2"><input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full outline-none font-bold text-lg" placeholder="Scrivi nome..." autoFocus /></div><div className="overflow-y-auto p-2">{filtered.map(p => (<button key={p.code} onClick={() => { processItemAdd(p.code); setSearchMode(false); }} className="w-full text-left p-3 hover:bg-blue-50 rounded-xl flex justify-between group"><div><div className="font-bold text-slate-700">{p.name}</div><div className="text-xs text-slate-400">{p.code}</div></div><div className="font-mono font-bold">€{parseFloat(p.price).toFixed(2)}</div></button>))}</div></div>)}<div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col"><div className="bg-slate-50 p-3 text-xs font-bold text-slate-500 uppercase flex justify-between"><span>Articolo</span><span>Totale</span></div><div className="flex-1 overflow-y-auto p-3 space-y-3">{cart.map(item => (<div key={item.code} className="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-xl hover:border-blue-200 transition-colors group"><div className="flex-1"><div className="font-bold text-slate-800">{item.name}</div><div className="text-xs text-slate-400 flex items-center gap-2">{item.code} {item.isWeighable && <span className="bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded text-[10px] font-bold">PESO</span>}</div></div><div className="flex items-center gap-6"><div className="flex items-center bg-slate-50 rounded-lg border border-slate-200 p-1"><button onClick={() => setCart(cart.map(c => c.code === item.code ? {...c, qty: Math.max(0, c.qty - 1)} : c).filter(c=>c.qty>0))} className="p-2 hover:bg-white hover:shadow-sm rounded-md text-slate-500"><Icon name="Minus" size={14}/></button><span className="w-10 text-center font-mono font-bold">{item.qty}</span><button onClick={() => setCart(cart.map(c => c.code === item.code ? {...c, qty: c.qty + 1} : c))} className="p-2 hover:bg-white hover:shadow-sm rounded-md text-blue-600"><Icon name="Plus" size={14}/></button></div><div className="w-24 text-right font-mono font-bold text-xl">€{(item.price * item.qty).toFixed(2)}</div></div></div>))}</div></div></div><div className="w-80 bg-[#0f172a] text-white rounded-2xl p-8 flex flex-col justify-between shadow-2xl"><div><div className="text-slate-400 font-bold uppercase text-xs tracking-widest mb-2">Totale Scontrino</div><div className="text-6xl font-mono font-bold tracking-tighter">€{total.toFixed(2)}</div><div className="mt-8 pt-8 border-t border-slate-700 space-y-3 text-sm text-slate-400"><div className="flex justify-between"><span>Articoli</span><span className="text-white font-bold">{cart.reduce((a,b)=>a+b.qty,0)}</span></div><div className="flex justify-between"><span>Imponibile</span><span className="text-white font-bold">€{(total/1.22).toFixed(2)}</span></div><div className="flex justify-between"><span>IVA 22%</span><span className="text-white font-bold">€{(total - total/1.22).toFixed(2)}</span></div></div></div><button onClick={onCheckout} disabled={cart.length === 0} className="w-full py-5 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:shadow-lg hover:shadow-blue-900/50 text-lg"><Icon name="Check" /> INCASSA</button></div>{weightItem && (<div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4"><div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center animate-in fade-in zoom-in duration-200"><div className="w-20 h-20 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-6 text-orange-500 shadow-inner"><Icon name="Scale" size={40}/></div><h3 className="text-2xl font-bold mb-2 text-slate-800">{weightItem.name}</h3><p className="text-slate-400 text-sm mb-8">Inserisci il peso netto in Kg</p><div className="relative mb-8"><input type="number" step="0.001" value={weightInput} onChange={e => setWeightInput(e.target.value)} onKeyDown={e => {if(e.key==='Enter') { const w=parseFloat(weightInput); if(w>0){addToCart(weightItem, w); setWeightItem(null);} }}} className="w-full text-center text-6xl font-mono font-bold border-b-4 border-slate-100 focus:border-orange-500 outline-none pb-2 bg-transparent text-slate-800" placeholder="0.000" autoFocus /><span className="absolute right-0 bottom-4 text-slate-400 font-bold">kg</span></div><div className="grid grid-cols-2 gap-4"><button onClick={() => setWeightItem(null)} className="py-4 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-colors">Annulla</button><button onClick={() => { const w=parseFloat(weightInput); if(w>0){addToCart(weightItem, w); setWeightItem(null);} }} className="py-4 bg-orange-500 text-white font-bold rounded-xl hover:bg-orange-400 shadow-lg shadow-orange-200 transition-all">Conferma</button></div></div></div>)}</div>);
            };

            const InventoryView = ({ products, onUpdate, onCreate, onDelete, refresh }) => {
                const [search, setSearch] = useState(""); const [editItem, setEditItem] = useState(null); const [isNew, setIsNew] = useState(false); const [offerItem, setOfferItem] = useState(null);
                const filtered = products.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) || p.code.includes(search));
                const generateCode = () => setEditItem(prev => ({ ...prev, code: `200${Math.floor(10000 + Math.random() * 90000)}` }));
                
                return (
                    <div className="h-full flex flex-col p-6 gap-6">
                        <div className="flex justify-between gap-4">
                            <div className="flex items-center gap-3 bg-white px-5 py-3 rounded-xl shadow-sm border border-slate-200 flex-1 transition-all focus-within:border-blue-500 focus-within:ring-4 focus-within:ring-blue-500/10">
                                <Icon name="Search" className="text-slate-400"/><input value={search} onChange={e => setSearch(e.target.value)} placeholder="Cerca prodotto o barcode..." className="bg-transparent outline-none flex-1 font-medium" />
                            </div>
                            <div className="flex gap-2">
                                <button onClick={refresh} className="bg-slate-200 hover:bg-slate-300 text-slate-600 px-4 py-2 rounded-xl font-bold flex gap-2 items-center"><Icon name="Refresh"/> Aggiorna</button>
                                <button onClick={() => { setEditItem({ code: "", name: "", price: "", cost: "", stock: 0, isWeighable: false }); setIsNew(true); }} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-blue-900/20 transition-transform active:scale-95"><Icon name="Plus"/> Nuovo Articolo</button>
                            </div>
                        </div>
                        <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="grid grid-cols-12 bg-slate-50 p-4 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200">
                                <div className="col-span-6">Prodotto</div>
                                <div className="col-span-2 text-right">Prezzo</div>
                                <div className="col-span-2 text-right">Stock</div>
                                <div className="col-span-2 text-center">Azioni</div>
                            </div>
                            <div className="overflow-y-auto h-full pb-10">
                                {filtered.map(p => (
                                    <div key={p.code} className="grid grid-cols-12 p-4 border-b border-slate-100 items-center hover:bg-blue-50/50 transition-colors group">
                                        <div className="col-span-6">
                                            <div className="font-bold text-slate-800">{p.name}</div>
                                            <div className="text-xs text-slate-400 flex gap-2 mt-1 items-center">
                                                <span className="font-mono bg-slate-100 px-1.5 py-0.5 rounded">{p.code}</span>
                                                {p.isWeighable && <span className="bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded font-bold">PESO</span>}
                                                {p.originalPrice && <span className="text-[10px] bg-red-100 text-red-600 px-1 rounded">OFFERTA</span>}
                                            </div>
                                        </div>
                                        <div className="col-span-2 text-right font-mono font-bold text-slate-700">€{parseFloat(p.price).toFixed(2)}</div>
                                        <div className="col-span-2 text-right"><span className={`px-2.5 py-1 rounded-lg font-bold text-xs ${p.stock < 5 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-700'}`}>{p.stock} {p.isWeighable ? 'kg' : 'pz'}</span></div>
                                        <div className="col-span-2 flex justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => printLabel(p)} className="p-2 hover:bg-white hover:shadow text-slate-500 rounded-lg"><Icon name="Barcode" size={16}/></button>
                                            <button onClick={() => { setEditItem(p); setIsNew(false); }} className="p-2 hover:bg-white hover:shadow text-blue-600 rounded-lg"><Icon name="Edit" size={16}/></button>
                                            <button onClick={() => onDelete(p.code)} className="p-2 hover:bg-white hover:shadow text-red-500 rounded-lg"><Icon name="Trash" size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        {editItem && <Modal title={isNew ? "Nuovo" : "Modifica"} onClose={() => setEditItem(null)}>
                            <form onSubmit={e => { e.preventDefault(); isNew ? onCreate(editItem) : onUpdate(editItem); setEditItem(null); }} className="space-y-5">
                                <div className="flex gap-3 items-end">
                                    <div className="flex-1 space-y-1"><label className="text-xs font-bold text-slate-500 uppercase">Barcode</label><input value={editItem.code} onChange={e => setEditItem({...editItem, code: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl font-mono focus:border-blue-500 outline-none" required disabled={!isNew} placeholder="Scan..." /></div>
                                    {isNew && <button type="button" onClick={generateCode} className="bg-slate-100 hover:bg-slate-200 text-slate-600 p-3.5 rounded-xl font-bold text-xs transition-colors">GENERA</button>}
                                </div>
                                <div className="space-y-1"><label className="text-xs font-bold text-slate-500 uppercase">Nome</label><input value={editItem.name} onChange={e => setEditItem({...editItem, name: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl focus:border-blue-500 outline-none" required /></div>
                                <label className="flex items-center gap-3 p-4 border border-orange-200 bg-orange-50 rounded-xl cursor-pointer hover:bg-orange-100 transition-colors">
                                    <input type="checkbox" checked={editItem.isWeighable} onChange={e => setEditItem({...editItem, isWeighable: e.target.checked})} className="w-5 h-5 accent-orange-500"/>
                                    <div className="text-sm font-bold text-orange-800 flex items-center"><Icon name="Scale" size={18} className="mr-2"/> Vendita a Peso (Bilancia)</div>
                                </label>
                                
                                {/* FIX: Aggiunto campo COSTO e migliorato layout con 3 colonne */}
                                <div className="grid grid-cols-3 gap-4">
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold text-slate-500 uppercase">Prezzo Vendita</label>
                                        <input type="number" step="0.01" value={editItem.price} onChange={e => setEditItem({...editItem, price: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl font-bold text-blue-600" required />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold text-slate-500 uppercase">Costo Acquisto</label>
                                        <input type="number" step="0.01" value={editItem.cost} onChange={e => setEditItem({...editItem, cost: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl font-bold text-slate-600" required />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold text-slate-500 uppercase">Giacenza</label>
                                        <input type="number" value={editItem.stock} onChange={e => setEditItem({...editItem, stock: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl font-bold text-slate-600" required />
                                    </div>
                                </div>

                                <button className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-900/20 hover:bg-blue-500 transition-all">Salva Prodotto</button>
                            </form>
                        </Modal>}
                        {offerItem && <Modal title="Applica Offerta" onClose={() => setOfferItem(null)}>
                            {/* ... (Resto del codice per le offerte invariato) ... */}
                             <div className="space-y-4"><div className="bg-slate-50 p-4 rounded-xl"><h4 className="font-bold">{offerItem.name}</h4><p className="text-sm">Prezzo attuale: <span className="font-mono font-bold">€{parseFloat(offerItem.price).toFixed(2)}</span></p></div><div className="grid grid-cols-3 gap-2"><button onClick={() => setOfferItem({...offerItem, newPrice: (offerItem.price * 0.9).toFixed(2)})} className="p-2 border rounded-lg hover:bg-slate-50">-10%</button><button onClick={() => setOfferItem({...offerItem, newPrice: (offerItem.price * 0.8).toFixed(2)})} className="p-2 border rounded-lg hover:bg-slate-50">-20%</button><button onClick={() => setOfferItem({...offerItem, newPrice: (offerItem.price * 0.5).toFixed(2)})} className="p-2 border rounded-lg hover:bg-slate-50">-50%</button></div><div><label className="text-xs font-bold text-slate-500 uppercase">Nuovo Prezzo</label><input type="number" step="0.01" value={offerItem.newPrice || ""} onChange={e => setOfferItem({...offerItem, newPrice: e.target.value})} className="w-full border-2 border-orange-400 p-3 rounded-lg text-2xl font-bold text-orange-600 text-center" placeholder="€ 0.00" /></div><div className="flex gap-2 pt-4"><button onClick={() => { const original = offerItem.originalPrice || offerItem.price; onUpdate({ ...offerItem, price: original, originalPrice: null }); setOfferItem(null); }} className="flex-1 bg-slate-200 text-slate-700 py-3 rounded-xl font-bold">Rimuovi Offerta</button><button onClick={() => { if(!offerItem.newPrice) return; const original = offerItem.originalPrice || offerItem.price; onUpdate({ ...offerItem, price: offerItem.newPrice, originalPrice: original }); setOfferItem(null); }} className="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold">Applica</button></div></div>
                        </Modal>}
                    </div>
                );
            };

            const SettingsView = ({ config, setConfig, serverStatus }) => (
                <div className="max-w-xl mx-auto p-8">
                    <h2 className="text-3xl font-bold text-slate-800 mb-8">Impostazioni Sistema</h2>
                    <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 space-y-8">
                        <div className="space-y-2">
                            <label className="block text-xs font-bold text-slate-400 uppercase">Nome Negozio</label>
                            <input type="text" value={config.shopName} onChange={e => setConfig({...config, shopName: e.target.value})} className="w-full border p-3 rounded-xl outline-none focus:border-blue-500" />
                        </div>
                        <div className="p-6 bg-slate-50 rounded-2xl border border-slate-200">
                            <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Icon name="Settings"/> Database Engine</h3>
                            <div className="grid grid-cols-2 gap-4 mb-6">
                                <button onClick={() => setConfig({...config, storageMode: 'local'})} className={`p-5 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${config.storageMode === 'local' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-slate-200 hover:bg-white hover:border-slate-300'}`}>
                                    <Icon name="Box" size={28}/>
                                    <span className="font-bold">Browser (Locale)</span>
                                </button>
                                <button onClick={() => setConfig({...config, storageMode: 'server'})} className={`p-5 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${config.storageMode === 'server' ? 'border-purple-500 bg-purple-50 text-purple-700' : 'border-slate-200 hover:bg-white hover:border-slate-300'}`}>
                                    <Icon name="Server" size={28}/>
                                    <span className="font-bold">Server (SQLite)</span>
                                </button>
                            </div>
                            {config.storageMode === 'server' && (
                                <div className="flex items-center justify-between text-sm bg-white p-3 rounded-xl border border-slate-200 gap-2" onClick={fetchData}>
                                    <span className="text-slate-500">Stato Connessione:</span>
                                    <span className={`font-bold px-3 py-1 rounded-full text-xs cursor-pointer ${serverStatus === 'online' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700 hover:bg-red-200'}`}>
                                        {serverStatus === 'online' ? 'CONNESSO' : 'OFFLINE (Clicca per riprovare)'}
                                    </span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );

            const NavBtn = ({ icon, active, onClick, label, color = "text-slate-500" }) => (<button onClick={onClick} className={`flex flex-col items-center gap-1.5 p-3 rounded-xl w-full transition-all ${active ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30' : 'hover:bg-slate-800/50 ' + color}`}><Icon name={icon} className={active ? "text-white" : ""} size={24} /><span className="text-[10px] font-bold tracking-wide">{label}</span></button>);
            const LoginModal = ({ password, onSuccess, onClose }) => { const [input, setInput] = useState(""); return <div className="fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in"><form onSubmit={e => { e.preventDefault(); if(input===password) onSuccess(); else setInput(""); }} className="bg-white p-8 rounded-3xl text-center w-full max-w-sm shadow-2xl transform transition-all"><div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6 text-slate-600"><Icon name="Settings" size={32} /></div><h3 className="text-xl font-bold mb-2 text-slate-800">Admin Login</h3><p className="text-xs text-slate-400 mb-6">Inserisci PIN di sicurezza</p><input type="password" value={input} onChange={e => setInput(e.target.value)} className="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl mb-6 text-center text-2xl tracking-widest focus:border-blue-500 outline-none transition-colors" placeholder="••••" autoFocus /><button className="w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 transition-colors">Accedi</button><button type="button" onClick={onClose} className="mt-4 text-xs text-slate-400 hover:text-slate-600 font-bold uppercase tracking-wider">Annulla</button></form></div>; };

            return (
                <>
                    <ToastContainer toasts={toasts} />
                    <div className="flex h-screen bg-[#f0f2f5] font-sans text-slate-800">
                        <div className="w-24 bg-[#0f172a] flex flex-col items-center py-8 gap-4 shadow-2xl z-20 shrink-0"><div className="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black text-xl mb-6 shadow-lg shadow-blue-900/50">MK</div><NavBtn icon="ShoppingCart" active={view === 'pos'} onClick={() => setView('pos')} label="Cassa" /><NavBtn icon="Box" active={view === 'inventory'} onClick={() => setView('inventory')} label="Prodotti" /><NavBtn icon="TrendingUp" active={view === 'dashboard'} onClick={() => setView('dashboard')} label="Report" /><div className="mt-auto"><NavBtn icon="Settings" active={view === 'settings'} onClick={() => setShowLogin(true)} label="Admin" color="text-slate-500" /></div></div>
                        <div className="flex-1 overflow-hidden flex flex-col relative">
                            <div className="bg-white h-16 border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-10"><h1 className="font-bold text-xl text-slate-800">{view === 'pos' ? 'Nuova Vendita' : view === 'inventory' ? 'Gestione Magazzino' : 'Pannello Controllo'}</h1><div className="flex items-center gap-2 text-xs font-medium"><div className={`w-2 h-2 rounded-full ${serverStatus === 'online' ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 'bg-red-500'}`}></div><button onClick={fetchData} className="text-slate-400 hover:text-blue-500 underline decoration-dotted">{serverStatus === 'online' ? 'ONLINE' : 'OFFLINE (Riprova)'}</button></div></div>
                            {loading ? <div className="flex-1 flex items-center justify-center text-slate-400">Caricamento...</div> : 
                            <div className="flex-1 overflow-hidden p-6">{view === 'pos' && <POSView products={products} cart={cart} setCart={setCart} onAddToCart={addToCart} onCheckout={checkout} />}{view === 'inventory' && <InventoryView products={products} onUpdate={updateProduct} onCreate={createProduct} onDelete={deleteProduct} refresh={fetchData} />}{view === 'settings' && <SettingsView config={config} setConfig={setConfig} serverStatus={serverStatus} />}{view === 'dashboard' && <div className="flex items-center justify-center h-full text-slate-400">Funzione Report in sviluppo</div>}</div>}
                        </div>
                        {showLogin && <LoginModal password={config.adminPass} onSuccess={() => { setShowLogin(false); setView('settings'); }} onClose={() => setShowLogin(false)} />}
                    </div>
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>