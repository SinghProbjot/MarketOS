<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MarketOS Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Libs -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.3/umd/Recharts.js"></script>

    <!-- FIREBASE BRIDGE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"; 
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, addDoc, query, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.FB = {
            app: null,
            db: null,
            init: async (configJson) => {
                try {
                    const config = typeof configJson === 'string' ? JSON.parse(configJson) : configJson;
                    if (!config.apiKey) return false;

                    const app = initializeApp(config);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    
                    await signInAnonymously(auth);

                    window.FB.app = app;
                    window.FB.db = db;
                    console.log("Firebase Inizializzato");
                    return true;
                } catch (e) {
                    console.error("Errore Init Firebase", e);
                    return false;
                }
            },
            getDocs, collection, doc, setDoc, deleteDoc, addDoc, query, orderBy, limit, writeBatch
        };
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; color: #0f172a; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .toast-enter { transform: translateX(100%); opacity: 0; }
        .toast-enter-active { transform: translateX(0); opacity: 1; transition: all 300ms; }
        @media print { 
            body * { visibility: hidden; } 
            #printable-area, #printable-area * { visibility: visible; } 
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; display: grid !important; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; } 
            .print-item { border: 1px dashed #ccc; padding: 10px; text-align: center; page-break-inside: avoid; display: flex; flex-direction: column; align-items: center; justify-content: center; } 
            #root, .toast-container { display: none !important; } 
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="printable-area" class="hidden"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const CONFIG_VERSION = 4;

        // --- COMPONENTS UI BASE ---
        const ToastContainer = ({ toasts }) => (
            <div className="fixed top-4 right-4 z-50 flex flex-col gap-2 toast-container">
                {toasts.map(t => (
                    <div key={t.id} className={`p-4 rounded-xl shadow-lg text-white font-bold min-w-[300px] animate-in slide-in-from-right ${t.type === 'error' ? 'bg-red-500' : 'bg-green-500'}`}>
                        {t.msg}
                    </div>
                ))}
            </div>
        );

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Barcode: <path d="M3 5v14M8 5v14M12 5v14M17 5v14M21 5v14" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>,
                ShoppingCart: <path d="M9 20a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm7 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-7-16L4 4 2 2M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Box: <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                TrendingUp: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><polyline points="17 6 23 6 23 12" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Trash: <><polyline points="3 6 5 6 21 6" fill="none" stroke="currentColor" strokeWidth="2"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" strokeWidth="2"/></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" strokeWidth="2"/><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2"/></>,
                Minus: <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2"/>,
                Check: <polyline points="20 6 9 17 4 12" fill="none" stroke="currentColor" strokeWidth="2"/>,
                Search: <><circle cx="11" cy="11" r="8" fill="none" stroke="currentColor" strokeWidth="2"/><line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" strokeWidth="2"/></>,
                Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Scale: <><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M7 21h10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 3v18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Printer: <><polyline points="6 9 6 2 18 2 18 9" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><rect x="6" y="14" width="12" height="8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                Tag: <><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><line x1="7" y1="7" x2="7.01" y2="7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                X: <><line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></>,
                Server: <><rect x="2" y="2" width="20" height="8" rx="2" ry="2" stroke="currentColor" strokeWidth="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2" stroke="currentColor" strokeWidth="2"/><line x1="6" y1="6" x2="6.01" y2="6" stroke="currentColor" strokeWidth="2"/><line x1="6" y1="18" x2="6.01" y2="18" stroke="currentColor" strokeWidth="2"/></>,
                Cloud: <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Refresh: <><polyline points="23 4 23 10 17 10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><polyline points="1 20 1 14 7 14" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                PieChart: <><path d="M21.21 15.89A10 10 0 1 1 8 2.83" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M22 12A10 10 0 0 0 12 2v10z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                DollarSign: <><line x1="12" y1="1" x2="12" y2="23" stroke="currentColor" strokeWidth="2"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" strokeWidth="2"/></>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" strokeWidth="2"/><line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" strokeWidth="2"/><line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" strokeWidth="2"/><line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" strokeWidth="2"/></>,
                List: <><line x1="8" y1="6" x2="21" y2="6" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="8" y1="12" x2="21" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="8" y1="18" x2="21" y2="18" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="3" y1="6" x2="3.01" y2="6" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="3" y1="12" x2="3.01" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="3" y1="18" x2="3.01" y2="18" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></>,
                Cable: <><path d="M17 21v-2a1 1 0 0 1-1-1v-1a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1a1 1 0 0 1-1 1v2" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><path d="M7 21v-2a1 1 0 0 0 1-1v-1a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v1a1 1 0 0 0 1 1v2" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><path d="M12 21v-2a1 1 0 0 0 1-1v-1a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v1a1 1 0 0 0 1 1v2" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><path d="M12 3a3 3 0 0 1 3 3v10" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><path d="M12 3a3 3 0 0 0-3 3v10" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></>
            };
            return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={`${className} shrink-0`}>{icons[name]}</svg>;
        };

        // --- MODAL E UTILS ---
        const Modal = ({ title, onClose, children }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                    <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <h3 className="font-bold text-lg text-slate-800">{title}</h3>
                        <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-500"><Icon name="X" size={20}/></button>
                    </div>
                    <div className="p-6 overflow-y-auto flex-1">{children}</div>
                </div>
            </div>
        );

        const NavBtn = ({ icon, active, onClick, label, color = "text-slate-500" }) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1.5 p-3 rounded-xl w-full shrink-0 transition-all ${active ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30' : 'hover:bg-slate-800/50 ' + color}`}>
                <Icon name={icon} className={active ? "text-white" : ""} size={24} />
                <span className="text-[10px] font-bold tracking-wide">{label}</span>
            </button>
        );

        const LoginModal = ({ password, onSuccess, onClose }) => {
            const [input, setInput] = useState("");
            return (
                <div className="fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                    <form onSubmit={e => { e.preventDefault(); if(input===password) onSuccess(); else setInput(""); }} className="bg-white p-8 rounded-3xl text-center w-full max-w-sm shadow-2xl transform transition-all">
                        <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6 text-slate-600 shrink-0"><Icon name="Settings" size={32} /></div>
                        <h3 className="text-xl font-bold mb-2 text-slate-800">Admin Login</h3>
                        <p className="text-xs text-slate-400 mb-6">Inserisci PIN di sicurezza</p>
                        <input type="password" value={input} onChange={e => setInput(e.target.value)} className="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl mb-6 text-center text-2xl tracking-widest focus:border-blue-500 outline-none transition-colors" placeholder="••••" autoFocus />
                        <button className="w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 transition-colors">Accedi</button>
                        <button type="button" onClick={onClose} className="mt-4 text-xs text-slate-400 hover:text-slate-600 font-bold uppercase tracking-wider">Annulla</button>
                    </form>
                </div>
            );
        };

        const getBaseUrl = (config) => {
            if (!config.serverUrl || config.serverUrl.trim() === "") return 'http://127.0.0.1:5500';
            return config.serverUrl.replace(/\/$/, "");
        };

        // --- DATA ADAPTER ---
        const DataAdapter = {
            async getProducts(config) {
                if (config.storageMode === 'firebase') {
                    if(!window.FB || !window.FB.db) return [];
                    const q = window.FB.query(window.FB.collection(window.FB.db, "products"));
                    const snapshot = await window.FB.getDocs(q);
                    return snapshot.docs.map(doc => doc.data());
                }
                if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    for(let i=0; i<3; i++) {
                        try {
                            const res = await fetch(`${url}/api/products`);
                            if(!res.ok) throw new Error("Server Error");
                            return await res.json();
                        } catch(e) {
                            if (i === 2) throw e;
                            await new Promise(r => setTimeout(r, 500));
                        }
                    }
                }
                return JSON.parse(localStorage.getItem('products')) || [];
            },
            async saveProduct(config, product) {
                if (config.storageMode === 'firebase') {
                    if(!window.FB || !window.FB.db) throw new Error("Firebase non inizializzato");
                    await window.FB.setDoc(window.FB.doc(window.FB.db, "products", product.code), product);
                } else if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    await fetch(`${url}/api/products`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(product) });
                }
            },
            async deleteProduct(config, code) {
                if (config.storageMode === 'firebase') {
                    await window.FB.deleteDoc(window.FB.doc(window.FB.db, "products", code));
                } else if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    await fetch(`${url}/api/products/${code}`, { method: 'DELETE' });
                }
            },
            async saveLog(config, log) {
                if (config.storageMode === 'firebase') {
                    await window.FB.addDoc(window.FB.collection(window.FB.db, "logs"), log);
                } else if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    await fetch(`${url}/api/logs`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(log) });
                }
            },
            async getLogs(config) { 
                if (config.storageMode === 'firebase') {
                    if(!window.FB || !window.FB.db) return [];
                    const q = window.FB.query(window.FB.collection(window.FB.db, "logs"), window.FB.orderBy("date", "desc"), window.FB.limit(200));
                    const snapshot = await window.FB.getDocs(q);
                    return snapshot.docs.map(doc => doc.data());
                }
                if (config.storageMode === 'server') { 
                    const url = getBaseUrl(config); 
                    try {
                        const res = await fetch(`${url}/api/logs`);
                        if(!res.ok) throw new Error("Failed");
                        return await res.json(); 
                    } catch (e) { return []; }
                } 
                return JSON.parse(localStorage.getItem('logs')) || []; 
            },
            async getCategories(config) {
                if (config.storageMode === 'firebase') {
                    const q = window.FB.query(window.FB.collection(window.FB.db, "categories"));
                    const snapshot = await window.FB.getDocs(q);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    const res = await fetch(`${url}/api/categories`);
                    return await res.json();
                }
                return [];
            },
            async addCategory(config, name) {
                if (config.storageMode === 'firebase') {
                    await window.FB.addDoc(window.FB.collection(window.FB.db, "categories"), { name });
                } else if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    await fetch(`${url}/api/categories`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name }) });
                }
            },
            async deleteCategory(config, id) {
                if (config.storageMode === 'firebase') {
                    await window.FB.deleteDoc(window.FB.doc(window.FB.db, "categories", id));
                } else if (config.storageMode === 'server') {
                    const url = getBaseUrl(config);
                    await fetch(`${url}/api/categories/${id}`, { method: 'DELETE' });
                }
            },
            async migrateLocalToCloud(config) {
                if (!window.FB || !window.FB.db) throw new Error("Firebase non connesso");
                const localProds = JSON.parse(localStorage.getItem('products')) || [];
                const localLogs = JSON.parse(localStorage.getItem('logs')) || [];
                let count = 0;
                for (let p of localProds) {
                    await window.FB.setDoc(window.FB.doc(window.FB.db, "products", p.code), p);
                    count++;
                }
                for (let l of localLogs) {
                    await window.FB.addDoc(window.FB.collection(window.FB.db, "logs"), l);
                }
                return count;
            },

            // --- NUOVE API BILANCIA ---
            async getScaleWeight(config) {
                const url = getBaseUrl(config);
                try {
                    const res = await fetch(`${url}/api/scale/read`);
                    if (!res.ok) return null;
                    return await res.json();
                } catch (e) {
                    return null;
                }
            },
            async setScaleConfig(config, port, baudrate) {
                const url = getBaseUrl(config);
                try {
                    await fetch(`${url}/api/scale/config`, { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ port, baudrate }) 
                    });
                } catch (e) {
                    throw new Error("Impossibile salvare configurazione bilancia (Server offline?)");
                }
            },
            async getScaleConfig(config) {
                const url = getBaseUrl(config);
                try {
                    const res = await fetch(`${url}/api/scale/config`);
                    if (!res.ok) return {};
                    return await res.json();
                } catch { return {}; }
            }
        };

        const printLabel = (product) => {
            const printArea = document.getElementById('printable-area');
            printArea.innerHTML = `<div id="printable-label" style="text-align: center; font-family: monospace; width: 300px; padding: 20px; border: 1px dashed black;"><h2 style="margin: 0; font-size: 18px;">${product.name}</h2><p style="margin: 5px 0;">Cod: ${product.code}</p><svg id="barcode-render"></svg><h1 style="margin: 10px 0; font-size: 32px;">€ ${parseFloat(product.price).toFixed(2)}</h1><p style="font-size: 10px;">${product.isWeighable ? 'ARTICOLO A PESO (Prezzo al Kg)' : 'PREZZO CAD.'}</p></div>`;
            try { JsBarcode("#barcode-render", product.code, { format: "CODE128", height: 50, displayValue: false }); window.print(); } catch (e) { alert("Errore barcode: " + e.message); }
        };

        const printReport = (products, categoryFilter) => {
            const printArea = document.getElementById('printable-area');
            let itemsToPrint = products;
            if (categoryFilter && categoryFilter !== 'Tutte') {
                itemsToPrint = products.filter(p => p.category === categoryFilter);
            }

            if(itemsToPrint.length === 0) return alert("Nessun prodotto trovato per questa categoria.");

            let htmlContent = `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px;">`;
            itemsToPrint.forEach((p, index) => {
                htmlContent += `
                    <div class="print-item" style="border: 1px dashed #ccc; padding: 10px; text-align: center; page-break-inside: avoid;">
                        <div style="font-weight: bold; font-size: 14px;">${p.name}</div>
                        <svg id="bc-${index}" style="width: 100%; max-width: 150px;"></svg>
                        <div style="font-size: 12px;">${p.code}</div>
                        <div style="font-weight: bold;">€ ${parseFloat(p.price).toFixed(2)}</div>
                    </div>
                `;
            });
            htmlContent += `</div>`;
            printArea.innerHTML = htmlContent;

            setTimeout(() => {
                itemsToPrint.forEach((p, index) => {
                    try { JsBarcode(`#bc-${index}`, p.code, { format: "CODE128", height: 40, displayValue: false, margin: 0 }); } catch(e) {}
                });
                window.print();
            }, 500);
        };

        // --- VISTE ---
        const POSView = ({ products, cart, setCart, onCheckout, config }) => {
            const [input, setInput] = useState(""); 
            const [searchMode, setSearchMode] = useState(false); 
            const [searchTerm, setSearchTerm] = useState(""); 
            const [weightItem, setWeightItem] = useState(null); 
            const [weightInput, setWeightInput] = useState(""); 
            const [liveWeight, setLiveWeight] = useState(null); 
            const inputRef = useRef(null);
            const scaleInterval = useRef(null);

            useEffect(() => { if (!weightItem && !searchMode) inputRef.current?.focus(); }, [cart, weightItem, searchMode]);
            
            useEffect(() => {
                if (weightItem) {
                    setLiveWeight(null);
                    scaleInterval.current = setInterval(async () => {
                        const data = await DataAdapter.getScaleWeight(config);
                        if (data && !data.error && data.weight > 0) {
                            setLiveWeight(data.weight);
                        }
                    }, 500); 
                } else {
                    if (scaleInterval.current) clearInterval(scaleInterval.current);
                }
                return () => { if (scaleInterval.current) clearInterval(scaleInterval.current); };
            }, [weightItem, config]);

            const handleScan = (e) => { if (e.key === 'Enter') { if(!input.trim()) return; processItemAdd(input.trim()); setInput(""); } };
            
            const processItemAdd = (code) => { 
                const clean = code.toString().trim();
                const p = products.find(x => x.code === clean) || products.find(x => x.name.toLowerCase() === clean.toLowerCase()); 
                if (!p) return alert("Non trovato: " + clean); 
                if (p.isWeighable) { setWeightItem(p); setWeightInput(""); return; } 
                addToCart(p, 1); 
            };
            
            const addToCart = (p, q) => { 
                const ex = cart.find(x => x.code === p.code); 
                if(ex) setCart(cart.map(x => x.code === p.code ? {...x, qty: x.qty + q} : x)); 
                else setCart([...cart, {...p, qty: q}]); 
            };
            
            const handleWeightConfirm = (w) => { 
                const finalW = parseFloat(w); 
                if (!finalW || finalW <= 0) return alert("Peso non valido"); 
                addToCart(weightItem, finalW); 
                setWeightItem(null); 
                setSearchMode(false); 
            };
            
            const total = cart.reduce((a, b) => a + (b.price * b.qty), 0); 
            const filtered = products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
            
            return (
                <div className="flex h-full p-4 gap-4 relative">
                    <div className="flex-1 flex flex-col gap-4">
                        <div className="flex gap-2">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex items-center gap-4 flex-1">
                                <Icon name="Barcode" className="text-slate-400"/>
                                <input ref={inputRef} type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={handleScan} className="flex-1 text-2xl font-mono outline-none placeholder:text-slate-300" placeholder="Spara codice..." />
                            </div>
                            <button onClick={() => { setSearchMode(!searchMode); setSearchTerm(""); }} className={`px-6 rounded-2xl font-bold border transition-all flex items-center gap-2 ${searchMode ? 'bg-blue-100 text-blue-600 border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>
                                <Icon name="Search" /> {searchMode ? 'Chiudi' : 'Cerca'}
                            </button>
                        </div>

                        {searchMode && (
                            <div className="bg-white rounded-2xl shadow-lg border border-blue-100 flex flex-col h-64 animate-in fade-in absolute top-24 left-6 right-[24rem] z-10">
                                <div className="p-3 border-b border-slate-100 flex gap-2"><input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full outline-none font-bold text-lg" placeholder="Scrivi nome..." autoFocus /></div>
                                <div className="overflow-y-auto p-2">{filtered.map(p => (<button key={p.code} onClick={() => { processItemAdd(p.code); setSearchMode(false); }} className="w-full text-left p-3 hover:bg-blue-50 rounded-xl flex justify-between group"><div><div className="font-bold text-slate-700">{p.name}</div><div className="text-xs text-slate-400">{p.code}</div></div><div className="font-mono font-bold">€{parseFloat(p.price).toFixed(2)}</div></button>))}</div>
                            </div>
                        )}

                        <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                            <div className="bg-slate-50/80 backdrop-blur p-4 text-xs font-bold text-slate-500 uppercase flex justify-between sticky top-0"><span>Prodotti ({cart.length})</span><span>Importo</span></div>
                            <div className="flex-1 overflow-y-auto p-3 space-y-3">
                                {cart.map(item => (
                                    <div key={item.code} className="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-xl hover:border-blue-200 transition-colors group">
                                        <div className="flex-1">
                                            <div className="font-bold text-slate-800">{item.name}</div>
                                            <div className="text-xs text-slate-400 flex items-center gap-2">{item.code} {item.isWeighable && <span className="bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded text-[10px] font-bold">PESO</span>}</div>
                                        </div>
                                        <div className="flex items-center gap-6">
                                            <div className="flex items-center bg-slate-50 rounded-lg border border-slate-200 p-1">
                                                <button onClick={() => setCart(cart.map(c => c.code === item.code ? {...c, qty: Math.max(0, c.qty - 1)} : c).filter(c=>c.qty>0))} className="p-2 hover:bg-white hover:shadow-sm rounded-md text-slate-500"><Icon name="Minus" size={14}/></button>
                                                <span className="w-10 text-center font-mono font-bold">{item.qty}</span>
                                                <button onClick={() => setCart(cart.map(c => c.code === item.code ? {...c, qty: c.qty + 1} : c))} className="p-2 hover:bg-white hover:shadow-sm rounded-md text-blue-600"><Icon name="Plus" size={14}/></button>
                                            </div>
                                            <div className="w-24 text-right font-mono font-bold text-xl">€{(item.price * item.qty).toFixed(2)}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="w-80 bg-[#0f172a] text-white rounded-2xl p-8 flex flex-col justify-between shadow-2xl">
                        <div>
                            <div className="text-slate-400 font-bold uppercase text-xs tracking-widest mb-2">Totale Scontrino</div>
                            <div className="text-6xl font-mono font-bold tracking-tighter">€{total.toFixed(2)}</div>
                            <div className="mt-8 pt-8 border-t border-slate-700 space-y-3 text-sm text-slate-400">
                                <div className="flex justify-between"><span>Articoli</span><span className="text-white font-bold">{cart.reduce((a,b)=>a+b.qty,0)}</span></div>
                                <div className="flex justify-between"><span>Imponibile</span><span className="text-white font-bold">€{(total/1.22).toFixed(2)}</span></div>
                                <div className="flex justify-between"><span>IVA 22%</span><span className="text-white font-bold">€{(total - total/1.22).toFixed(2)}</span></div>
                            </div>
                        </div>
                        <button onClick={onCheckout} disabled={cart.length === 0} className="w-full py-5 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:shadow-lg hover:shadow-blue-900/50 text-lg">
                            <Icon name="Check" /> INCASSA
                        </button>
                    </div>

                    {weightItem && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                            <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center animate-in fade-in zoom-in duration-200 relative">
                                <button onClick={() => setWeightItem(null)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="X" size={24}/></button>
                                
                                <div className="w-20 h-20 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-500 shadow-inner">
                                    <Icon name="Scale" size={40}/>
                                </div>
                                <h3 className="text-2xl font-bold mb-1 text-slate-800">{weightItem.name}</h3>
                                <p className="text-slate-400 text-sm mb-6">Inserisci il peso netto</p>
                                
                                {/* LIVE WEIGHT DISPLAY */}
                                {liveWeight !== null ? (
                                    <div className="mb-6 animate-pulse-ring bg-green-50 border-2 border-green-500 text-green-700 p-4 rounded-2xl">
                                        <div className="text-xs font-bold uppercase tracking-wide mb-1">Bilancia Connessa</div>
                                        <div className="text-5xl font-mono font-bold">{liveWeight.toFixed(3)} <span className="text-lg">kg</span></div>
                                        <button onClick={() => handleWeightConfirm(liveWeight)} className="mt-3 w-full py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-500">USA QUESTO PESO</button>
                                    </div>
                                ) : (
                                    <div className="mb-6 relative">
                                        <input type="number" step="0.001" value={weightInput} onChange={e => setWeightInput(e.target.value)} onKeyDown={e => {if(e.key==='Enter') handleWeightConfirm(e.target.value)}} className="w-full text-center text-6xl font-mono font-bold border-b-4 border-slate-100 focus:border-orange-500 outline-none pb-2 bg-transparent text-slate-800" placeholder="0.000" autoFocus />
                                        <span className="absolute right-0 bottom-4 text-slate-400 font-bold">kg</span>
                                    </div>
                                )}
                                
                                <div className="grid grid-cols-1 gap-4">
                                    <button onClick={() => handleWeightConfirm(weightInput)} className="py-4 bg-orange-500 text-white font-bold rounded-xl hover:bg-orange-400 shadow-lg shadow-orange-200 transition-all w-full">CONFERMA MANUALE</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const InventoryView = ({ products, onUpdate, onCreate, onDelete, refresh, categories, addCat, delCat }) => {
            const [search, setSearch] = useState(""); 
            const [editItem, setEditItem] = useState(null); 
            const [isNew, setIsNew] = useState(false); 
            const [offerItem, setOfferItem] = useState(null);
            const [printMode, setPrintMode] = useState(false); 
            const [categoryFilter, setCategoryFilter] = useState("Tutte");

            const filtered = products.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) || p.code.includes(search));
            const generateCode = () => setEditItem(prev => ({ ...prev, code: `200${Math.floor(10000 + Math.random() * 90000)}` }));
            
            return (
                <div className="h-full flex flex-col p-6 gap-6">
                    <div className="flex justify-between gap-4">
                        <div className="flex items-center gap-3 bg-white px-5 py-3 rounded-xl shadow-sm border border-slate-200 flex-1 transition-all focus-within:border-blue-500 focus-within:ring-4 focus-within:ring-blue-500/10">
                            <Icon name="Search" className="text-slate-400"/><input value={search} onChange={e => setSearch(e.target.value)} placeholder="Cerca prodotto..." className="bg-transparent outline-none flex-1 font-medium" />
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setPrintMode(!printMode)} className={`px-4 py-2 rounded-xl font-bold flex gap-2 items-center transition-colors ${printMode ? 'bg-purple-600 text-white' : 'bg-white border border-purple-200 text-purple-600 hover:bg-purple-50'}`}>
                                <Icon name="Printer"/> {printMode ? 'Chiudi Stampe' : 'Report'}
                            </button>
                            <button onClick={refresh} className="bg-slate-200 hover:bg-slate-300 text-slate-600 px-4 py-2 rounded-xl font-bold flex gap-2 items-center"><Icon name="Refresh"/> Aggiorna</button>
                            <button onClick={() => { setEditItem({ code: "", name: "", price: "", cost: "", stock: 0, isWeighable: false, category: "" }); setIsNew(true); }} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-blue-900/20 transition-transform active:scale-95"><Icon name="Plus"/> Nuovo</button>
                        </div>
                    </div>

                    {printMode && (
                        <div className="bg-purple-50 p-6 rounded-2xl border border-purple-200 animate-in fade-in slide-in-from-top-4">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-lg text-purple-800 flex items-center gap-2"><Icon name="Printer"/> Centro Stampe - Book Cassa</h3>
                                <button onClick={() => printReport(products, categoryFilter)} className="bg-purple-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg hover:bg-purple-500">STAMPA FOGLIO A4</button>
                            </div>
                            <div className="flex gap-2 overflow-x-auto pb-2">
                                <button onClick={() => setCategoryFilter("Tutte")} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap ${categoryFilter === "Tutte" ? 'bg-purple-600 text-white' : 'bg-white text-purple-600 border border-purple-200'}`}>Tutte</button>
                                {categories.map(cat => (
                                    <button key={cat.id} onClick={() => setCategoryFilter(cat.name)} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap ${categoryFilter === cat.name ? 'bg-purple-600 text-white' : 'bg-white text-purple-600 border border-purple-200'}`}>
                                        {cat.name}
                                    </button>
                                ))}
                            </div>
                            <p className="text-xs text-purple-400 mt-2">Seleziona una categoria per stampare i barcode relativi.</p>
                        </div>
                    )}

                    {!printMode && (
                        <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="grid grid-cols-12 bg-slate-50 p-4 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200">
                                <div className="col-span-5">Prodotto</div>
                                <div className="col-span-3">Categoria</div>
                                <div className="col-span-2 text-right">Prezzo</div>
                                <div className="col-span-2 text-center">Azioni</div>
                            </div>
                            <div className="overflow-y-auto h-full pb-10">
                                {filtered.map(p => (
                                    <div key={p.code} className="grid grid-cols-12 p-4 border-b border-slate-100 items-center hover:bg-blue-50/50 transition-colors group">
                                        <div className="col-span-5">
                                            <div className="font-bold text-slate-800">{p.name}</div>
                                            <div className="text-xs text-slate-400 flex gap-2 mt-1 items-center">
                                                <span className="font-mono bg-slate-100 px-1.5 py-0.5 rounded">{p.code}</span>
                                                {p.isWeighable && <span className="bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded font-bold">PESO</span>}
                                                {p.originalPrice && <span className="text-[10px] bg-red-100 text-red-600 px-1 rounded">OFFERTA</span>}
                                            </div>
                                        </div>
                                        <div className="col-span-3">
                                            <span className="text-xs font-bold bg-slate-100 text-slate-600 px-2 py-1 rounded-full">{p.category || "Generale"}</span>
                                        </div>
                                        <div className="col-span-2 text-right font-mono font-bold text-slate-700">€{parseFloat(p.price).toFixed(2)}</div>
                                        <div className="col-span-2 flex justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => printLabel(p)} className="p-2 hover:bg-white hover:shadow text-slate-500 rounded-lg"><Icon name="Barcode" size={16}/></button>
                                            <button onClick={() => { setEditItem(p); setIsNew(false); }} className="p-2 hover:bg-white hover:shadow text-blue-600 rounded-lg"><Icon name="Edit" size={16}/></button>
                                            <button onClick={() => onDelete(p.code)} className="p-2 hover:bg-white hover:shadow text-red-500 rounded-lg"><Icon name="Trash" size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {editItem && <Modal title={isNew ? "Nuovo" : "Modifica"} onClose={() => setEditItem(null)}>
                        <form onSubmit={e => { e.preventDefault(); isNew ? onCreate(editItem) : onUpdate(editItem); setEditItem(null); }} className="space-y-5">
                            <div className="flex gap-3 items-end">
                                <div className="flex-1 space-y-1"><label className="text-xs font-bold text-slate-500 uppercase">Barcode</label><input value={editItem.code} onChange={e => setEditItem({...editItem, code: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl font-mono focus:border-blue-500 outline-none" required disabled={!isNew} placeholder="Scan..." /></div>
                                {isNew && <button type="button" onClick={generateCode} className="bg-slate-100 hover:bg-slate-200 text-slate-600 p-3.5 rounded-xl font-bold text-xs transition-colors">GENERA</button>}
                            </div>
                            <div className="space-y-1"><label className="text-xs font-bold text-slate-500 uppercase">Nome</label><input value={editItem.name} onChange={e => setEditItem({...editItem, name: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl focus:border-blue-500 outline-none" required /></div>
                            
                            <div className="space-y-1">
                                <label className="text-xs font-bold text-slate-500 uppercase">Categoria</label>
                                <input list="cat-list" value={editItem.category || ""} onChange={e => setEditItem({...editItem, category: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl focus:border-blue-500 outline-none" placeholder="Generale"/>
                                <datalist id="cat-list">
                                    {categories.map(c => <option key={c.id} value={c.name}/>)}
                                </datalist>
                            </div>

                            <label className="flex items-center gap-3 p-4 border border-orange-200 bg-orange-50 rounded-xl cursor-pointer hover:bg-orange-100 transition-colors">
                                <input type="checkbox" checked={editItem.isWeighable} onChange={e => setEditItem({...editItem, isWeighable: e.target.checked})} className="w-5 h-5 accent-orange-500"/>
                                <div className="text-sm font-bold text-orange-800 flex items-center"><Icon name="Scale" size={18} className="mr-2"/> Vendita a Peso (Bilancia)</div>
                            </label>
                            <div className="grid grid-cols-3 gap-4">
                                <div className="space-y-1"><label className="text-[10px] font-bold text-slate-500 uppercase">Prezzo Vendita</label><input type="number" step="0.01" value={editItem.price} onChange={e => setEditItem({...editItem, price: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl font-bold text-blue-600" required /></div>
                                <div className="space-y-1"><label className="text-[10px] font-bold text-slate-500 uppercase">Costo Acquisto</label><input type="number" step="0.01" value={editItem.cost} onChange={e => setEditItem({...editItem, cost: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl font-bold text-slate-600" required /></div>
                                <div className="space-y-1"><label className="text-[10px] font-bold text-slate-500 uppercase">Giacenza</label><input type="number" value={editItem.stock} onChange={e => setEditItem({...editItem, stock: e.target.value})} className="w-full border border-slate-300 p-3 rounded-xl font-bold text-slate-600" required /></div>
                            </div>
                            <button className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-900/20 hover:bg-blue-500 transition-all">Salva Prodotto</button>
                        </form>
                    </Modal>}
                    
                    {offerItem && <Modal title="Applica Offerta" onClose={() => setOfferItem(null)}><div className="space-y-4"><div className="bg-slate-50 p-4 rounded-xl"><h4 className="font-bold">{offerItem.name}</h4><p className="text-sm">Prezzo attuale: <span className="font-mono font-bold">€{parseFloat(offerItem.price).toFixed(2)}</span></p></div><div className="grid grid-cols-3 gap-2"><button onClick={() => setOfferItem({...offerItem, newPrice: (offerItem.price * 0.9).toFixed(2)})} className="p-2 border rounded-lg hover:bg-slate-50">-10%</button><button onClick={() => setOfferItem({...offerItem, newPrice: (offerItem.price * 0.8).toFixed(2)})} className="p-2 border rounded-lg hover:bg-slate-50">-20%</button><button onClick={() => setOfferItem({...offerItem, newPrice: (offerItem.price * 0.5).toFixed(2)})} className="p-2 border rounded-lg hover:bg-slate-50">-50%</button></div><div><label className="text-xs font-bold text-slate-500 uppercase">Nuovo Prezzo</label><input type="number" step="0.01" value={offerItem.newPrice || ""} onChange={e => setOfferItem({...offerItem, newPrice: e.target.value})} className="w-full border-2 border-orange-400 p-3 rounded-lg text-2xl font-bold text-orange-600 text-center" placeholder="€ 0.00" /></div><div className="flex gap-2 pt-4"><button onClick={() => { const original = offerItem.originalPrice || offerItem.price; onUpdate({ ...offerItem, price: original, originalPrice: null }); setOfferItem(null); }} className="flex-1 bg-slate-200 text-slate-700 py-3 rounded-xl font-bold">Rimuovi Offerta</button><button onClick={() => { if(!offerItem.newPrice) return; const original = offerItem.originalPrice || offerItem.price; onUpdate({ ...offerItem, price: offerItem.newPrice, originalPrice: original }); setOfferItem(null); }} className="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold">Applica</button></div></div></Modal>}
                </div>
            );
        };

        const SettingsView = ({ config, setConfig, serverStatus, categories, addCat, delCat, onMigrate }) => {
            // Stato locale per la config della bilancia
            const [scalePort, setScalePort] = useState("");
            const [scaleBaud, setScaleBaud] = useState(9600);

            useEffect(() => {
                // Carica config bilancia all'apertura
                if(config.storageMode !== 'local') {
                    DataAdapter.getScaleConfig(config).then(c => {
                        if(c.port) setScalePort(c.port);
                        if(c.baudrate) setScaleBaud(c.baudrate);
                    });
                }
            }, []);

            const saveScale = async () => {
                try {
                    await DataAdapter.setScaleConfig(config, scalePort, scaleBaud);
                    alert("Configurazione Bilancia Salvata");
                } catch(e) {
                    alert(e.message);
                }
            };

            return (<div className="max-w-2xl mx-auto p-8 flex flex-col lg:flex-row gap-6 h-full overflow-y-auto"><div className="flex-1 space-y-6"><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><h2 className="text-xl font-bold text-slate-800 mb-4">Generale</h2><div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Nome Negozio</label><input type="text" value={config.shopName} onChange={e => setConfig({...config, shopName: e.target.value})} className="w-full border p-3 rounded-xl outline-none focus:border-blue-500 font-bold text-slate-700" /></div></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="Settings" className="text-slate-400"/> Configurazione Database</h2><div className="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-200 mb-6"><span className="text-sm text-slate-500 font-medium">Stato Connessione</span><span className={`font-bold px-3 py-1 rounded-full text-xs ${serverStatus === 'online' ? 'bg-green-100 text-green-700' : serverStatus === 'local' ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}`}>{serverStatus === 'online' ? 'CONNESSO' : serverStatus === 'local' ? 'LOCALE' : 'OFFLINE'}</span></div><label className="block text-xs font-bold text-slate-400 uppercase mb-2">Modalità di Archiviazione</label><div className="grid grid-cols-3 gap-2 mb-6">{['local', 'server', 'firebase'].map(mode => (<button key={mode} onClick={() => setConfig({...config, storageMode: mode})} className={`p-3 rounded-xl border text-xs font-bold transition-all flex flex-col items-center gap-2 ${config.storageMode === mode ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}><Icon name={mode === 'local' ? 'Box' : mode === 'server' ? 'Server' : 'Cloud'} size={20}/>{mode.toUpperCase()}</button>))}</div>{config.storageMode === 'server' && (<div className="animate-in fade-in slide-in-from-top-2"><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Indirizzo Server Locale (Python)</label><input type="text" value={config.serverUrl} onChange={e => setConfig({...config, serverUrl: e.target.value})} className="w-full border p-3 rounded-xl font-mono text-sm outline-none focus:border-blue-500" placeholder="http://127.0.0.1:5500" /></div>)}{config.storageMode === 'firebase' && (<div className="animate-in fade-in slide-in-from-top-2 space-y-4"><div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Configurazione Firebase (JSON)</label><textarea className="w-full border p-3 rounded-xl text-xs font-mono h-48 outline-none focus:border-orange-500 resize-y" placeholder='{ "apiKey": "...", "authDomain": "..." }' value={typeof config.firebaseConfig === 'object' ? JSON.stringify(config.firebaseConfig, null, 2) : config.firebaseConfig || ''} onChange={e => { try { const parsed = JSON.parse(e.target.value); setConfig({...config, firebaseConfig: parsed}); if(window.FB && window.FB.init(parsed)) alert("Firebase Connesso!"); } catch(err) { setConfig({...config, firebaseConfig: e.target.value}); } }} /><p className="text-[10px] text-slate-400 mt-2 leading-relaxed">Vai sulla Console Firebase &gt; Impostazioni Progetto &gt; Generali &gt; Le tue app &gt; Configurazione. Copia l'oggetto JSON e incollalo qui.</p></div><button onClick={onMigrate} className="w-full py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 transition-all"><Icon name="Cloud" /> 📤 CARICA DATI LOCALI SU CLOUD</button></div>)}</div>
                    
                    {/* SEZIONE PERIFERICHE (BILANCIA) */}
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="Scale" className="text-slate-400"/> Periferiche (Bilancia)</h2>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Porta Seriale</label><input placeholder="es. COM3 o /dev/ttyUSB0" value={scalePort} onChange={e => setScalePort(e.target.value)} className="w-full border p-3 rounded-xl outline-none focus:border-blue-500 font-mono text-sm"/></div>
                            <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Baud Rate</label><input type="number" value={scaleBaud} onChange={e => setScaleBaud(parseInt(e.target.value))} className="w-full border p-3 rounded-xl outline-none focus:border-blue-500 font-mono text-sm"/></div>
                        </div>
                        <button onClick={saveScale} className="w-full py-3 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-700 transition-colors">Salva Configurazione Bilancia</button>
                    </div>

                </div><div className="w-full lg:w-80 shrink-0"><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 h-full flex flex-col"><h3 className="font-bold text-lg mb-4 text-slate-700">Categorie</h3><div className="flex gap-2 mb-4"><input id="newCat" placeholder="Nuova..." className="w-full border p-2 rounded-lg text-sm outline-none focus:border-blue-500"/><button onClick={() => { const el=document.getElementById('newCat'); if(el.value) { addCat(el.value); el.value=''; }}} className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700"><Icon name="Plus" size={16}/></button></div><div className="flex-1 overflow-y-auto space-y-2 max-h-96 lg:max-h-none pr-1">{categories.map(c => (<div key={c.id} className="flex justify-between items-center p-3 bg-slate-50 rounded-lg text-sm group hover:bg-slate-100 transition-colors"><span className="font-medium text-slate-700">{c.name}</span><button onClick={() => delCat(c.id)} className="text-slate-400 hover:text-red-500 transition-colors"><Icon name="Trash" size={14}/></button></div>))}</div></div></div></div>);
        };

        const DashboardView = ({ config, refreshTrigger }) => {
            const [stats, setStats] = useState({ dailyTotal: 0, dailyProfit: 0, totalTx: 0, weeklyData: [] }); const [loading, setLoading] = useState(true);
            useEffect(() => { const loadStats = async () => { setLoading(true); try { const logs = await DataAdapter.getLogs(config); const today = new Date().toISOString().split('T')[0]; const todayLogs = logs.filter(l => l.date.startsWith(today)); const dailyTotal = todayLogs.reduce((acc, l) => acc + l.total, 0); const totalTx = todayLogs.length; let dailyProfit = 0; todayLogs.forEach(log => { log.items.forEach(item => { const cost = item.cost || 0; dailyProfit += (item.price - cost) * item.qty; }); }); const last7Days = [...Array(7)].map((_, i) => { const d = new Date(); d.setDate(d.getDate() - i); return d.toISOString().split('T')[0]; }).reverse(); const weeklyData = last7Days.map(date => { const dayLogs = logs.filter(l => l.date.startsWith(date)); const dayTotal = dayLogs.reduce((acc, l) => acc + l.total, 0); let dayProfit = 0; dayLogs.forEach(log => { log.items.forEach(item => { dayProfit += ((item.price || 0) - (item.cost || 0)) * item.qty; }); }); return { name: date.slice(5), vendite: dayTotal, profitto: dayProfit }; }); setStats({ dailyTotal, dailyProfit, totalTx, weeklyData }); } catch (e) { console.error(e); } setLoading(false); }; loadStats(); }, [refreshTrigger, config]);
            const renderCharts = () => { if (!window.Recharts) return <div className="flex items-center justify-center h-full text-slate-400">Caricamento Grafici...</div>; const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = window.Recharts; return (<ResponsiveContainer width="100%" height="100%"><AreaChart data={stats.weeklyData}><defs><linearGradient id="colorVendite" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#3b82f6" stopOpacity={0.8}/><stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/></linearGradient><linearGradient id="colorProfitto" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#10b981" stopOpacity={0.8}/><stop offset="95%" stopColor="#10b981" stopOpacity={0}/></linearGradient></defs><XAxis dataKey="name" stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} /><YAxis stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} tickFormatter={(val) => `€${val}`}/><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" /><Tooltip contentStyle={{borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)'}} /><Area type="monotone" dataKey="vendite" stroke="#3b82f6" strokeWidth={3} fillOpacity={1} fill="url(#colorVendite)" name="Incasso" /><Area type="monotone" dataKey="profitto" stroke="#10b981" strokeWidth={3} fillOpacity={1} fill="url(#colorProfitto)" name="Utile" /></AreaChart></ResponsiveContainer>); };
            return (<div className="h-full flex flex-col p-8 gap-8 overflow-y-auto"><div className="flex justify-between items-center"><h2 className="text-3xl font-bold text-slate-800">Dashboard Finanziaria</h2><div className="text-sm text-slate-500 font-mono">{new Date().toLocaleDateString()}</div></div><div className="grid grid-cols-1 md:grid-cols-3 gap-6"><div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="DollarSign" size={60} className="text-green-500"/></div><span className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-1">Incasso Oggi</span><span className="text-4xl font-bold text-slate-800">€{stats.dailyTotal.toFixed(2)}</span><div className="mt-4 text-xs font-bold text-green-600 flex items-center gap-1 bg-green-50 w-fit px-2 py-1 rounded-lg"><Icon name="TrendingUp" size={14}/> Aggiornato Live</div></div><div className="bg-gradient-to-br from-blue-600 to-indigo-700 p-6 rounded-3xl shadow-lg shadow-blue-900/20 flex flex-col text-white relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-20"><Icon name="PieChart" size={60} className="text-white"/></div><span className="text-sm font-bold text-blue-100 uppercase tracking-wider mb-1">Utile Netto Oggi</span><span className="text-4xl font-bold">€{stats.dailyProfit.toFixed(2)}</span><div className="mt-4 text-xs font-bold text-blue-200 flex items-center gap-1 bg-white/10 w-fit px-2 py-1 rounded-lg">Margine: {stats.dailyTotal > 0 ? ((stats.dailyProfit/stats.dailyTotal)*100).toFixed(1) : 0}%</div></div><div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="ShoppingCart" size={60} className="text-orange-500"/></div><span className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-1">Scontrini</span><span className="text-4xl font-bold text-slate-800">{stats.totalTx}</span><div className="mt-4 text-xs font-bold text-slate-500 flex items-center gap-1 bg-slate-100 w-fit px-2 py-1 rounded-lg">Transazioni totali</div></div></div><div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex-1 min-h-[300px] flex flex-col"><h3 className="font-bold text-lg text-slate-700 mb-6 flex items-center gap-2"><Icon name="TrendingUp"/> Andamento Settimanale</h3><div className="flex-1 w-full h-full">{renderCharts()}</div></div><div className="grid grid-cols-2 md:grid-cols-4 gap-4">{['Analisi Prodotti', 'Registro IVA', 'Vendite Orarie', 'Export Excel'].map((report, i) => (<button key={i} className="p-4 bg-white border border-slate-200 rounded-xl hover:border-blue-500 hover:shadow-md transition-all text-left group"><div className="bg-slate-100 w-10 h-10 rounded-lg flex items-center justify-center mb-3 group-hover:bg-blue-100 text-slate-500 group-hover:text-blue-600 transition-colors"><Icon name="Box" size={20}/></div><div className="font-bold text-slate-700 text-sm">{report}</div><div className="text-[10px] text-slate-400 mt-1">Clicca per generare</div></button>))}</div></div>);
        };

        // --- APP MAIN WRAPPER ---
        const App = () => {
            const [view, setView] = useState('pos');
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState([]);
            const [logs, setLogs] = useState([]);
            const [categories, setCategories] = useState([]); 
            const [toasts, setToasts] = useState([]);
            const [refreshDashboard, setRefreshDashboard] = useState(0);
            
            const [config, setConfig] = useState(() => {
                const savedStr = localStorage.getItem('config');
                const defaultConf = { shopName: "MarketOS", tax: 22, adminPass: "1234", storageMode: 'server', serverUrl: 'http://127.0.0.1:5500', version: CONFIG_VERSION, firebaseConfig: {} };
                if (savedStr) {
                    try {
                        const parsed = JSON.parse(savedStr);
                        if (!parsed.version || parsed.version < CONFIG_VERSION) return defaultConf;
                        if (!parsed.serverUrl) parsed.serverUrl = 'http://127.0.0.1:5500';
                        return parsed;
                    } catch(e) { return defaultConf; }
                }
                return defaultConf;
            });
            const [showLogin, setShowLogin] = useState(false);
            const [serverStatus, setServerStatus] = useState('checking');
            const [loading, setLoading] = useState(true);

            const addToast = (msg, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            };

            const fetchData = async () => {
                setLoading(true);
                try {
                    if (config.storageMode === 'server') {
                        const prods = await DataAdapter.getProducts(config);
                        const cats = await DataAdapter.getCategories(config); 
                        setProducts(prods);
                        setCategories(cats);
                        setServerStatus('online');
                    } else if (config.storageMode === 'firebase') {
                        const prods = await DataAdapter.getProducts(config);
                        const cats = await DataAdapter.getCategories(config);
                        setProducts(prods);
                        setCategories(cats);
                        setServerStatus('online'); 
                    } else {
                        setProducts(JSON.parse(localStorage.getItem('products')) || []);
                        setServerStatus('local');
                    }
                } catch (e) {
                    setServerStatus('offline');
                    if(config.storageMode === 'server' || config.storageMode === 'firebase') addToast("Errore Connessione", 'error');
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
                localStorage.setItem('config', JSON.stringify(config));
            }, [config.storageMode, config.serverUrl, config.firebaseConfig]); 

            // --- CATEGORY ACTIONS ---
            const addCategory = async (name) => {
                if(!name) return;
                try {
                    await DataAdapter.addCategory(config, name);
                    addToast("Categoria aggiunta");
                    fetchData(); 
                } catch(e) { addToast("Errore aggiunta", 'error'); }
            };

            const deleteCategory = async (id) => {
                 if(confirm("Eliminare categoria?")) {
                    try {
                        await DataAdapter.deleteCategory(config, id);
                        addToast("Categoria eliminata");
                        fetchData();
                    } catch(e) { addToast("Errore eliminazione", 'error'); }
                 }
            };

            // --- MIGRAZIONE ---
            const handleMigration = async () => {
                if(!confirm("Vuoi copiare tutti i prodotti locali su Firebase? (Potrebbe richiedere tempo)")) return;
                try {
                    const count = await DataAdapter.migrateLocalToCloud(config);
                    addToast(`Migrazione completata: ${count} prodotti!`);
                    fetchData(); // Ricarica da Firebase
                } catch(e) {
                    addToast("Errore Migrazione: " + e.message, 'error');
                }
            };

            const updateProduct = async (p) => { 
                try {
                    setProducts(prev => prev.map(pr => pr.code === p.code ? p : pr)); 
                    await DataAdapter.saveProduct(config, p); 
                    addToast("Aggiornato");
                } catch(e) { addToast("Errore", 'error'); }
            };

            const createProduct = async (p) => { 
                if (products.some(x => x.code === p.code)) return false; 
                const newProd = { 
                    ...p, 
                    stock: parseFloat(p.stock), 
                    price: parseFloat(p.price),
                    cost: parseFloat(p.cost),
                    category: p.category || "Generale"
                }; 
                try {
                    setProducts(prev => [...prev, newProd]); 
                    await DataAdapter.saveProduct(config, newProd); 
                    addToast("Creato");
                    return true; 
                } catch(e) { 
                    setProducts(prev => prev.filter(x => x.code !== newProd.code));
                    addToast("Errore creazione: " + e.message, 'error'); return false; 
                }
            };

            const deleteProduct = async (code) => { 
                if(confirm("Eliminare?")) { 
                    try {
                        setProducts(prev => prev.filter(p => p.code !== code)); 
                        await DataAdapter.deleteProduct(config, code); 
                        addToast("Eliminato");
                    } catch(e) { addToast("Errore", 'error'); }
                } 
            };

            const checkout = async () => { 
                if(cart.length === 0) return; 
                const newProds = products.map(p => { const c = cart.find(x => x.code === p.code); return c ? { ...p, stock: p.stock - c.qty } : p; }); 
                const total = cart.reduce((s, i) => s + (i.price * i.qty), 0); 
                const log = { id: Date.now(), date: new Date().toISOString(), total, items: cart, type: 'sale' }; 
                try {
                    setProducts(newProds); 
                    setLogs([log, ...logs]); 
                    if(config.storageMode === 'server' || config.storageMode === 'firebase') { 
                        for(let p of newProds) { if (cart.find(c => c.code === p.code)) await DataAdapter.saveProduct(config, p); }
                        await DataAdapter.saveLog(config, log); 
                    } else {
                        localStorage.setItem('products', JSON.stringify(newProds));
                        localStorage.setItem('logs', JSON.stringify([log, ...JSON.parse(localStorage.getItem('logs')||'[]')]));
                    }
                    setCart([]); 
                    addToast(`Vendita OK: €${total.toFixed(2)}`);
                    setRefreshDashboard(prev => prev + 1);
                } catch(e) { addToast("Errore vendita", 'error'); }
            };

            const addToCart = (code) => { const p = products.find(x => x.code === code); if (!p) return false; const exist = cart.find(x => x.code === code); if (exist) setCart(cart.map(x => x.code === code ? { ...x, qty: x.qty + 1 } : x)); else setCart([...cart, { ...p, qty: 1 }]); return true; };

            return (
                <>
                    <ToastContainer toasts={toasts} />
                    <div className="flex h-screen bg-[#f0f2f5] font-sans text-slate-800">
                        <div className="w-24 bg-[#0f172a] flex flex-col items-center py-8 gap-4 shadow-2xl z-20 shrink-0"><div className="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black text-xl mb-6 shadow-lg shadow-blue-900/50">MK</div><NavBtn icon="ShoppingCart" active={view === 'pos'} onClick={() => setView('pos')} label="Cassa" /><NavBtn icon="Box" active={view === 'inventory'} onClick={() => setView('inventory')} label="Prodotti" /><NavBtn icon="TrendingUp" active={view === 'dashboard'} onClick={() => setView('dashboard')} label="Report" /><div className="mt-auto"><NavBtn icon="Settings" active={view === 'settings'} onClick={() => setShowLogin(true)} label="Admin" color="text-slate-500" /></div></div>
                        <div className="flex-1 overflow-hidden flex flex-col relative">
                            <div className="bg-white h-16 border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-10"><h1 className="font-bold text-xl text-slate-800">{view === 'pos' ? 'Nuova Vendita' : view === 'inventory' ? 'Gestione Magazzino' : 'Pannello Controllo'}</h1><div className="flex items-center gap-2 text-xs font-medium"><div className={`w-2 h-2 rounded-full ${serverStatus === 'online' ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 'bg-red-500'}`}></div><button onClick={fetchData} className="text-slate-400 hover:text-blue-500 underline decoration-dotted">{serverStatus === 'online' ? 'ONLINE' : 'OFFLINE (Riprova)'}</button></div></div>
                            {loading ? <div className="flex-1 flex items-center justify-center text-slate-400">Caricamento...</div> : 
                            <div className="flex-1 overflow-hidden p-6">{view === 'pos' && <POSView products={products} cart={cart} setCart={setCart} onAddToCart={addToCart} onCheckout={checkout} config={config} />}{view === 'inventory' && <InventoryView products={products} onUpdate={updateProduct} onCreate={createProduct} onDelete={deleteProduct} refresh={fetchData} categories={categories} addCat={addCategory} delCat={deleteCategory} />}{view === 'settings' && <SettingsView config={config} setConfig={setConfig} serverStatus={serverStatus} categories={categories} addCat={addCategory} delCat={deleteCategory} onMigrate={handleMigration} />}{view === 'dashboard' && <DashboardView config={config} refreshTrigger={refreshDashboard} />}</div>}
                        </div>
                        {showLogin && <LoginModal password={config.adminPass} onSuccess={() => { setShowLogin(false); setView('settings'); }} onClose={() => setShowLogin(false)} />}
                    </div>
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>